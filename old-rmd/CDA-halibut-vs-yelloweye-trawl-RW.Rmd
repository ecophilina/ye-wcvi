---
title: "Estimating relative biomass of Pacific Halibut and Yelloweye Rockfish off west coast of Vancouver Island"
author: "Philina English"
date: "`r Sys.Date()`"
output: html_document
---

```{r message = F}
library(sf)
library(dplyr)
library(ggplot2)
library(tidyr)
# remotes::install_github("pbs-assess/sdmTMB", ref = "pc-prior") # for faster models
library(sdmTMB)
# Do we need instructions for installing other dependencies like "pbsmapping"?
# devtools::install_github("seananderson/ggsidekick")
library(ggsidekick) # for fourth_root_power_trans and theme_sleek
theme_set(ggsidekick::theme_sleek())
dir.create("data", showWarnings = FALSE)
dir.create("data-generated", showWarnings = FALSE)
dir.create("models", showWarnings = FALSE)
```

# Retrieve all survey data 
Must be on network.

```{r eval=F}
halsetdata <- gfdata::get_survey_sets("Pacific Halibut")
saveRDS(halsetdata, "data/halibut-surv-sets-all.rds")

yesetdata <- gfdata::get_survey_sets("Yelloweye Rockfish")
saveRDS(yesetdata, "data/yelloweye-surv-sets-all.rds")

# get detailed biological data, I have retrieved data from all surveys in case comparisons between surveys are needed later
yesampledata <- gfdata::get_survey_samples("Yelloweye Rockfish")
saveRDS(yesampledata, "data/yelloweye-surv-samples-all.rds")

halsampledata <- gfdata::get_survey_samples("Pacific Halibut")
saveRDS(halsampledata, "data/halibut-surv-samples-all.rds")

# I also copied ####_grid.rda from gfplot into "data" folder
# and will need a folder called "shape-files" containing "taaqwiihak_areaVer2.shp"
# download gshhg-shp-2.3.7 from https://www.ngdc.noaa.gov/mgg/shorelines/data/gshhg/latest/ add place in data folder
```


# Stitch together trawl and HBLL survey data

Load custom functions including one that takes all the set data and hook data retrieved for each species and produces a dataframe for use in sdmTMB model. 

These models will be of estimated biomass density, so HBLL catch counts are converted to biomass using the mean weight of all fish sampled on the trawl surveys. 
The HBLL biomass estimate is further divided by the "area swept" calculation I found in a hook competition script (total_hooks * 0.0024384 * 0.009144 * 1000) except that I am using density estimates in kg/ha from the trawl instead of kg/km2, so I am multiplying by 10000 instead of 1000. 
This results in similar, but not identical, value ranges for both surveys, as would be expected given the different habitats they sample. 


```{r echo=F}
# load misc custom functions
source("functions.R")
```

```{r message=F}
model_data_prep <- function(trawldata, hblldata, mean_weight) {
  d <- hblldata

  d <- d %>%
    mutate(
      year_pair = case_when(
        year %in% c(2007, 2008) ~ 2008,
        year %in% c(2009, 2010) ~ 2010,
        year %in% c(2011, 2012) ~ 2012,
        year %in% c(2013, 2014) ~ 2014, 
        year %in% c(2015, 2016) ~ 2016,
        year %in% c(2017, 2018) ~ 2018,
        year %in% c(2019, 2020) ~ 2020  # no WCVI
      ),
      year_true = year,
      density = catch_count * mean_weight / (hook_count * 0.0024384 * 0.009144 * 10000) 
      # hook spacing = 0.0024384 km
      # assumed catch radius = 0.009144 km
      # this area swept calc was for km2, so * 10000 gives it in hectares
    ) %>%
    select(
      survey_abbrev, year_pair, year_true, 
      longitude, latitude, fishing_event_id, depth_m, density,
      catch_count, hook_count
    ) %>%
    mutate(lon = longitude, lat = latitude) %>%
    mutate(survey = "HBLL")

  dt <- trawldata %>%
    mutate(
      year_pair = case_when(
        year %in% c(2007, 2008) ~ 2008,
        year %in% c(2009, 2010) ~ 2010,
        year %in% c(2011, 2012) ~ 2012,
        year %in% c(2013, 2014) ~ 2014,
        year %in% c(2015, 2016) ~ 2016,
        year %in% c(2017, 2018) ~ 2018,
        year %in% c(2019, 2020) ~ 2020
      ),
      year_true = year,
      density = density_kgpm2 * 10000 # making density of trawl kg per hectare
    ) %>%
    select(
      survey_abbrev, year_pair, year_true,
      longitude, latitude, fishing_event_id, depth_m, density
    ) %>%
    mutate(lon = longitude, lat = latitude) %>%
    mutate(survey = "TRAWL")

  d <- bind_rows(d, dt) %>% 
    filter(depth_m > 1)

  # convert to utms for sdmTMB model
  d_utm <- convert2utm(d, coords = c("lon", "lat"))

  d_utm$depth_log <- log(d_utm$depth_m)
  d_utm$depth_centred <- d_utm$depth_log - mean(d_utm$depth_log)
  d_utm$depth_mean <- mean(d_utm$depth_log)
  d_utm$depth_sd <- sd(d_utm$depth_centred)
  d_utm$depth_scaled <- d_utm$depth_centred / sd(d_utm$depth_centred)
  d_utm$Y_cent <- d_utm$Y - mean(d_utm$Y)
  d_utm$X_cent <- d_utm$X - mean(d_utm$X)

  d_utm
}
```

For this conversion which mean weight should we use?

```{r}
# calculate mean weight for all of SYN WCVI
print("Mean Halibut weight from trawl")
halsampledata <- readRDS("data/halibut-surv-samples-all.rds") %>% filter(survey_abbrev == c("SYN WCVI", "SYN QCS"))
# halmeanlength <- mean(halsampledata$length, na.rm = T) # 74 cm seems reasonable
halmeanweightSYN <- mean(halsampledata$weight / 1000, na.rm = T)
round(halmeanweightSYN, 2)

print("Mean Halibut weight from Adam")
halmeanweight <- 9.5 # 21 lbs = 9.52 kg 
halmeanweight

print("Mean Yelloweye weight from trawl")
yesampledataSYN <- readRDS("data/yelloweye-surv-samples-all.rds") %>% filter(survey_abbrev == c("SYN WCVI", "SYN QCS"))
yemeanweightSYN <- mean(yesampledataSYN$weight / 1000, na.rm = T)
round(yemeanweightSYN, 2)

print("Mean Yelloweye weight from HBLL")
yesampledata <- readRDS("data/yelloweye-surv-samples-all.rds") %>% filter(survey_abbrev == c("HBLL OUT S"))
yemeanweightHBLL <- mean(yesampledata$weight / 1000, na.rm = T)
round(yemeanweightHBLL, 2)

print("Mean Yelloweye weight from Adam")
yemeanweight <- 3.2 # 7 lbs =3.18 kg  
yemeanweight
```

Prep data using one of these (currently using trawl means for both species)

```{r}
# currently using trawl means for both species, but may want to update that to Adam's suggestion... 
halmeanweight <- halmeanweightSYN 
yemeanweight <- yemeanweightSYN 

# prep halibut
haltrawldata <- readRDS("data/halibut-surv-sets-all.rds") %>% filter(survey_abbrev %in% c("SYN WCVI", "SYN QCS"))
halhblldata <- readRDS("data/halibut-surv-sets-all.rds") %>% filter(survey_abbrev == "HBLL OUT S")

d_hal <- model_data_prep(haltrawldata, halhblldata, mean_weight = halmeanweight) %>%
    mutate(year = year_pair)
    # mutate(year = year_true)
saveRDS(d_hal, "data-generated/halibut-hybrid-model-data-paired.rds")

# prep yelloweye
yetrawldata <- readRDS("data/yelloweye-surv-sets-all.rds") %>% filter(survey_abbrev %in% c("SYN WCVI", "SYN QCS"))
yehblldata <- readRDS("data/yelloweye-surv-sets-all.rds") %>% filter(survey_abbrev == "HBLL OUT S")

d_ye <- model_data_prep(yetrawldata, yehblldata, mean_weight = yemeanweight)%>%
    mutate(year = year_pair)
    # mutate(year = year_true)
saveRDS(d_ye, "data-generated/yelloweye-hybrid-model-data-paired.rds")

# yr <- d_ye %>% filter(year > 2006)
years <- sort(unique(d_ye$year))
```

# Make prediction grid
First chunk should only need running once, unless changes to overall prediction area are desired.
```{r eval = F, message=F}
# shouldn't matter which species this is based on since the offsets are currently the same for both

## trim trawl data to hbll_s_grid area
hbll_s_grid <- readRDS(here::here("grids/hbll_s_grid.rds"))
# max(hbll_s_grid$grid$Y)
# hbll_sf <- st_as_sf(hbll_s_grid$grid, coords = c("longitude", "latitude"), crs = 4326)
# plot(st_geometry(hbll_sf))

# s_grid_utm <- convert2utm(hbll_s_grid$grid, coords = c("X", "Y")) %>%
s_grid_utm <- hbll_s_grid$grid %>% select(-x, -y, -old_lat, -old_lon) %>%
  mutate(X = round(X * 100), Y = round(Y * 100)) %>%
  mutate(X = (X / 100), Y = (Y / 100)) # %>% rename(depth_m = depth)

# s_grid_utm$longitude <- hbll_s_grid$grid$X
# s_grid_utm$latitude <- hbll_s_grid$grid$Y
s_grid_utm$survey <- "HBLL"
min(s_grid_utm$X)
max(s_grid_utm$X)

# grid <- readRDS("grids/overall-grid.rds") %>% mutate(X = X/100, Y = Y/100)
load("grids/synoptic_grid.rda")
grid <- synoptic_grid %>%
  mutate(X = round(X), Y = round(Y),
    X = X / 100, Y = Y / 100,
    depth_m = depth
  ) %>%
  select(X, Y, depth_m#, survey2 = survey
    ) %>%
  filter(
    X > min(s_grid_utm$X) & X < max(s_grid_utm$X) &
      Y > min(s_grid_utm$Y) & Y < max(s_grid_utm$Y)
  )

min(grid$X)
max(grid$X)

grid_utm <- full_join(grid, s_grid_utm, by = c("X", "Y")) %>%
  mutate(depth = ifelse(is.na(depth_m), depth, depth_m), 
    survey = ifelse(is.na(survey), "TRAWL" #survey2
      , survey)) %>%
  select(-depth_m, #-survey2, 
    -latitude, -longitude)

grid_xy <- grid_utm %>%
  select(X, Y) %>%
  mutate(X = X * 100, Y = Y * 100)
grid_ll <- utm2ll(grid_xy) %>% rename(longitude = X, latitude = Y)

grid_utm <- bind_cols(grid_utm, grid_ll)

grid_sf <- st_as_sf(grid_utm, coords = c("longitude", "latitude"))
st_crs(grid_sf) <- 4326 # set the coordinate reference system
grid <- sfc_as_cols(grid_sf, c("longitude", "latitude"))
st_geometry(grid) <- NULL

saveRDS(grid, file = "data-generated/hybrid_grid.rds") 
```

Scale covariates for models
```{r}
if(!file.exists("data-generated/full_hybrid_grid_w_rocky.rds")) {
  stop("Need to run get-substrate.R script.")
} else {
grid <- readRDS(file = "data-generated/full_hybrid_grid_w_substrate.rds")

grid <- grid[complete.cases(grid), ]

substrate <- readRDS(file = "data-generated/events_w_substrate_1km_buffer.rds") %>%
# substrate <- readRDS(file = "data-generated/events_w_substrate_500m_buffer.rds") %>% # very sligthly worse for both species
  select(X, Y, fishing_event_id, any_rock, rocky, mixed, muddy)
}


d_utm <- readRDS("data-generated/yelloweye-hybrid-model-data-paired.rds") %>% 
  filter(latitude < 52.15507) %>%
  filter(year %in% years) %>% left_join(substrate) # looks like no missing data to worry about

if(sum(is.na(d_utm$any_rock))) { stop("Check for missing substrate data before running models.")}

grid_utm <- expand_prediction_grid(grid, years = years) %>%
  # mutate(any_rock_scaled = (any_rock - mean(substrate$any_rock)/ sd(substrate$any_rock)) %>%
  mutate(depth_centred = log(depth) - mean(d_utm$depth_log)) %>%
  mutate(depth_scaled = depth_centred / sd(d_utm$depth_centred)) 

grid_utm$source_data <- grid_utm$survey

## if we want to predict for HBLL catch rates across full grid
## this will change the saved grids so if wanting to revert, make sure to run all the way through
grid_utm$survey <- "HBLL"
```


```{r}
# make map of grid areas and their overlap
f <- "figs/map-stitched-grid-overlap.png"

if (!file.exists(f)) {
coast_gshhg_proj <- readRDS("data-generated/coast_gshhg.rds")

focal_area <- sf::st_read(dsn = "shape-files/taaqwiihak_areaVer2.shp",
    layer = "taaqwiihak_areaVer2", quiet = TRUE)
focal_area_proj <- sf::st_transform(focal_area, crs = 3156)

library(PBSmapping) # needs this for some reason
  majorbound <- load_boundaries(9)
  # attributes(majorbound)$PolyData
  # 5AB
  bound5Bnorth <- fortify(majorbound) %>%
    filter(PID %in% c(6)) %>%
    filter( # POS != 46 & # strange jog over HG
      X > 200 & X < 560 & Y > 5700
    )
  bound5Anorth <- fortify(majorbound) %>%
    filter(PID %in% c(5)) %>%
    filter(
      X > 200 & X < 600 & Y > 5650
    )
  # 3CD
  bound3Cnorth <- fortify(majorbound) %>%
    filter(PID %in% c(3)) %>%
    filter(X > 200 & X < 725 & Y > 5400) #%>%
  # gfplot:::utm2ll(utm_zone = 9)
  bound3Dnorth <- fortify(majorbound) %>%
    filter(PID %in% c(4)) %>%
    filter(X > 200 & X < 600 & Y > 5550)

  
hbll_s_grid <- readRDS(here::here("grids/hbll_s_grid.rds"))

hbll_sf <- st_as_sf(hbll_s_grid$grid, coords = c("longitude", "latitude"), crs = 4326)
hbll_sf <- st_transform(hbll_sf, crs = 3156)
hbll_sf$source_data <- "HBLL"
hbll_sf_grid <- sf::st_make_grid(x = hbll_sf,
  offset = st_bbox(hbll_sf)[c("xmin", "ymin")]+ c(-1000, -1000),
  cellsize=c(2000, 2000))

keep <- st_intersects(hbll_sf, hbll_sf_grid)
hbll_sf_grid <- hbll_sf_grid[unlist(keep)]
hbll_sf2 <- st_as_sf(hbll_sf_grid)
hbll_sf2$source_data <- "HBLL"


load("grids/synoptic_grid.rda")
trawl <- synoptic_grid %>%
  mutate(X = round(X), Y = round(Y),
    X = X*1000, Y = Y*1000,
    source_data = "TRAWL"
  ) 
trawl_sf <- st_as_sf(trawl, coords = c("X", "Y"), crs = 3156)
trawl_sf_grid <- sf::st_make_grid(x = trawl_sf,
  offset = st_bbox(trawl_sf)[c("xmin", "ymin")]+ c(-1000, -1000),
  cellsize=c(2000, 2000))

keep <- st_intersects(trawl_sf, trawl_sf_grid)
trawl_sf_grid <- trawl_sf_grid[unlist(keep)]
trawl_sf2 <- st_as_sf(trawl_sf_grid)
trawl_sf2$source_data <- "TRAWL"

g <- ggplot(focal_area_proj) +
  # geom_tile(data=grid_utm,  aes(X* 100000, Y* 100000, fill = source_data), 
  #   alpha = 0.75, width = 2000, height = 2000) +
  geom_sf(data=trawl_sf2,  aes(fill = source_data), colour = NA,
    alpha = 0.9) +
  geom_sf(data=hbll_sf2,  aes(fill = source_data), colour = NA,
    alpha = 0.8) +
   geom_line( # add major management region boundaries
      data = bound3Cnorth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
    geom_line( # add major management region boundaries
      data = bound3Dnorth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
    geom_line( # add major management region boundaries
      data = bound5Anorth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
    geom_sf(colour = "red", fill = NA, size = 0.70) + # add focal area behind coast
    geom_sf(data = coast_gshhg_proj, size = 0.07, fill = "grey75", col = "grey55") +
    annotate("text",
      x = convert2utm9(-129.8, 50.7)[1],
      y = convert2utm9(-129.8, 50.7)[2], label = "5A") +
    annotate("text",
      x = convert2utm9(-129.8, 50.3)[1],
      y = convert2utm9(-129.8, 50.3)[2],
      label = "3D") +
    annotate("text",
      x = convert2utm9(-129.8, 48.8)[1],
      y = convert2utm9(-129.8, 48.8)[2],
      label = "3C") +
  scale_fill_viridis_d(name = "Survey", begin = 0.2, end = 0.5, direction = -1) +
  geom_sf(colour = "red", fill = NA, size = 0.70) + # add focal area behind coast
  geom_sf(data = coast_gshhg_proj, size = 0.07, fill = "grey99", col = "grey55") +
  coord_sf(
      xlim = c(230957.7 + 205000, 1157991 - 385000),
      ylim = c(5366427 + 25000, 6353456 - 590000)
    ) +
  ggsidekick::theme_sleek() + theme(
      legend.key = element_rect(colour = NA, fill = "grey75"),
      axis.title = element_blank(),
      legend.box.background = element_rect(color = NA, size = 1, fill = "#ffffff90"),
      legend.position = c(0.99, 0.99),
      legend.justification = c(1, 1),
      panel.background = element_rect(color = NA, size = 1, fill = "grey75")) 

ggsave("figs/map-stitched-grid-overlap.png", width = 5.5, height = 5.5, dpi = 400)
}
```



```{r}
# make map of rocky
f <- "figs/map-grid-rocky.png"

if (!file.exists(f)) {
coast_gshhg_proj <- readRDS("data-generated/coast_gshhg.rds")

focal_area <- sf::st_read(dsn = "shape-files/taaqwiihak_areaVer2.shp",
    layer = "taaqwiihak_areaVer2", quiet = TRUE)
focal_area_proj <- sf::st_transform(focal_area, crs = 3156)

library(PBSmapping) # needs this for some reason
  majorbound <- load_boundaries(9)
  # attributes(majorbound)$PolyData
  # 5AB
  bound5Bnorth <- fortify(majorbound) %>%
    filter(PID %in% c(6)) %>%
    filter( # POS != 46 & # strange jog over HG
      X > 200 & X < 560 & Y > 5700
    )
  bound5Anorth <- fortify(majorbound) %>%
    filter(PID %in% c(5)) %>%
    filter(
      X > 200 & X < 600 & Y > 5650
    )
  # 3CD
  bound3Cnorth <- fortify(majorbound) %>%
    filter(PID %in% c(3)) %>%
    filter(X > 200 & X < 725 & Y > 5400) #%>%
  # gfplot:::utm2ll(utm_zone = 9)
  bound3Dnorth <- fortify(majorbound) %>%
    filter(PID %in% c(4)) %>%
    filter(X > 200 & X < 600 & Y > 5550)

  
hbll_s_grid <- readRDS(here::here("grids/hbll_s_grid.rds"))

hbll_sf <- st_as_sf(hbll_s_grid$grid, coords = c("longitude", "latitude"), crs = 4326)
hbll_sf <- st_transform(hbll_sf, crs = 3156)
hbll_sf$source_data <- "HBLL"
hbll_sf_grid <- sf::st_make_grid(x = hbll_sf,
  offset = st_bbox(hbll_sf)[c("xmin", "ymin")]+ c(-1000, -1000),
  cellsize=c(2000, 2000))

keep <- st_intersects(hbll_sf, hbll_sf_grid)
hbll_sf_grid <- hbll_sf_grid[unlist(keep)]
hbll_sf2 <- st_as_sf(hbll_sf_grid)
hbll_sf2$source_data <- "HBLL"


load("grids/synoptic_grid.rda")
trawl <- synoptic_grid %>%
  mutate(X = round(X), Y = round(Y),
    X = X*1000, Y = Y*1000,
    source_data = "TRAWL"
  ) 
trawl_sf <- st_as_sf(trawl, coords = c("X", "Y"), crs = 3156)
trawl_sf_grid <- sf::st_make_grid(x = trawl_sf,
  offset = st_bbox(trawl_sf)[c("xmin", "ymin")]+ c(-1000, -1000),
  cellsize=c(2000, 2000))

keep <- st_intersects(trawl_sf, trawl_sf_grid)
trawl_sf_grid <- trawl_sf_grid[unlist(keep)]
trawl_sf2 <- st_as_sf(trawl_sf_grid)
trawl_sf2$source_data <- "TRAWL"

g <- ggplot(focal_area_proj) +
  geom_tile(data=grid_utm,  aes(X* 100000, Y* 100000, fill = rocky),
    alpha = 0.75, width = 2000, height = 2000) +
  # geom_sf(data=trawl_sf2,  aes(fill = source_data), colour = NA,
  #   alpha = 0.9) +
  # geom_sf(data=hbll_sf2,  aes(fill = source_data), colour = NA,
  #   alpha = 0.8) +
   geom_line( # add major management region boundaries
      data = bound3Cnorth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
    geom_line( # add major management region boundaries
      data = bound3Dnorth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
    geom_line( # add major management region boundaries
      data = bound5Anorth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
    geom_sf(colour = "red", fill = NA, size = 0.70) + # add focal area behind coast
    geom_sf(data = coast_gshhg_proj, size = 0.07, fill = "grey75", col = "grey55") +
    annotate("text",
      x = convert2utm9(-129.8, 50.7)[1],
      y = convert2utm9(-129.8, 50.7)[2], label = "5A") +
    annotate("text",
      x = convert2utm9(-129.8, 50.3)[1],
      y = convert2utm9(-129.8, 50.3)[2],
      label = "3D") +
    annotate("text",
      x = convert2utm9(-129.8, 48.8)[1],
      y = convert2utm9(-129.8, 48.8)[2],
      label = "3C") +
  scale_fill_viridis_c(name = "Rocky\nProportion", 
    trans = ggsidekick:::fourth_root_power_trans(),#"sqrt"
    breaks = c(0.01, 0.1, 0.50, 1.00)
    #begin = 0.2, end = 0.5, direction = -1
    ) +
  geom_sf(colour = "red", fill = NA, size = 0.70) + # add focal area behind coast
  geom_sf(data = coast_gshhg_proj, size = 0.07, fill = "grey99", col = "grey55") +
  coord_sf(
      xlim = c(230957.7 + 205000, 1157991 - 385000),
      ylim = c(5366427 + 25000, 6353456 - 590000)
    ) +
  ggsidekick::theme_sleek() + theme(
      legend.key = element_rect(colour = NA, fill = "grey75"),
      axis.title = element_blank(),
      legend.box.background = element_rect(color = NA, size = 1, fill = "#ffffff90"),
      legend.position = c(0.99, 0.99),
      legend.justification = c(1, 1),
      panel.background = element_rect(color = NA, size = 1, fill = "grey75")) 

ggsave("figs/map-grid-rocky.png", width = 5.5, height = 5.5, dpi = 400)
}
```


```{r}
# make map of muddy
f <- "figs/map-grid-muddy.png"

if (!file.exists(f)) {
coast_gshhg_proj <- readRDS("data-generated/coast_gshhg.rds")

focal_area <- sf::st_read(dsn = "shape-files/taaqwiihak_areaVer2.shp",
    layer = "taaqwiihak_areaVer2", quiet = TRUE)
focal_area_proj <- sf::st_transform(focal_area, crs = 3156)

library(PBSmapping) # needs this for some reason
  majorbound <- load_boundaries(9)
  # attributes(majorbound)$PolyData
  # 5AB
  bound5Bnorth <- fortify(majorbound) %>%
    filter(PID %in% c(6)) %>%
    filter( # POS != 46 & # strange jog over HG
      X > 200 & X < 560 & Y > 5700
    )
  bound5Anorth <- fortify(majorbound) %>%
    filter(PID %in% c(5)) %>%
    filter(
      X > 200 & X < 600 & Y > 5650
    )
  # 3CD
  bound3Cnorth <- fortify(majorbound) %>%
    filter(PID %in% c(3)) %>%
    filter(X > 200 & X < 725 & Y > 5400) #%>%
  # gfplot:::utm2ll(utm_zone = 9)
  bound3Dnorth <- fortify(majorbound) %>%
    filter(PID %in% c(4)) %>%
    filter(X > 200 & X < 600 & Y > 5550)

  
hbll_s_grid <- readRDS(here::here("grids/hbll_s_grid.rds"))

hbll_sf <- st_as_sf(hbll_s_grid$grid, coords = c("longitude", "latitude"), crs = 4326)
hbll_sf <- st_transform(hbll_sf, crs = 3156)
hbll_sf$source_data <- "HBLL"
hbll_sf_grid <- sf::st_make_grid(x = hbll_sf,
  offset = st_bbox(hbll_sf)[c("xmin", "ymin")]+ c(-1000, -1000),
  cellsize=c(2000, 2000))

keep <- st_intersects(hbll_sf, hbll_sf_grid)
hbll_sf_grid <- hbll_sf_grid[unlist(keep)]
hbll_sf2 <- st_as_sf(hbll_sf_grid)
hbll_sf2$source_data <- "HBLL"


load("grids/synoptic_grid.rda")
trawl <- synoptic_grid %>%
  mutate(X = round(X), Y = round(Y),
    X = X*1000, Y = Y*1000,
    source_data = "TRAWL"
  ) 
trawl_sf <- st_as_sf(trawl, coords = c("X", "Y"), crs = 3156)
trawl_sf_grid <- sf::st_make_grid(x = trawl_sf,
  offset = st_bbox(trawl_sf)[c("xmin", "ymin")]+ c(-1000, -1000),
  cellsize=c(2000, 2000))

keep <- st_intersects(trawl_sf, trawl_sf_grid)
trawl_sf_grid <- trawl_sf_grid[unlist(keep)]
trawl_sf2 <- st_as_sf(trawl_sf_grid)
trawl_sf2$source_data <- "TRAWL"

g <- ggplot(focal_area_proj) +
  geom_tile(data=grid_utm,  aes(X* 100000, Y* 100000, fill = muddy),
    alpha = 0.75, width = 2000, height = 2000) +
  # geom_sf(data=trawl_sf2,  aes(fill = source_data), colour = NA,
  #   alpha = 0.9) +
  # geom_sf(data=hbll_sf2,  aes(fill = source_data), colour = NA,
  #   alpha = 0.8) +
   geom_line( # add major management region boundaries
      data = bound3Cnorth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
    geom_line( # add major management region boundaries
      data = bound3Dnorth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
    geom_line( # add major management region boundaries
      data = bound5Anorth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
    geom_sf(colour = "red", fill = NA, size = 0.70) + # add focal area behind coast
    geom_sf(data = coast_gshhg_proj, size = 0.07, fill = "grey75", col = "grey55") +
    annotate("text",
      x = convert2utm9(-129.8, 50.7)[1],
      y = convert2utm9(-129.8, 50.7)[2], label = "5A") +
    annotate("text",
      x = convert2utm9(-129.8, 50.3)[1],
      y = convert2utm9(-129.8, 50.3)[2],
      label = "3D") +
    annotate("text",
      x = convert2utm9(-129.8, 48.8)[1],
      y = convert2utm9(-129.8, 48.8)[2],
      label = "3C") +
  scale_fill_viridis_c(name = "Muddy\nProportion",     
    trans = ggsidekick:::fourth_root_power_trans(),#"sqrt"
    breaks = c(0.01, 0.1, 0.50, 1.00)
    #begin = 0.2, end = 0.5, direction = -1
    ) +
  geom_sf(colour = "red", fill = NA, size = 0.70) + # add focal area behind coast
  geom_sf(data = coast_gshhg_proj, size = 0.07, fill = "grey99", col = "grey55") +
  coord_sf(
      xlim = c(230957.7 + 205000, 1157991 - 385000),
      ylim = c(5366427 + 25000, 6353456 - 590000)
    ) +
  ggsidekick::theme_sleek() + theme(
      legend.key = element_rect(colour = NA, fill = "grey75"),
      axis.title = element_blank(),
      legend.box.background = element_rect(color = NA, size = 1, fill = "#ffffff90"),
      legend.position = c(0.99, 0.99),
      legend.justification = c(1, 1),
      panel.background = element_rect(color = NA, size = 1, fill = "grey75")) 

ggsave("figs/map-grid-muddy.png", width = 5.5, height = 5.5, dpi = 400)
}
```


```{r}
# make map of muddy
f <- "figs/map-grid-mixed.png"

if (!file.exists(f)) {
coast_gshhg_proj <- readRDS("data-generated/coast_gshhg.rds")

focal_area <- sf::st_read(dsn = "shape-files/taaqwiihak_areaVer2.shp",
    layer = "taaqwiihak_areaVer2", quiet = TRUE)
focal_area_proj <- sf::st_transform(focal_area, crs = 3156)

library(PBSmapping) # needs this for some reason
  majorbound <- load_boundaries(9)
  # attributes(majorbound)$PolyData
  # 5AB
  bound5Bnorth <- fortify(majorbound) %>%
    filter(PID %in% c(6)) %>%
    filter( # POS != 46 & # strange jog over HG
      X > 200 & X < 560 & Y > 5700
    )
  bound5Anorth <- fortify(majorbound) %>%
    filter(PID %in% c(5)) %>%
    filter(
      X > 200 & X < 600 & Y > 5650
    )
  # 3CD
  bound3Cnorth <- fortify(majorbound) %>%
    filter(PID %in% c(3)) %>%
    filter(X > 200 & X < 725 & Y > 5400) #%>%
  # gfplot:::utm2ll(utm_zone = 9)
  bound3Dnorth <- fortify(majorbound) %>%
    filter(PID %in% c(4)) %>%
    filter(X > 200 & X < 600 & Y > 5550)

  
hbll_s_grid <- readRDS(here::here("grids/hbll_s_grid.rds"))

hbll_sf <- st_as_sf(hbll_s_grid$grid, coords = c("longitude", "latitude"), crs = 4326)
hbll_sf <- st_transform(hbll_sf, crs = 3156)
hbll_sf$source_data <- "HBLL"
hbll_sf_grid <- sf::st_make_grid(x = hbll_sf,
  offset = st_bbox(hbll_sf)[c("xmin", "ymin")]+ c(-1000, -1000),
  cellsize=c(2000, 2000))

keep <- st_intersects(hbll_sf, hbll_sf_grid)
hbll_sf_grid <- hbll_sf_grid[unlist(keep)]
hbll_sf2 <- st_as_sf(hbll_sf_grid)
hbll_sf2$source_data <- "HBLL"


load("grids/synoptic_grid.rda")
trawl <- synoptic_grid %>%
  mutate(X = round(X), Y = round(Y),
    X = X*1000, Y = Y*1000,
    source_data = "TRAWL"
  ) 
trawl_sf <- st_as_sf(trawl, coords = c("X", "Y"), crs = 3156)
trawl_sf_grid <- sf::st_make_grid(x = trawl_sf,
  offset = st_bbox(trawl_sf)[c("xmin", "ymin")]+ c(-1000, -1000),
  cellsize=c(2000, 2000))

keep <- st_intersects(trawl_sf, trawl_sf_grid)
trawl_sf_grid <- trawl_sf_grid[unlist(keep)]
trawl_sf2 <- st_as_sf(trawl_sf_grid)
trawl_sf2$source_data <- "TRAWL"

g <- ggplot(focal_area_proj) +
  geom_tile(data=grid_utm,  aes(X* 100000, Y* 100000, fill = mixed),
    alpha = 0.75, width = 2000, height = 2000) +
  # geom_sf(data=trawl_sf2,  aes(fill = source_data), colour = NA,
  #   alpha = 0.9) +
  # geom_sf(data=hbll_sf2,  aes(fill = source_data), colour = NA,
  #   alpha = 0.8) +
   geom_line( # add major management region boundaries
      data = bound3Cnorth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
    geom_line( # add major management region boundaries
      data = bound3Dnorth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
    geom_line( # add major management region boundaries
      data = bound5Anorth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
    geom_sf(colour = "red", fill = NA, size = 0.70) + # add focal area behind coast
    geom_sf(data = coast_gshhg_proj, size = 0.07, fill = "grey75", col = "grey55") +
    annotate("text",
      x = convert2utm9(-129.8, 50.7)[1],
      y = convert2utm9(-129.8, 50.7)[2], label = "5A") +
    annotate("text",
      x = convert2utm9(-129.8, 50.3)[1],
      y = convert2utm9(-129.8, 50.3)[2],
      label = "3D") +
    annotate("text",
      x = convert2utm9(-129.8, 48.8)[1],
      y = convert2utm9(-129.8, 48.8)[2],
      label = "3C") +
  scale_fill_viridis_c(name = "Mixed\nProportion",     
    trans = ggsidekick:::fourth_root_power_trans(),#"sqrt"
    breaks = c(0.01, 0.1, 0.50, 1.00)
    #begin = 0.2, end = 0.5, direction = -1
    ) +
  geom_sf(colour = "red", fill = NA, size = 0.70) + # add focal area behind coast
  geom_sf(data = coast_gshhg_proj, size = 0.07, fill = "grey99", col = "grey55") +
  coord_sf(
      xlim = c(230957.7 + 205000, 1157991 - 385000),
      ylim = c(5366427 + 25000, 6353456 - 590000)
    ) +
  ggsidekick::theme_sleek() + theme(
      legend.key = element_rect(colour = NA, fill = "grey75"),
      axis.title = element_blank(),
      legend.box.background = element_rect(color = NA, size = 1, fill = "#ffffff90"),
      legend.position = c(0.99, 0.99),
      legend.justification = c(1, 1),
      panel.background = element_rect(color = NA, size = 1, fill = "grey75")) 

ggsave("figs/map-grid-mixed.png", width = 5.5, height = 5.5, dpi = 400)
}
```

Trim prediction grid to cover full outside S HBLL

```{r}
full_s_grid_utm <- grid_utm
full_s_grid_sf <- st_as_sf(full_s_grid_utm, coords = c("longitude", "latitude"))
st_crs(full_s_grid_sf) <- 4326 # set the coordinate reference system
full_s_grid <- sfc_as_cols(full_s_grid_sf, c("longitude", "latitude"))
st_geometry(full_s_grid) <- NULL

saveRDS(full_s_grid, file = "data-generated/full_hybrid_grid_paired.rds")
```

Trim prediction grid for just area 5A

```{r}
s_5A_grid_utm <- filter(grid_utm, latitude < 51.24999 & latitude > 50.5) # trims grid to be just area 5A
s_5A_grid_sf <- st_as_sf(s_5A_grid_utm, coords = c("longitude", "latitude"))
st_crs(s_5A_grid_sf) <- 4326 # set the coordinate reference system
s_5A_grid <- sfc_as_cols(s_5A_grid_sf, c("longitude", "latitude"))
st_geometry(s_5A_grid) <- NULL

saveRDS(s_5A_grid, file = "data-generated/hybrid_5A_grid_paired.rds")
```

Split area 3CD into areas inside and outside court defined area (CDA)

```{r message= F}
s_3CD_grid_utm <- filter(grid_utm, latitude < 50.5) # trims grid to be just area 3CD
s_3CD_grid_sf <- st_as_sf(s_3CD_grid_utm, coords = c("longitude", "latitude"))
st_crs(s_3CD_grid_sf) <- 4326 # set the coordinate reference system
# s_grid_sf

focal_area <- sf::st_read(dsn = "shape-files/taaqwiihak_areaVer2.shp", layer = "taaqwiihak_areaVer2")
focal_area <- sf::st_transform(focal_area, crs = 4326)

intersected <- sf::st_intersects(s_3CD_grid_sf, focal_area)

cda_grid_sf <- s_3CD_grid_sf[which(lengths(intersected) > 0), ]
noncda_grid_sf <- s_3CD_grid_sf[which(lengths(intersected) == 0), ]

cda_grid <- sfc_as_cols(cda_grid_sf, c("longitude", "latitude"))
noncda_grid <- sfc_as_cols(noncda_grid_sf, c("longitude", "latitude"))
st_geometry(cda_grid) <- NULL
st_geometry(noncda_grid) <- NULL
saveRDS(cda_grid, file = "data-generated/hybrid_cda_grid_paired.rds")
saveRDS(noncda_grid, file = "data-generated/hybrid_noncda_grid_paired.rds")
```

# Make relatively finescale mesh

```{r }
# again the same grid should work for both species because the sets are identical in both
mesh400kn <- make_mesh(d_utm, c("X", "Y"), n_knots = 400)
plot(mesh400kn)
```

# Pacific Halibut model 

```{r eval = TRUE}
d_hal <- readRDS("data-generated/halibut-hybrid-model-data-paired.rds") %>%
  filter(latitude < 52.15507) %>%
  filter(year %in% years) %>% left_join(substrate)
f <- paste0("models/halibut-hybrid-model-new-RW-w-rocky-muddy-400kn.rds")
if (!file.exists(f)) {
  m_halibut <- sdmTMB(
    formula = density ~ as.factor(survey) + s(rocky, k = 3) + 
      # s(mixed, k = 3) + 
      s(muddy, k = 3) +
      depth_scaled + I(depth_scaled^2),
    data = d_hal,
    spde = mesh400kn,
    fields = "RW",
    # ar1_fields = T,
    # start = list(ar1_phi = qlogis((0.999 + 1) / 2)),
    # map = list(ar1_phi = factor(NA)),
    include_spatial = FALSE,
    time = "year",
    silent = FALSE,
    anisotropy = TRUE,
    reml = TRUE,
    family = tweedie(link = "log")
  )
  saveRDS(m_halibut, file = f)
}
```

```{r echo = F}
m_halibut <- readRDS(file = "models/halibut-hybrid-model-new-RW-w-rocky-muddy-400kn.rds")
round(AIC(m_halibut))
m_halibut
# m_halibut500m <- readRDS(file = "models/halibut-hybrid-model-RW-hbll-ests-w-mud-rock-500m-400kn.rds")
# m_halibut500m # delta 3 worse
# round(AIC(m_halibut500m))
# tidy(m_halibut, "ran_pars", conf.int = TRUE)
```

### Does adding a fixed spatial field help?

```{r eval = TRUE}
# f <- paste0("models/halibut-hybrid-model-RW-w-rocky-wfixed-400kn.rds")
# if (!file.exists(f)) {
#   m_halibut2 <- sdmTMB(
#     formula = density ~ as.factor(survey) + s(any_rock, k = 3) +
#       depth_scaled + I(depth_scaled^2),
#     data = d_hal,
#     spde = mesh400kn,
#     ar1_fields = T,
#     time = "year",
#     silent = FALSE,
#     anisotropy = TRUE,
#     reml = TRUE,
#     family = tweedie(link = "log"),
#     start = list(ar1_phi = qlogis((0.999 + 1) / 2)),
#     map = list(ar1_phi = factor(NA))
#   )
#   saveRDS(m_halibut2, file = f)
# }
```

```{r echo = F}
# m_halibut1 <- readRDS(file = "models/halibut-hybrid-model-RW-w-rocky-wfixed-400kn.rds")
# # m_halibut1
# AIC(m_halibut1) 
```

Other substrate covariates
```{r}
# m_halibut0 <- readRDS(file = "models/halibut-hybrid-model-RW-w-rocky-400kn.rds")
# m_halibut0
# round(AIC(m_halibut0)) # 2nd worst
# 
# m_halibut1 <- readRDS(file = "models/halibut-hybrid-model-RW-w-anyrock-400kn.rds")
# m_halibut1
# round(AIC(m_halibut1)) # worst
# 
# m_halibut2 <- readRDS(file = "models/halibut-hybrid-model-RW-w-rocky-mixed-400kn.rds")
# m_halibut2
# round(AIC(m_halibut2)) # similar to rocky + muddy
# 
# m_halibut3 <- readRDS(file = "models/halibut-hybrid-model-RW-w-all-400kn.rds")
# m_halibut3
# round(AIC(m_halibut3)) # best
# 
# 
# With all, AIC: 
# `r round(AIC(m_halibut3))` 
# 
# With just rocky, AIC: 
# `r round(AIC(m_halibut0))` 
# 
# With a cumulative any rock var, AIC: 
# `r round(AIC(m_halibut1))` 
# 
# With both rock related, AIC: 
# `r round(AIC(m_halibut2))` 
# 
# With mud and rock like ye, AIC: 
# `r round(AIC(m_halibut))` 

```



```{r warning=F, message=F}
get_diag(m_halibut)
```


# Yelloweye Rockfish model

Much less temporal variation.

```{r eval=TRUE}
d_ye <- readRDS("data-generated/yelloweye-hybrid-model-data-paired.rds") %>%
  filter(latitude < 52.15507) %>%
  filter(year %in% years) %>% left_join(substrate)

f <- "models/yelloweye-hybrid-new-RW-w-rocky-muddy-400kn.rds"
if (!file.exists(f)) {
  m_ye <- sdmTMB(
    formula = density ~ as.factor(survey) + s(rocky, k = 3) + #s(mixed, k = 3) + 
      s(muddy, k = 3) + 
      depth_scaled + I(depth_scaled^2),
    data = d_ye,
    spde = mesh400kn,
    fields = "RW",
    # ar1_fields = T,
    # start = list(ar1_phi = qlogis((0.999 + 1) / 2)),
    # map = list(ar1_phi = factor(NA)),
    include_spatial = FALSE,
    time = "year",
    silent = FALSE,
    anisotropy = TRUE,
    reml = TRUE,
    family = tweedie(link = "log")
  )
  saveRDS(m_ye, file = f)
}
```

Without fixed spatial field:

```{r echo = F}
m_ye <- readRDS(file = "models/yelloweye-hybrid-new-RW-w-rocky-muddy-400kn.rds")
m_ye
# round(AIC(m_ye))
# m_ye500m <- readRDS(file = "models/yelloweye-hybrid-RW-w-rocky-muddy-500m-400kn.rds")
# m_ye500m
# round(AIC(m_ye500m)) # delta 3 worse
# tidy(m_ye, "ran_pars", conf.int = TRUE)
```

```{r eval = TRUE, echo = F}
# With fixed spatial field:
# f <- "models/yelloweye-hybrid-RW-w-anyrock-wfixedsp-400kn.rds"
# if (!file.exists(f)) {
#   m_ye2 <- sdmTMB(
#     formula = density ~ as.factor(survey) + s(any_rock, k = 3) +
#       depth_scaled + I(depth_scaled^2),
#     data = d_ye,
#     spde = mesh400kn,
#     ar1_fields = T,
#     include_spatial = T,
#     time = "year",
#     silent = FALSE,
#     anisotropy = TRUE,
#     reml = TRUE,
#     family = tweedie(link = "log"),
#     start = list(ar1_phi = qlogis((0.999 + 1) / 2)),
#     map = list(ar1_phi = factor(NA))
#   )
#   saveRDS(m_ye2, file = f)
# }
```

```{r echo = F}
# m_ye2 <- readRDS(file = "models/yelloweye-hybrid-RW-w-anyrock-wfixedsp-400kn.rds")
```

Other substrate covariates
```{r}
# m_ye0 <- readRDS(file = "models/yelloweye-hybrid-RW-w-rocky-400kn.rds")
# m_ye0
# m_ye1 <- readRDS(file = "models/yelloweye-hybrid-RW-w-anyrock-400kn.rds")
# m_ye1
# m_ye2 <- readRDS(file = "models/yelloweye-hybrid-RW-w-rocky-mixed-400kn.rds")
# m_ye2
# # m_ye3 <- readRDS(file = "models/yelloweye-hybrid-RW-w-all-400kn.rds") # not run yet
# # m_ye3
# # round(AIC(m_ye1))

# With both rock + mudd , AIC: 
# `r round(AIC(m_ye))` 
# 
# With both rock related, AIC: 
# `r round(AIC(m_ye2))` 
# 
# With just rocky, AIC: 
# `r round(AIC(m_ye0))` 
# 
# With a cumulative any rock var, AIC: 
# `r round(AIC(m_ye1))` 
```


```{r warning=F, message=F}
get_diag(m_ye)
```


# Pacific Halibut catch predictions and index

For CDA only (HBLL and trawl grids)

```{r eval = TRUE, echo=F}
f <- "data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-cda.rds"
if (!file.exists(f)) {
  p_hal_cda <- predict(m_halibut, newdata = cda_grid, return_tmb_object = TRUE)
  saveRDS(p_hal_cda, "data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-predictions-cda.rds")
  i_hal_cda <- get_index(p_hal_cda, bias_correct = F)
  saveRDS(i_hal_cda, f)
}

ss <- "data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-cda-sim-500.rds"
if (!file.exists(ss)) {
  i_hal_cda2 <- get_all_sims(m_halibut, newdata = cda_grid)
  saveRDS(i_hal_cda2, ss)
}
```

For 3CD outside CDA (HBLL and trawl grids)

```{r eval = T, echo=F}
f <- "data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-3CD-outside-cda.rds"
if (!file.exists(f)) {
  p_hal_noncda <- predict(m_halibut, newdata = noncda_grid, return_tmb_object = TRUE)
  saveRDS(p_hal_noncda, "data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-predictions-3CD-outside-cda.rds")

  i_hal_noncda <- get_index(p_hal_noncda, bias_correct = F)
  saveRDS(i_hal_noncda, f)
}

ss <- "data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-3CD-outside-cda-sim-500.rds"
if (!file.exists(ss)) {
  i_hal_noncda2 <- get_all_sims(m_halibut, newdata = noncda_grid)
  saveRDS(i_hal_noncda2, ss)
}
```

For area 5A (HBLL and trawl grids)

```{r eval = T, echo=F}
f <- "data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-predictions-5A.rds"

if (!file.exists(f)) {
p_hal_5A <- predict(m_halibut, newdata = s_5A_grid, return_tmb_object = TRUE)
saveRDS(p_hal_5A, "data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-predictions-5A.rds")
}

f <- "data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-5A.rds"
if (!file.exists(f)) {
  p_hal_5A <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-predictions-5A.rds")
  i_hal_5A <- get_index(p_hal_5A, bias_correct = F)
  saveRDS(i_hal_5A, f)
}


ss <- "data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-5A-sim-500.rds"
if (!file.exists(ss)) {
  i_hal_5A2 <- get_all_sims(m_halibut, newdata = s_5A_grid)
  saveRDS(i_hal_5A2, ss)
}
```

For entire southern outside HBLL grid including CDA plus the trawl survey area that falls within HBLL bounds.

```{r eval = T, echo=F}
f <- "data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-all-S.rds"
if (!file.exists(f)) {
  p_hal_S <- predict(m_halibut, newdata = full_s_grid, return_tmb_object = TRUE)
  saveRDS(p_hal_S, "data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-predictions-all-S.rds")

  i_hal_S <- get_index(p_hal_S, bias_correct = F) # bias_correction not working only for full grid
  saveRDS(i_hal_S, f)
}

ss <- "data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-all-S-sim-500.rds"
if (!file.exists(ss)) {
  i_hal_S2 <- get_all_sims(m_halibut, newdata = full_s_grid)
  saveRDS(i_hal_S2, ss)
}
```

For just southern outside HBLL 

```{r eval = T, echo=F}
f <- "data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-hbll-S.rds"
if (!file.exists(f)) {
  
  hbll_s_grid <- filter(full_s_grid, survey == "HBLL")
  
  p_hal_Sb <- predict(m_halibut, newdata = hbll_s_grid, return_tmb_object = TRUE)
  saveRDS(p_hal_Sb, "data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-predictions-hbll-S.rds")

  i_hal_Sb <- get_index(p_hal_Sb, bias_correct = F) # bias_correction not working only for full grid
  saveRDS(i_hal_Sb, f)
}

ss <- "data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-hbll-S-sim-500.rds"
if (!file.exists(ss)) {
  i_hal_S2b <- get_all_sims(m_halibut, newdata = hbll_s_grid)
  saveRDS(i_hal_S2b, ss)
}
```


# Yelloweye Rockfish catch predictions and index

For CDA only (HBLL and trawl grids)

```{r eval = TRUE, echo=F}
f <- "data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-cda.rds"
if (!file.exists(f)) {
  p_ye_cda <- predict(m_ye, newdata = cda_grid, return_tmb_object = TRUE)
  saveRDS(p_ye_cda, "data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-predictions-cda.rds")

  i_ye_cda <- get_index(p_ye_cda, bias_correct = F)
  saveRDS(i_ye_cda, f)
}

ss <- "data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-cda-sim-500.rds"
if (!file.exists(ss)) {
  i_ye_cda2 <- get_all_sims(m_ye, newdata = cda_grid)
  saveRDS(i_ye_cda2, ss)
}
```

For 3CD outside CDA (HBLL and trawl grids)

```{r eval = T, echo=F}
f <- "data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-3CD-outside-cda.rds"
if (!file.exists(f)) {
  p_ye_noncda <- predict(m_ye, newdata = noncda_grid, return_tmb_object = TRUE)
  saveRDS(p_ye_noncda, "data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-predictions-3CD-outside-cda.rds")

  i_ye_noncda <- get_index(p_ye_noncda, bias_correct = F)
  saveRDS(i_ye_noncda, f)
}

ss <- "data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-3CD-outside-cda-sim-500.rds"
if (!file.exists(ss)) {
  i_ye_noncda2 <- get_all_sims(m_ye, newdata = noncda_grid)
  saveRDS(i_ye_noncda2, ss)
}
```

For area 5A (HBLL and trawl grids)

```{r eval = T, echo=F}
f <- "data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-5A.rds"
if (!file.exists(f)) {
  p_ye_5A <- predict(m_ye, newdata = s_5A_grid, return_tmb_object = TRUE)
  saveRDS(p_ye_5A, "data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-predictions-5A.rds")

  i_ye_5A <- get_index(p_ye_5A, bias_correct = F)
  saveRDS(i_ye_5A, f)
}

ss <- "data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-5A-sim-500.rds"
if (!file.exists(ss)) {
  i_ye_5A2 <- get_all_sims(m_ye, newdata = s_5A_grid)
  saveRDS(i_ye_5A2, ss)
}
```

For entire southern outside HBLL grid including CDA plus the trawl survey area that falls within HBLL bounds.
This is roughly equivilant to entire southern outside yelloweye stock.  

```{r eval = T, echo=F}
f <- "data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-all-S.rds"
if (!file.exists(f)) {
  p_ye_S <- predict(m_ye, newdata = full_s_grid, return_tmb_object = TRUE)
  saveRDS(p_ye_S, "data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-predictions-all-S.rds")

  i_ye_S <- get_index(p_ye_S, bias_correct = F)
  saveRDS(i_ye_S, f)
}

ss <- "data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-all-S-sim-500.rds"
if (!file.exists(ss)) {
  i_ye_S2 <- get_all_sims(m_ye, newdata = full_s_grid)
  saveRDS(i_ye_S2, ss)
}
```

For just southern outside HBLL 

```{r eval = T}
f <- "data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-hbll-S.rds"
if (!file.exists(f)) {
  
  hbll_s_grid <- filter(full_s_grid, survey == "HBLL")
  
  p_ye_Sb <- predict(m_ye, newdata = hbll_s_grid, return_tmb_object = TRUE)
  saveRDS(p_ye_Sb, "data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-predictions-hbll-S.rds")

  i_ye_Sb <- get_index(p_ye_Sb, bias_correct = F) # bias_correction not working only for full grid
  saveRDS(i_ye_Sb, f)
}

ss <- "data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-hbll-S-sim-500.rds"
if (!file.exists(ss)) {
  i_ye_S2b <- get_all_sims(m_ye, newdata = hbll_s_grid)
  saveRDS(i_ye_S2b, ss)
}
```

# Model checks 

## Check predictions against those from the HBLL-only count model

```{r echo=F, message=F, warning=F}
hybrid_pred <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-predictions-hbll-S.rds")
poisson_pred <- readRDS("data-generated/halibut-predictions-all-S.rds")

hyb <- hybrid_pred$data %>% 
  # mutate(est = exp(est)) %>%
  select(X, Y, year, log_biomass = est)

pois <- poisson_pred$data %>% 
  # mutate(est_exp = exp(est)) %>%
  mutate(      
      year_true = year,
      year = case_when(
        year %in% c(2007, 2008) ~ 2008,
        year %in% c(2009, 2010) ~ 2010,
        year %in% c(2011, 2012) ~ 2012,
        year %in% c(2013, 2014) ~ 2014,
        year %in% c(2015, 2016) ~ 2016,
        year %in% c(2017, 2018) ~ 2018,
        year %in% c(2019, 2020) ~ 2020
      ),
    X = round(X*100)/100, Y = round(Y*100)/100) %>% 
  select(X, Y, year, year_true, log_count = est)

d_test <- left_join(hyb, pois)

d_test_hal <- d_test[complete.cases(d_test), ]

ggplot(d_test_hal, aes(log_count, log_biomass)) + geom_point(alpha = 0.1) + 
  ylim(-3, 2) + xlim(-3, 3) + 
  facet_wrap(~year_true)
```

```{r echo=F, message=F, warning=F}
hybrid_pred <- readRDS("data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-predictions-hbll-S.rds")
poisson_pred <- readRDS("data-generated/yelloweye-spatial-predictions-all-S.rds")

hyb <- hybrid_pred$data %>% 
  # mutate(est = exp(est)) %>%
  select(X, Y, year, log_biomass = est)

pois <- poisson_pred$data %>% 
  # mutate(est_exp = exp(est)) %>%
  mutate( year_true = year, 
    year = case_when(
        year %in% c(2007, 2008) ~ 2008,
        year %in% c(2009, 2010) ~ 2010,
        year %in% c(2011, 2012) ~ 2012,
        year %in% c(2013, 2014) ~ 2014,
        year %in% c(2015, 2016) ~ 2016,
        year %in% c(2017, 2018) ~ 2018,
        year %in% c(2019, 2020) ~ 2020
      ), 
    X = round(X*100)/100, Y = round(Y*100)/100) %>% 
  select(X, Y, year, year_true, log_count = est)

d_test <- left_join(hyb, pois)

d_test_ye <- d_test[complete.cases(d_test), ]

ggplot(d_test_ye, aes(log_count, log_biomass)) + geom_point(alpha = 0.1) + 
  ylim(-7, 3) + xlim(-5, 4) + 
  facet_wrap(~year_true)
```

## Check distribution of simulations

```{r message=F, echo=F, warning=F}
sim_hal_cda <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-cda-sim-500.rds")[[2]]
sim_hal_noncda <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-3CD-outside-cda-sim-500.rds")[[2]]

ggplot(sim_hal_cda, aes(as.factor(year), .value)) + geom_violin(colour = "red") + geom_violin(data = sim_hal_noncda, aes(as.factor(year), .value), colour = "blue")

# ## check that the problem is with the predictions... and it seems to be
# sim_p_hal_cda1 <- readRDS("data-generated/halibut-index-cda-sim-500.rds")[[2]]
# sim_p_hal_cda2 <- readRDS("data-generated/halibut-index-cda-sim-500.rds")[[3]]
# sim_p_hal_cda <- bind_cols(sim_p_hal_cda1, as.data.frame(sim_p_hal_cda2)) %>% group_by(year) %>% summarise(V1 = sum(exp(V1)), V2 = sum(exp(V2)), V3 = sum(exp(V3)))
# sim_p_hal_cda
```

## Compare indices between species and model types 
Uses only HBLL S grid and transforms predicted counts from HBLL model into biomass density using same formula as used on the observed densities before stitching the two survey types together.

```{r echo=F, message=F, warning=F}
i_hal_hbll <- readRDS("data-generated/halibut-index-all-S-sim-500.rds")[[1]]
i_ye_hbll <- readRDS("data-generated/yelloweye-spatial-index-all-S-sim-500.rds")[[1]]
i_hal <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-hbll-S-sim-500.rds")[[1]]
i_ye <- readRDS("data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-hbll-S-sim-500.rds")[[1]]

.dat <- bind_rows(mutate(i_hal, Model = "HBLL + trawl (biomass)", Species = "Halibut"),
  mutate(i_hal_hbll, Model = "HBLL (counts x mean weight)", Species = "Halibut", 
    est = est * halmeanweight/ (100 * 0.0024384 * 0.009144 * 10000) , lwr = lwr * halmeanweight/ (100 * 0.0024384 * 0.009144 * 10000) , upr = upr * halmeanweight/ (100 * 0.0024384 * 0.009144 * 10000) ),
  mutate(i_ye, Model = "HBLL + trawl (biomass)", Species = "Yelloweye"),
  mutate(i_ye_hbll, Model = "HBLL (counts x mean weight)",  Species = "Yelloweye", 
    est = est * yemeanweight/ (100 * 0.0024384 * 0.009144 * 10000) , lwr = lwr * yemeanweight/ (100 * 0.0024384 * 0.009144 * 10000) , upr = upr * yemeanweight/ (100 * 0.0024384 * 0.009144 * 10000) )
)
# .dat$Model <- ordered(.dat$Model, levels = c("Halibut HBLL", "Yelloweye HBLL", "Yelloweye hybrid", "Halibut hybrid" ))
.dat$Species <- ordered(.dat$Species, levels = c("Halibut", "Yelloweye"))
.dat$year <- as.integer(.dat$year)

ggplot(.dat, aes(year, est/1000, fill = Species, colour = Species)) +
  geom_line() +
  geom_ribbon(aes(ymin = lwr/1000, ymax = upr/1000), alpha = 0.4, colour = NA) +
  # facet_wrap(~Model, nrow = 2, scales = "free") +
  # geom_line(data = .dat1, linetype = 2) +
  xlab("Year") +
  ylab("Biomass Index (HBLL S grid only)") +
  # coord_cartesian(expand = FALSE, ylim = c(0, max(i_ye$upr) * 1.04)) +
  # scale_x_continuous() +
  theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
  scale_fill_viridis_d(option = "D", begin = 0.5, end = 0.95) +
  scale_colour_viridis_d(option = "D", begin = 0.5, end = 0.95) +
  facet_wrap_custom(~Model, nrow = 2, scales = "free_x", scale_overrides = list(
    scale_override(1, scale_x_continuous(breaks = seq(1950, 2050, 2))),
    scale_override(2, scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)))
  ))

ggsave("figs/compare-model-indices-new-RW-hbll-ests-w-mud-rock.png", width = 7, height = 5, dpi = 400)
```

# Results

## Index of total Pacific Halibut catch through time

```{r message=F, echo=F}
# i_hal <- readRDS("data-generated/halibut-index-all-S.rds")
# i_hal_cda <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-cda.rds")
# i_hal_noncda <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-3CD-outside-cda.rds")
# i_hal_5A <- readRDS("data-generated/halibut-index-5A.rds")
i_hal <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-all-S-sim-500.rds")[[1]]
i_hal_cda <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-cda-sim-500.rds")[[1]]
i_hal_noncda <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-3CD-outside-cda-sim-500.rds")[[1]]
i_hal_5A <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-5A-sim-500.rds")[[1]]
i_hal_hbll <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-hbll-S-sim-500.rds")[[1]]

.dat <- bind_rows(
  mutate(i_hal, Area = "Full combined"),
  # mutate(i_hal_hbll, Area = "HBLL grid only"),
  mutate(i_hal_5A, Area = "5A"),
  mutate(i_hal_noncda, Area = "non-CDA 3CD"),
  mutate(i_hal_cda, Area = "CDA")
)
.dat$Area <- ordered(.dat$Area, levels = c("CDA", "non-CDA 3CD", "5A", "Full combined", "HBLL grid only"))
ggplot(.dat, aes(year, est, fill = Area, colour = Area)) +
  geom_line() +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.4, colour = NA) +
  xlab("Year") +
  ylab("Biomass index") +
  # coord_cartesian(expand = FALSE, ylim = c(0, max(i_hal$upr) * 1.04)) +
  # scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-by-area.png", width = 7, height = 4, dpi = 400)
```


## Index of total Yelloweye Rockfish catch through time

```{r message=F, echo=F}
i_ye <- readRDS("data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-all-S-sim-500.rds")[[1]]
i_ye_cda <- readRDS("data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-cda-sim-500.rds")[[1]]
i_ye_noncda <- readRDS("data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-3CD-outside-cda-sim-500.rds")[[1]]
i_ye_5A <- readRDS("data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-5A-sim-500.rds")[[1]]

i_ye_hbll <- readRDS("data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-hbll-S-sim-500.rds")[[1]]

.dat <- bind_rows(
  mutate(i_ye, Area = "Full combined"),
  # mutate(i_ye_hbll, Area = "HBLL grid only"),
  mutate(i_ye_5A, Area = "5A"),
  mutate(i_ye_noncda, Area = "non-CDA 3CD"),
  mutate(i_ye_cda, Area = "CDA")
)
.dat$Area <- ordered(.dat$Area, levels = c("CDA", "non-CDA 3CD", "5A", "Full combined", "HBLL grid only"))
ggplot(.dat, aes(year, est, fill = Area, colour = Area)) +
  geom_line() +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.4, colour = NA) +
  # geom_line(data = .dat1, linetype = 2) +
  xlab("Year") +
  ylab("Biomass index") +
  coord_cartesian(#expand = FALSE, 
    ylim = c(0, max(i_ye$upr) * 1.04)) +
  # scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-by-area.png", width = 7, height = 4, dpi = 400)
```

## Estimated catch per 100 hooks through time

Average predicted catch within the entire court defined area is in red, remainder of the 3CD area is in blue.

### Pacific Halibut

```{r message = F, echo= F}
i_hal_cda <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-cda-sim-500.rds")[[1]]
i_hal_noncda <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-3CD-outside-cda-sim-500.rds")[[1]]

.dat <- bind_rows(
  mutate(i_hal_noncda,
    Area = "non-CDA 3CD",
    est = est / nrow(noncda_grid),
    lwr = lwr / nrow(noncda_grid),
    upr = upr / nrow(noncda_grid)
  ),
  mutate(i_hal_cda,
    Area = "CDA",
    est = est / nrow(cda_grid),
    lwr = lwr / nrow(cda_grid),
    upr = upr / nrow(cda_grid)
  ),
)
ggplot(.dat, aes(year, est)) +
  geom_line(aes(colour = Area)) +
  geom_ribbon(aes(
    ymin = lwr,
    ymax = upr, fill = Area
  ), alpha = 0.4) +
  xlab("Year") +
  ylab("Biomass density (kg/ha)") +
  # scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-average-index.png", width = 7, height = 4, dpi = 400)
```

### Yelloweye Rockfish

```{r message = F, echo= F}
.dat <- bind_rows(
  mutate(i_ye_noncda,
    Area = "non-CDA 3CD",
    est = est / nrow(noncda_grid),
    lwr = lwr / nrow(noncda_grid),
    upr = upr / nrow(noncda_grid)
  ),
  mutate(i_ye_cda,
    Area = "CDA",
    est = est / nrow(cda_grid),
    lwr = lwr / nrow(cda_grid),
    upr = upr / nrow(cda_grid)
  ),
)
ggplot(.dat, aes(year, est)) +
  geom_line(aes(colour = Area)) +
  geom_ribbon(aes(
    ymin = lwr,
    ymax = upr, fill = Area
  ), alpha = 0.4) +
  xlab("Year") +
  ylab("Biomass density (kg/ha)") +
  # scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-average-index.png", width = 7, height = 4, dpi = 400)
```


# Calculate predicted catch rates in the different areas

```{r}
i_hal2 <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-all-S-sim-500.rds")[[2]]
i_hal_cda2 <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-cda-sim-500.rds")[[2]]
i_hal_noncda2 <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-3CD-outside-cda-sim-500.rds")[[2]]
i_hal_5A2 <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-index-5A-sim-500.rds")[[2]]

.dat2 <- bind_rows(
  mutate(i_hal2, Area = "Full combined", num_cells = nrow(full_s_grid)),
  mutate(i_hal_5A2, Area = "5A", num_cells = nrow(s_5A_grid)),
  mutate(i_hal_noncda2, Area = "non-CDA 3CD", num_cells = nrow(noncda_grid)),
  mutate(i_hal_cda2, Area = "CDA", num_cells = nrow(cda_grid))
)
.dat2$Area <- ordered(.dat2$Area, levels = c("CDA", "non-CDA 3CD", "5A", "Full combined"))

i_hal_2020 <- filter(.dat2, year == 2020) %>% filter(.iteration <= 200)

catch_per_cell <- i_hal_2020 %>%
  group_by(Area) %>%
  summarise(
    catch = mean(.value / num_cells),
    catch_med = median(.value / num_cells),
    catch_lwr = quantile(.value / num_cells, 0.025),
    catch_upr = quantile(.value / num_cells, 0.975)
  )

saveRDS(catch_per_cell, "data-generated/hal_catch_per_cell_RW-hbll-ests-w-mud-rock.rds")
```

```{r}
i_ye2 <- readRDS("data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-all-S-sim-500.rds")[[2]]
i_ye_cda2 <- readRDS("data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-cda-sim-500.rds")[[2]]
i_ye_noncda2 <- readRDS("data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-3CD-outside-cda-sim-500.rds")[[2]]
i_ye_5A2 <- readRDS("data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-index-5A-sim-500.rds")[[2]]

.dat2 <- bind_rows(
  mutate(i_ye2, Area = "Full combined", num_cells = nrow(full_s_grid)),
  mutate(i_ye_5A2, Area = "5A", num_cells = nrow(s_5A_grid)),
  mutate(i_ye_noncda2, Area = "non-CDA 3CD", num_cells = nrow(noncda_grid)),
  mutate(i_ye_cda2, Area = "CDA", num_cells = nrow(cda_grid))
)
.dat2$Area <- ordered(.dat2$Area, levels = c("CDA", "non-CDA 3CD", "5A", "Full combined"))

i_ye_2020 <- filter(.dat2, year == 2020) %>% filter(.iteration <= 200)

ye_catch_per_cell <- i_ye_2020 %>%
  group_by(Area) %>%
  summarise(
    catch = mean(.value / num_cells),
    catch_med = median(.value / num_cells),
    catch_lwr = quantile(.value / num_cells, 0.025),
    catch_upr = quantile(.value / num_cells, 0.975)
  )

saveRDS(ye_catch_per_cell, "data-generated/ye_catch_per_cell_RW-hbll-ests-w-mud-rock.rds")
```


```{r message=F, echo=F}
ggplot(i_hal_2020) + geom_histogram(aes(.value / num_cells), alpha = 0.75, fill = "black") +
  geom_histogram(data = i_ye_2020, aes(.value / num_cells, fill = Area), alpha = 0.75) +
  geom_vline(data = catch_per_cell, aes(xintercept = catch_med), linetype = 2, alpha = 0.5, colour = "black") +
  geom_vline(data = ye_catch_per_cell, aes(xintercept = catch_med, colour = Area), linetype = 2) +
  facet_grid(rows = vars(Area)) + xlab("Mean kg/ha") + ylab("Number of simulations") +
  scale_fill_brewer(palette = "Set1") + scale_colour_brewer(palette = "Set1") + theme(legend.position = "none") +
  ggtitle("Estimated relative biomass densities (dashed lines are median)",
    subtitle = "Yelloweye Rockfish (coloured bars) vs. Pacific Halibut (grey bars)"
  )

ggsave("figs/hybrid-new-RW-hbll-ests-w-mud-rock-estimated-biomass-densities.png", width = 5, height = 7, dpi = 400)
```


# What proportion of estimated total catch is inside CDA in 2020?

What proportion of 3CD HBLL + trawl survey grid is inside CDA?

`r round(nrow(cda_grid) / (nrow(cda_grid) + nrow(noncda_grid)), 2)`

```{r echo=F, message=F, warning=F}
hal_ratios <- i_hal_2020 %>%
  select(-num_cells) %>%
  pivot_wider(names_from = Area, values_from = .value) %>%
  group_by(.iteration) %>%
  mutate(CDAto3CD = CDA / (CDA + `non-CDA 3CD`), CDAtoFull = CDA / `Full combined`)

mean_hal_ratios <- hal_ratios %>%
  pivot_longer(cols = c(CDAto3CD, CDAtoFull), names_to = "area", values_to = "ratio") %>%
  group_by(area) %>%
  summarise(
    ratio_mean = mean(ratio),
    ratio_med = median(ratio),
    ratio_lwr = quantile(ratio, 0.025),
    ratio_upr = quantile(ratio, 0.975)
  )
saveRDS(mean_hal_ratios, "data-generated/mean_hal_ratios_RW-hbll-ests-w-mud-rock.rds")

ggplot(hal_ratios) +
  geom_histogram(aes(CDAto3CD), fill = "red", alpha = 0.75) +
  geom_histogram(aes(CDAtoFull), fill = "black", alpha = 0.5) +
  # geom_vline(data = mean_hal_ratios, aes(xintercept = ratio_med), linetype = 2) +
  xlim(0, max(hal_ratios$CDAto3CD)) +
  xlab("Proportion of total catch inside CDA") + ylab("Number of simulations") +
  ggtitle("Pacific Halibut survey biomass in area 3CD (red) and full combined grid (grey)")
ggsave("figs/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-relative-biomass.png", width = 7, height = 3, dpi = 400)
```

```{r echo=F, message=F, warning=F}
ye_ratios <- i_ye_2020 %>%
  select(-num_cells) %>%
  pivot_wider(names_from = Area, values_from = .value) %>%
  group_by(.iteration) %>%
  mutate(CDAto3CD = CDA / (CDA + `non-CDA 3CD`), CDAtoFull = CDA / (`Full combined`))

mean_ye_ratios <- ye_ratios %>%
  pivot_longer(cols = c(CDAto3CD, CDAtoFull), names_to = "area", values_to = "ratio") %>%
  group_by(area) %>%
  summarise(    
    ratio_mean = mean(ratio),
    ratio_med = median(ratio),
    ratio_lwr = quantile(ratio, 0.025),
    ratio_upr = quantile(ratio, 0.975)
  )
saveRDS(mean_ye_ratios, "data-generated/mean_ye_ratios_RW-hbll-ests-w-mud-rock.rds")

ggplot(ye_ratios) +
  geom_histogram(aes(CDAto3CD), fill = "red", alpha = 0.75) +
  geom_histogram(aes(CDAtoFull), fill = "black", alpha = 0.5) +
  # geom_vline(data = mean_ye_ratios, aes(xintercept = ratio_med), linetype = 2) +
  xlim(0, max(hal_ratios$CDAto3CD)) +
  xlab("Proportion of total biomass inside CDA") + ylab("Number of simulations") +
  ggtitle("Yelloweye Rockfish survey biomass in area 3CD (red) and full combined grid (grey)")
ggsave("figs/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-relative-biomass.png", width = 7, height = 3, dpi = 400)
```


## Ratio of Yelloweye to Halibut through time

```{r message=F, echo=F, warning=F}
.i_ye <- bind_rows(
  mutate(i_ye2, Area = "Full combined", num_cells = nrow(full_s_grid)),
  mutate(i_ye_5A2, Area = "5A", num_cells = nrow(s_5A_grid)),
  mutate(i_ye_noncda2, Area = "non-CDA 3CD", num_cells = nrow(noncda_grid)),
  mutate(i_ye_cda2, Area = "CDA", num_cells = nrow(cda_grid))
) %>%   filter(.iteration <= 500) %>%
  rename(yelloweye = .value) 
.i_ye$Area <- ordered(.i_ye$Area, levels = c("CDA", "non-CDA 3CD", "5A", "Full combined"))

.i_hal <- bind_rows(
  mutate(i_hal2, Area = "Full combined", num_cells = nrow(full_s_grid)),
  mutate(i_hal_5A2, Area = "5A", num_cells = nrow(s_5A_grid)),
  mutate(i_hal_noncda2, Area = "non-CDA 3CD", num_cells = nrow(noncda_grid)),
  mutate(i_hal_cda2, Area = "CDA", num_cells = nrow(cda_grid))
) %>% filter(.iteration <= 500) %>%
  rename(halibut = .value)
.i_hal$Area <- ordered(.i_hal$Area, levels = c("CDA", "non-CDA 3CD", "5A", "Full combined"))

.dat <- left_join(.i_ye, .i_hal) %>% mutate(
    ye_per_hal = yelloweye / (halibut),
    hal_per_ye = (halibut) / yelloweye
  ) %>% 
  group_by(Area, year) %>%
  summarise(
    lwr = quantile(ye_per_hal, 0.025),
    upr = quantile(ye_per_hal, 0.975),
    ye_per_hal = mean(ye_per_hal),
    lwr_hal = quantile(hal_per_ye, 0.025),
    upr_hal = quantile(hal_per_ye, 0.975),
    hal_per_ye = mean(hal_per_ye)
  ) 

saveRDS(.dat, "data-generated/ratios-yelloweye-to-halibut-new-RW-hbll-ests-w-mud-rock.rds")

.dat <- .dat %>% filter(Area %in% c("non-CDA 3CD", "CDA"))

ggplot(.dat, aes(year, ye_per_hal, fill = Area, colour = Area)) +
  geom_line() +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.4, colour = NA) +
  xlab("Year") +
  ylab("Estimated yelloweye to halibut biomass ratio") +
  coord_cartesian(expand = T, ylim = c(0.03, max(.dat$upr) * 1.04)) +
  # scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/hybrid-ye-to-hal-index-new-RW-hbll-ests-w-mud-rock.png", width = 7, height = 4, dpi = 400)



ggplot(.dat, aes(year, hal_per_ye, fill = Area, colour = Area)) +
  geom_line() +
  geom_ribbon(aes(ymin = lwr_hal, ymax = upr_hal), alpha = 0.4, colour = NA) +
  xlab("Year") +
  ylab("Estimated halibut to yelloweye biomass ratio") +
  coord_cartesian(expand = T, ylim = c(2, max(.dat$upr_hal) * 1.04)) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/hybrid-hal-to-ye-index-new-RW-hbll-ests-w-mud-rock.png", width = 7, height = 4, dpi = 400)


```

Checking what happens if we use different weights... 1.33x larger for halibut

```{r message=F, echo=F, warning=F}
# checking what happens if we use different weights... 1.33x larger for halibut
hbll_s_grid <- filter(full_s_grid, survey == "HBLL")
hbll_noncda_grid <- filter(noncda_grid, survey == "HBLL")
hbll_cda_grid <- filter(cda_grid, survey == "HBLL")

hbll_in_cda <- nrow(hbll_cda_grid)/nrow(cda_grid)
hbll_in_noncda <- nrow(hbll_noncda_grid)/nrow(noncda_grid)

.dat <- left_join(.i_ye, .i_hal) %>% mutate(
    ye_per_hal = yelloweye / ifelse(Area =="CDA", halibut * 1.33 * hbll_in_cda, halibut * 1.33 * hbll_in_noncda),
    hal_per_ye = ifelse(Area =="CDA", halibut * 1.33 * hbll_in_cda, halibut * 1.33 * hbll_in_noncda) / yelloweye
  ) %>% 
  group_by(Area, year) %>%
  summarise(
    lwr = quantile(ye_per_hal, 0.025),
    upr = quantile(ye_per_hal, 0.975),
    ye_per_hal = mean(ye_per_hal),
    lwr_hal = quantile(hal_per_ye, 0.025),
    upr_hal = quantile(hal_per_ye, 0.975),
    hal_per_ye = mean(hal_per_ye)
  ) 
.dat <- .dat %>% filter(Area %in% c("non-CDA 3CD", "CDA"))
saveRDS(.dat, "data-generated/ratios-yelloweye-to-halibut-new-RW-hbll-ests-w-mud-rock.rds")


ggplot(.dat, aes(year, ye_per_hal, fill = Area, colour = Area)) +
  geom_line() +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.4, colour = NA) +
  xlab("Year") +
  ylab("Estimated yelloweye to halibut biomass ratio") +
  coord_cartesian(expand = T, ylim = c(0, max(.dat$upr) * 1.04)) +
  # scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/hybrid-ye-to-halx-index-new-RW-hbll-ests-w-mud-rock.png", width = 7, height = 4, dpi = 400)

ggplot(.dat, aes(year, hal_per_ye, fill = Area, colour = Area)) +
  geom_line() +
  geom_ribbon(aes(ymin = lwr_hal, ymax = upr_hal), alpha = 0.4, colour = NA) +
  xlab("Year") +
  ylab("Estimated halibut to yelloweye biomass ratio") +
  coord_cartesian(expand = T, ylim = c(0, max(.dat$upr_hal) * 1.04)) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/hybrid-halx-to-ye-index-new-RW-hbll-ests-w-mud-rock.png", width = 7, height = 4, dpi = 400)
```

# Maps

Predictions depicted for HBLL survey grid area that falls within region 3CD. "Court defined area" area is outlined in red. Only 2020 survey catch is included on first two maps, all years of halibut catch are included on the map showing number of Yelloweye Rockfish expected per halibut caught 2020. 

## Halibut

2020 predictions with all survey catches in 2019 and 2020

```{r message=F, echo=F}
p_hal2020 <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-predictions-all-S.rds")[[1]] %>% 
  filter(year == 2020)
d_hal_plots <- readRDS("data-generated/halibut-hybrid-model-data.rds") %>%
  # plot observations for last 3 years to ensure sampling in all regions
  filter(latitude < 52.15507) %>% filter(year %in% c(#2017,2018,
    2019,2020)) %>%  
  mutate(
    # back transform densities into catch per 100 hooks
    catch_equiv = round(density * (100 * 0.0024384 * 0.009144 * 10000) / halmeanweight), 
    max_count = round((max(catch_count, na.rm = T)/mean(hook_count, na.rm = T))*100),
    catch_equiv2 = ifelse(catch_equiv < max_count, catch_equiv, max_count)
    )

g <- map_predictions(
  pred_data = p_hal2020,
  # pred_min = min(exp(p_hal2020$est), na.rm = T),
  # pred_max = quantile(exp(p_hal2020$est), 0.9999, na.rm = T),
  obs_data = d_hal_plots,
  fill_lab = "Predicted kg/ha",
  size_lab = "Observed catch\nper 100 hook\nequivalent",
  # pred_min = min(exp(p_hal2020$est), na.rm = T),
  # pred_max = quantile(exp(p_hal2020$est), 0.99, na.rm = T),
  size_aes = catch_equiv 
)
g
dir.create("figs", showWarnings = FALSE)
ggsave("figs/hybrid-halibut-2020-predictions-new-RW-hbll-ests-w-mud-rock.png", width = 5.5, height = 6, dpi = 400)
```

```{r map-predictions-all, message=F, echo=F, warning=F, cache=TRUE}
p_hal <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-predictions-all-S.rds")
years <- unique(p_hal$data$year)
p_hal_d <- p_hal$data #%>%
#   filter(year %in% years) %>%
#   mutate(year = as.factor(year))
# p_hal_d$year <- droplevels(p_hal_d$year)

f <- "figs/hybrid-halibut-predictions-new-RW-hbll-ests-w-mud-rock.png"
if (!file.exists(f)) {
  
d_hal_facet <- readRDS("data-generated/halibut-hybrid-model-data-paired.rds") %>%
  filter(latitude < 52.15507) %>% filter(year %in% years) %>% 
  mutate(
      pair_name = case_when(
        year %in% c(2007, 2008) ~ "2007-2008",
        year %in% c(2009, 2010) ~ "2009-2010",
        year %in% c(2011, 2012) ~ "2011-2012",
        year %in% c(2013, 2014) ~ "2013-2014",
        year %in% c(2015, 2016) ~ "2015-2016",
        year %in% c(2017, 2018) ~ "2017-2018",
        year %in% c(2019, 2020) ~ "2019-2020"
      ),
    # back transform densities into catch per 100 hooks
    catch_equiv = round(density * (100 * 0.0024384 * 0.009144 * 10000) / halmeanweight), 
    max_count = round((max(catch_count, na.rm = T)/mean(hook_count, na.rm = T))*100),
    catch_equiv2 = ifelse(catch_equiv < max_count, catch_equiv, max_count)
    )

g <- map_predictions(
  pred_data = p_hal_d,
  pred_min = min(exp(p_hal_d$est), na.rm = T),
  pred_max = quantile(exp(p_hal_d$est), 0.99, na.rm = T),
  obs_data = d_hal_facet,
  fill_lab = "Predicted kg/ha",
  size_aes = catch_equiv,
  size_lab = "Observed catch\nper 100 hook\nequivalent",
  legend_position = "right"
) + facet_wrap(~pair_name)

# g <- g + theme(legend.position = c(0.35, 0), legend.justification = c(0,0))

ggsave("figs/hybrid-halibut-predictions-new-RW-hbll-ests-w-mud-rock.png", width = 9, height = 10, dpi = 200)
}
```


## Yelloweye Rockfish

2020 predictions with all survey catches in 2019 and 2020

```{r message=F, echo=F}
p_ye <- readRDS("data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-predictions-all-S.rds")[[1]] %>% 
  filter(year == 2020)
d_ye_plots <- readRDS("data-generated/yelloweye-hybrid-model-data.rds") %>%
  filter(latitude < 52.15507)  %>% filter(year %in% c(#2017,2018,
    2019,2020)) %>% 
  mutate(
    # back transform densities into catch per 100 hooks
    catch_equiv = round(density * (100 * 0.0024384 * 0.009144 * 10000) / yemeanweight), 
    max_count = round((max(catch_count, na.rm = T)/mean(hook_count, na.rm = T))*100),
    catch_equiv2 = ifelse(catch_equiv < max_count, catch_equiv, max_count)
    )
g <- map_predictions(
  pred_data = p_ye,
  fill_lab = "Predicted kg/ha",
  obs_data = d_ye_plots,  
  size_aes = catch_equiv,
  size_lab = "Observed catch\nper 100 hook\nequivalent",
)
g
dir.create("figs", showWarnings = FALSE)
ggsave("figs/hybrid-yelloweye-2020-predictions-new-RW-hbll-ests-w-mud-rock.png", width = 5.5, height = 6, dpi = 400)
```

```{r ye-map-all, cache=TRUE, echo=F, message=F, warning=F}
p_ye <- readRDS("data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-predictions-all-S.rds")
years <- unique(p_ye$data$year)
p_ye_d <- p_ye$data #%>%
#   filter(year %in% years) %>%
#   mutate(year = as.factor(year))
# p_ye_d$year <- droplevels(p_ye_d$year)

f <- "figs/hybrid-ye-predictions-new-RW-hbll-ests-w-mud-rock.png"
if (!file.exists(f)) {
d_ye_facet <- readRDS("data-generated/yelloweye-hybrid-model-data-paired.rds") %>%
  filter(latitude < 52.15507) %>% filter(year %in% years) %>% 
  mutate(
    pair_name = case_when(
        year %in% c(2007, 2008) ~ "2007-2008",
        year %in% c(2009, 2010) ~ "2009-2010",
        year %in% c(2011, 2012) ~ "2011-2012",
        year %in% c(2013, 2014) ~ "2013-2014",
        year %in% c(2015, 2016) ~ "2015-2016",
        year %in% c(2017, 2018) ~ "2017-2018",
        year %in% c(2019, 2020) ~ "2019-2020"
      ),
    # back transform densities into catch per 100 hooks
    catch_equiv = round(density * (100 * 0.0024384 * 0.009144 * 10000) / yemeanweight), 
    max_count = round((max(catch_count, na.rm = T)/mean(hook_count, na.rm = T))*100),
    catch_equiv2 = ifelse(catch_equiv < max_count, catch_equiv, max_count)
    )

g <- map_predictions(
  pred_data = p_ye_d,
  obs_data = d_ye_facet,
  fill_lab = "Predicted kg/ha",
  pred_min = min(exp(p_ye$data$est), na.rm = T),
  pred_max = quantile(exp(p_ye$data$est), 0.99, na.rm = T),
  size_aes = catch_equiv,
  size_lab = "Observed catch\nper 100 hook\nequivalent",
  legend_position = "right"
) + facet_wrap(~pair_name) 
# g <- g + theme(legend.position = c(0.35, 0), legend.justification = c(0,0))
ggsave("figs/hybrid-ye-predictions-new-RW-hbll-ests-w-mud-rock.png", width = 9, height = 10, dpi = 200)
}
```


# Map expected catch ratios

```{r message=F}
# calculate ratio of yelloweye to halibut
p_ye <- readRDS("data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-predictions-all-S.rds")
p_hal <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-predictions-all-S.rds")
pyd <- p_ye$data %>% rename(ye_est = est)
phd <- p_hal$data %>%
  rename(hal_est = est) %>%
  select(hal_est, X, Y, year)

ratio_df <- left_join(pyd, phd) %>% mutate(
  halibut = exp(hal_est), 
  halibut2 = ifelse(exp(hal_est) < 0.01, 0.01, exp(hal_est)), 
  yelloweye = exp(ye_est), 
  yelloweye2 = ifelse(exp(ye_est) < 0.01, 0.01, exp(ye_est)), # make min for yelloweye of 1 per km2
  ye_per_hal = (yelloweye*100) / (halibut*100), # using halibut 2 doesn't change anything.
  hal_per_ye = (halibut*100) / (yelloweye2*100)
  )

ratio_df_2020 <- filter(ratio_df, year == 2020)
```

## Ratio of yelloweye to halibut

2020 predictions

```{r message=F, echo=F}
g <- map_predictions(
  # obs_data = d_ye_plots,
  # size_aes = (catch_count / hook_count) * 100,
  # size_lab = "Halibut caught\nper 100 hooks in 2020",
  pred_data = filter(ratio_df, year == 2020),
  pred_min = 0,
  pred_max = max(ratio_df_2020$ye_per_hal),
  # pred_max = max(d_ye$catch_count, na.rm = T)/ mean(d_ye$hook_count, na.rm = T) * 100,
  fill_aes = ye_per_hal, fill_lab = "Yelloweye to Halibut\nbiomass ratio"
)
g

dir.create("figs", showWarnings = FALSE)
ggsave("figs/hybrid-ye-to-halibut-2020-w-hal-catch-new-RW-hbll-ests-w-mud-rock.png", width = 5.5, height = 6, dpi = 400)
# ggsave("figs/hybrid-ye-to-halibut-2020-w-hal-catch-S.pdf", width = 5.5, height = 6, dpi = 400)
```

## Ratio of halibut to yelloweye

2020 predictions

```{r message=F, echo=F}
g <- map_predictions(
  pred_data = filter(ratio_df, year == 2020),
  # obs_data = filter(d_hal, year %in% c(2018, 2019,2020)),
  # size_aes = density,
  # size_lab = "Halibut caught\nper 100 hooks",
  pred_min = 0,
  pred_max = max(ratio_df_2020$hal_per_ye, na.rm = T),
  # viridis_dir = -1,
  # viridis_na = "black", 
  # viridis_option = "B",
  fill_aes = hal_per_ye, 
  fill_lab = "Halibut to yelloweye\nbiomass ratio"
)
g

dir.create("figs", showWarnings = FALSE)
ggsave("figs/hybrid-halibut-to-ye-2020-w-hal-catch-new-RW-hbll-ests-w-mud-rock.png", width = 5.5, height = 6, dpi = 400)
# ggsave("figs/hybrid-halibut-to-ye-2020-w-hal-catch-S.pdf", width = 5.5, height = 6, dpi = 400)
```


# Other exploratory plots


### Experiment with accumulation curve
Solid lines are cumulative halibut catch potential for each addition cell fished in decreasing order of predicted halibut abundance.
Dashed lines are the cumulative yelloweye catch that might be anticipated for those same cells.
```{r message=F, echo=F, warning=F}
p_hal_cda <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-predictions-cda.rds")
p_ye_cda <- readRDS("data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-predictions-cda.rds")

p_hal_noncda <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-predictions-3CD-outside-cda.rds")
p_ye_noncda <- readRDS("data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-predictions-3CD-outside-cda.rds")

p_hal_5A <- readRDS("data-generated/hybrid-halibut-new-RW-hbll-ests-w-mud-rock-predictions-5A.rds")
p_ye_5A <- readRDS("data-generated/hybrid-yelloweye-new-RW-hbll-ests-w-mud-rock-predictions-5A.rds")

py_cda <- p_ye_cda$data %>% rename(ye_est = est)
py_noncda <- p_ye_noncda$data %>% rename(ye_est = est)
py_5A <- p_ye_5A$data %>% rename(ye_est = est)

ph_cda <- p_hal_cda$data %>%
  rename(hal_est = est) %>%
  select(hal_est, X, Y, year)
ph_noncda <- p_hal_noncda$data %>%
  rename(hal_est = est) %>%
  select(hal_est, X, Y, year)
ph_5A <- p_hal_5A$data %>% #View()
  rename(hal_est = est) %>%
  select(hal_est, X, Y, year)


# round(density * (100 * 0.0024384 * 0.009144 * 10000) / yemeanweight)
ratio_cda <- left_join(py_cda, ph_cda) %>% mutate(
  halibut = exp(hal_est) * (100 * 0.0024384 * 0.009144 * 10000)*1.33 , # convert kg/ha to kg/100 hooks
  yelloweye = exp(ye_est) * (100 * 0.0024384 * 0.009144 * 10000), # convert kg/ha to kg/100 hooks
  ye_per_hal = yelloweye / halibut, hal_per_ye = halibut / yelloweye,
  pair_name = case_when(
        year %in% c(2007, 2008) ~ "2007-2008",
        year %in% c(2009, 2010) ~ "2009-2010",
        year %in% c(2011, 2012) ~ "2011-2012",
        year %in% c(2013, 2014) ~ "2013-2014",
        year %in% c(2015, 2016) ~ "2015-2016",
        year %in% c(2017, 2018) ~ "2017-2018",
        year %in% c(2019, 2020) ~ "2019-2020"
      )
)
ratio_noncda <- left_join(py_noncda, ph_noncda) %>% mutate(
  halibut = exp(hal_est)* (100 * 0.0024384 * 0.009144 * 10000)*1.33 , # convert kg/ha to kg/100 hooks
  yelloweye = exp(ye_est)* (100 * 0.0024384 * 0.009144 * 10000), # convert kg/ha to kg/100 hooks
  ye_per_hal = yelloweye / halibut, hal_per_ye = halibut / yelloweye,
  pair_name = case_when(
        year %in% c(2007, 2008) ~ "2007-2008",
        year %in% c(2009, 2010) ~ "2009-2010",
        year %in% c(2011, 2012) ~ "2011-2012",
        year %in% c(2013, 2014) ~ "2013-2014",
        year %in% c(2015, 2016) ~ "2015-2016",
        year %in% c(2017, 2018) ~ "2017-2018",
        year %in% c(2019, 2020) ~ "2019-2020"
      )
)

ratio_cda <- ratio_cda[order(ratio_cda$halibut, decreasing = T), ] %>% group_by(year) %>% 
  mutate(ordered = 1:n(), 
    hal_cumsum = cumsum(halibut), 
    ye_cumsum = cumsum(yelloweye),
    cumsum_ye_hal = ye_cumsum/hal_cumsum
    ) %>% ungroup()

ratio_noncda <- ratio_noncda[order(ratio_noncda$halibut, decreasing = T), ] %>% group_by(year) %>% 
  mutate(ordered = 1:n(),
    hal_cumsum = cumsum(halibut), 
    ye_cumsum = cumsum(yelloweye),
    cumsum_ye_hal = ye_cumsum/hal_cumsum
    ) %>% ungroup()


target_catch <- 1500

target_noncda <- ratio_noncda %>% filter (hal_cumsum > target_catch) %>% group_by(year) %>% mutate(cells_for_target = min(ordered), ye_total = min(ye_cumsum)) %>% select(year, cells_for_target, ye_total) %>% distinct()

target_cda <- ratio_cda %>% filter (hal_cumsum > target_catch) %>% group_by(year) %>% mutate(cells_for_target = min(ordered), ye_total = min(ye_cumsum)) %>% select(year, cells_for_target, ye_total) %>% distinct()

ggplot() +
  geom_line(data = ratio_noncda, 
    aes(x = ordered, y = hal_cumsum, lty = "dotted", colour = "darkblue"), size = 1,
    inherit.aes = FALSE) +
  geom_line(data = ratio_noncda, 
    aes(x = ordered, y = ye_cumsum, lty = "solid", colour = "darkblue"), size = 1,
    inherit.aes = FALSE) +
  geom_segment(data = target_noncda, 
    aes(x = cells_for_target, xend = cells_for_target, y = ye_total, yend= target_catch, 
      lty = "dotted", colour = "darkblue"), size = 0.5, inherit.aes = FALSE) +
  geom_hline(data = target_noncda, 
    aes(yintercept = ye_total, lty = "solid", colour = "darkblue"), size = 0.5,
    inherit.aes = FALSE) +
  
  geom_line(data = ratio_cda, 
    aes(x = ordered, y = hal_cumsum, lty = "dotted", colour = "red"), size = 1, 
    inherit.aes = FALSE) +
  geom_line(data = ratio_cda, 
    aes(x = ordered, y = ye_cumsum, lty = "solid", colour = "red"), size = 1, 
    inherit.aes = FALSE) +
  geom_segment(data = target_cda, 
    aes(x = cells_for_target, xend = cells_for_target, y = ye_total, yend= target_catch, 
      lty = "dotted", colour = "red"), size = 0.5, inherit.aes = FALSE) +
  geom_hline(data = target_cda, 
    aes(yintercept = ye_total, lty = "solid", colour = "red"), size = 0.5,
    inherit.aes = FALSE) +
  
  coord_cartesian(expand = F, xlim = c(0, 200), ylim = c(0, target_catch )) +
  scale_color_identity(name = "Area",
                          breaks = c("darkblue", "red"),
                          labels = c("3CD (non-CDA)", "CDA"),
                          guide = "legend") +
  scale_linetype_identity(name = "Species",
                          breaks = c("solid", "dotted"),
                          labels = c("YE","Halibut"),
                          guide = "legend") +
  facet_wrap(~year, ncol = 2)+
  ylab("Cummulative fish biomass (kg if 100 hooks set in each cell)") +
  xlab("Number of cells fished (in order of decreasing Halibut abundance)") + 
  theme(legend.position = c(0.65, 0.1))

ggsave("cummulative-catch-rates-x-new-RW-hbll-ests-w-mud-rock.png", width = 7, height = 9)
```

```{r}
target_cda 
```

```{r}
target_noncda 
```

```{r}
ggplot(target_noncda,  aes(year, ye_total)) + 
  geom_line(colour = "darkblue") + 
  geom_point(aes(size = cells_for_target, colour = "darkblue")) +
  geom_line(data = target_cda,  aes(year, ye_total, colour = "red")) +
  geom_point(data = target_cda, aes(size = cells_for_target, colour = "red")) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  scale_size_continuous("Number of\ncells fished") +
  scale_color_identity(name = "Area",
                          breaks = c("darkblue", "red"),
                          labels = c("3CD (non-CDA)", "CDA"),
                          guide = "legend") +
  xlab("Year") +
  ylab("Expected catch of YE") + 
  ggtitle("If 1500 kg of Halibut were targeted using 100 hooks per cell...")

ggsave("expected_YE_RW-hbll-ests-w-mud-rock.png", width = 6.5, height = 4)
```


# Investigate weights of yelloweye caught

### Is there an overall trend in fish size through time?

```{r message=F, echo=F}
# load biological sample data
yesampledata <- readRDS("data/yelloweye-surv-samples-all.rds") %>% filter(survey_abbrev == "HBLL OUT S")

# calculate mean weights for all of HBLL S
yemeanweights <- yesampledata %>%
  filter(!is.na(weight)) %>%
  group_by(year) %>%
  summarise(
    mean_weight = mean(weight / 1000, na.rm = T),
    upr_ci = Rmisc::CI(weight / 1000, ci = 0.95)[1], lwr_ci = Rmisc::CI(weight / 1000, ci = 0.95)[3],
    upr_weight = quantile(weight / 1000, 0.975), lwr_weight = quantile(weight / 1000, 0.025),
    n = n()
  )

# plot mean weights through time for whole HBLL
ggplot(yemeanweights) + geom_path(aes(year, mean_weight)) + ylim(0, 6) +
  geom_ribbon(aes(year, mean_weight, ymax = upr_weight, ymin = lwr_weight), alpha = 0.2) +
  geom_linerange(aes(year, ymax = upr_ci, ymin = lwr_ci), size = 1) +
  scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  ylab("Individual Fish Weights (kg)") + xlab("Year") +
  ggtitle("Mean and 95th percentile range for Yelloweye Rockfish caught on HBLL S")
ggsave("figs/annual_yelloweye_weights.png", width = 4, height = 4)
```


### Does the annual distribution of fish weights differ within the CDA?

```{r message=F, echo=F, warning=F}
# get the fishing events that occurred within CDA
d_ye_sf <- st_as_sf(d_ye, coords = c("longitude", "latitude"))
st_crs(d_ye_sf) <- 4326 # set the coordinate reference system
d_ye_intersected <- sf::st_intersects(d_ye_sf, focal_area)
cda_ye_sf <- d_ye_sf[which(lengths(d_ye_intersected) > 0), ]
noncda_ye_sf <- d_ye_sf[which(lengths(d_ye_intersected) == 0), ]

cda_ye_ids <- cda_ye_sf
st_geometry(cda_ye_ids) <- NULL
cda_ye_ids <- cda_ye_ids %>%
  select(fishing_event_id, year, catch_count) %>%
  distinct() # keep catch count for comparison with sample totals

# make dataframe of just samples from the CDA and calculate tallies of events, total catch, sampled weights and total catch/events
cda_ye_samples <- inner_join(cda_ye_ids, yesampledata) %>%
  group_by(year) %>%
  mutate(cda_weights = n())
cda_ye_catch <- cda_ye_ids %>%
  group_by(year) %>%
  summarise(cda_catch = sum(catch_count))
cda_ye_sample_sum <- cda_ye_samples %>%
  select(year, cda_weights) %>%
  distinct()
cda_events <- cda_ye_ids %>%
  group_by(year) %>%
  summarise(cda_events = n())
cda_sampling <- left_join(cda_events, cda_ye_catch) %>%
  left_join(cda_ye_sample_sum) %>%
  mutate(catch_rate = round(cda_catch / cda_events, 1))

# plot CDA weights against overall distribution for HBLL S
ggplot(yesampledata) +
  geom_violin(aes(as.factor(year), weight / 1000), alpha = 0.2, scale = "count", colour = "black", fill = "grey") +
  # geom_violin(data = cda_ye_samples, aes(as.factor(year), weight/1000), alpha = 0.9, scale = "count", colour = "red", fill = "red", adjust = 1/5) +
  geom_point(data = cda_ye_samples, aes(as.factor(year), weight / 1000), alpha = 0.7, colour = "red", fill = "red") +
  geom_linerange(data = yemeanweights, aes(as.factor(year), ymax = upr_ci, ymin = lwr_ci), size = 5) +
  ylab("Individual Fish Weights (kg)") + xlab("") +
  ggtitle("Annual distributions of Yelloweye Rockfish weights (all HBLL S = black; within CDA = red)")
ggsave("figs/yelloweye_weights.png", width = 5, height = 3.5)
```


### How spatially variable are mean weigths through time for whole HBLL S?

```{r message=F, echo=F, warning=F}
# calculate the mean weights from each fishing event
yeeventweights <- yesampledata %>%
  filter(!is.na(weight)) %>%
  group_by(year, fishing_event_id) %>%
  summarise(
    mean_weight = mean(weight / 1000, na.rm = T),
    upr_ci = Rmisc::CI(weight / 1000, ci = 0.95)[1], lwr_ci = Rmisc::CI(weight / 1000, ci = 0.95)[3],
    upr_weight = quantile(weight / 1000, 0.975), lwr_weight = quantile(weight / 1000, 0.025),
    n = n()
  ) %>%
  filter(n > 10) # filter for fishing events with at least 10 fish measured

ggplot(yeeventweights) +
  geom_violin(aes(as.factor(year), mean_weight), alpha = 0.2, scale = "count", colour = "black", fill = "grey") +
  geom_linerange(data = yemeanweights, aes(as.factor(year), ymax = upr_ci, ymin = lwr_ci), size = 3) +
  ylab("Mean Weight (kg)") + xlab("") +
  ggtitle("Annual mean and variability in Yelloweye Rockfish weights", subtitle = "for events with > 10 fish sampled")
ggsave("figs/yelloweye_event_weights.png", width = 6, height = 4.5)
```


```{r message=F, echo=F, warning=F, include=F}
yeeventweights1 <- yesampledata %>%
  filter(!is.na(weight)) %>%
  group_by(year, fishing_event_id) %>%
  summarise(
    mean_weight = mean(weight / 1000, na.rm = T),
    med_weight = median(weight / 1000, na.rm = T),
    upr_ci = Rmisc::CI(weight / 1000, ci = 0.95)[1], lwr_ci = Rmisc::CI(weight / 1000, ci = 0.95)[3],
    upr_weight = quantile(weight / 1000, 0.975), lwr_weight = quantile(weight / 1000, 0.025),
    n = n()
  ) %>%
  filter(n > 1)

# ggplot(yeeventweights1) +
#   geom_col(aes(med_weight, n), size = 2, colour = "grey") +
#   # geom_linerange(data = yemeanweights, aes(as.factor(year), ymax = upr_ci, ymin = lwr_ci), size = 3) +
#   ylab("Number of fish sampled") + xlab("Median weight of fish sampled (kg)") +
#   # facet_wrap(~year) +
#   ggtitle("")

ggplot(yeeventweights1) +
  geom_col(aes(mean_weight, n), size = 2, colour = "grey") +
  scale_x_continuous(0, max(yeeventweights1$mean_weight)) +
  ylab("Number of fish sampled") + xlab("Mean weight of fish sampled (kg)") +
  ggtitle("Variability in mean fish weight between fishing events")
```
