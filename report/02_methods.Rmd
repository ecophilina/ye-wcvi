# Methods {#sec:methods}

We used data collected on the southern outside Hard Bottom Longline survey (HBLL) and the synoptic bottom trawl survey to estimate the spatial and temporal variation in expected catches of YE and halibut.
The HBLL survey focuses on rockfish habitats, rather than the broader range of habitats and depths that halibut occupy.
This survey is usually conducted in alternating years, except that no survey occurred in 2012 and 2013.
The synoptic trawl surveys sample soft-bottom habitats, but use trawl gear and record biomass densities, rather than fish counts as on the HBLL.
Two trawl surveys overlap spatially with the HBLL: the southern portion with the West Coast Vancouver Island Synoptic Survey conducted in even years (except 2020 due to the COVID-19 pandemic), and the northern portion with the Queen Charlotte Sound Synoptic Survey conducted in odd years.
To join, or "stitch", these three surveys together and produce estimates of local variation in biomass density, we pooled odd and even year pairs and converted the catch counts from the HBLL into biomass densities.

To incorporate observations from both survey types into one model, the observations needed to be converted into comparable units.
For YE, we converted HBLL catch counts to biomass using an estimate of mean fish weight (all fish measured across all years on this survey).
For halibut, individual fish weights or lengths were not collected and fish smaller than 81.3 cm cannot be kept, so HBLL catch counts were converted to a landable biomass density by multiplying counts by the average total landed biomass per fish caught.
These biomass estimates for HBLL catch were further divided by the "area swept" calculation of hook count $\times$ a hook spacing of 0.0024384 km (8 ft) $\times$ an assumed catch radius of 0.009144 km (30 ft).
For the trawl survey halibut biomass, the estimated densities were multiplied by the proportion of biomass caught that belonged to landable individuals at the set-level, where at least 10 fish, or greater than 70% by weight of the total catch, were measured.
In cases where these criteria were not met, we used the global mean across all sets.
<!-- YE biomass densities from the trawl survey were left unadjusted because -->
For YE, the mean weights per fish were nearly identical between the two surveys (synoptic surveys = `r round(yemeanweightSYN, 2)` kg; HBLL = `r round(yemeanweightHBLL, 2)` kg).
<!-- Finally, all densities were converted from kg per kg/km2 to kg per ha for computational reasons. -->

Next, we fit geostatistical spatiotemporal models to these surveyed biomass densities using the R package sdmTMB <https://github.com/pbs-assess/sdmTMB>.
Because these biomass densities include both zeros and positive continuous values, we used either a Tweedie distribution or a delta-Gamma (a binomial distribution for presence-absence and a Gamma distribution for the positive component) approach to model predicted catches of each species.
We did not account for hook competition in any of these models because the goal here was to estimate likely catch ratios and not the underlying abundances.
Furthermore, an investigation into hook competition for YE in the latest outside YE stock assessment found little effect of accounting for it [REF].
For both species, we included quadratic effects of depth, and the proportions of rocky and muddy substrate within 1 km of the sampling location, to help account for difference in the habitats targeted by each survey.
We included a factor for survey type to capture differences in catchability between the two fishing methods.
These models also estimated annual means for years and latent "random fields" representing remaining patterns in spatial and spatiotemporal correlation that were not explicitly modelled by the included covariates.
The magnitude of spatiotemporal variation was much higher for halibut than for YE, but including spatiotemporal variation improved model fit compared to a model with only spatial random fields for both species by over 10 AIC (Akaike Information Criterion) units.
Allowing for anisotropy improved the delta AIC (>10) for the YE model, but interfered with estimatation of spatiotemporal fields for the halibut models.
For YE, the Tweedie model fit the data well (Fig. \@ref(fig:qq-ye)), while for landable halibut the delta-Gamma models fit better than the Tweedie (Fig. \@ref(fig:qq-hal)).
<!-- For Halibut, including a first-order autoregressive (AR1) correlation between spatiotemporal fields only marginally improved model fit (~5 $\Delta$ AIC), so we used independent spatiotemporal fields for both species. -->
  <!-- SA: add equations?-->

We also built models based on just the HBLL data to confirm that stitching the HBLL and synoptic surveys was still representative of the HBLL survey results.
For this count-based model, we used a negative binomial observation likelihood ('NB2') with a log link and an an offset for the number of hooks.
This means we modelled fish caught per hook, but with a statistical approach that let us use a count distribution.
The NB2 distribution lets the observation variance scale quadratically with the mean, which is typically needed for ecological data.
This model also includes a quadratic effect of depth but no substrate habitat variables.

For YE, we modelled biomass density $D$ for point in space $s$ and time $t$ as
\begin{align}
  D_{s,t} &\sim \operatorname{Tweedie} \left(\mu_{s,t}, p, \phi \right), \: 1 < p < 2\ ,
\end{align}
where $\mu_{s,t}$ represents the expected (mean) value, $p$ represents the Tweedie power parameter, and $\phi$ represents the Tweedie dispersion parameter. We modelled $\mu_{s,t}$ as a function of a series of fixed and random effects and a log link:
\begin{align}
  \mu_{s,t} &= \exp 
  \left(\alpha_t + \bm{X}_{s,t} \bm{\beta} + \omega_s + \epsilon_{s,t} \right),\\
  \bm{\omega} &\sim \operatorname{MVNormal} \left( \bm{0}, \bm{\Sigma}_\omega \right),\\
  \bm{\epsilon}_t &\sim \operatorname{MVNormal} \left( \bm{0}, \bm{\Sigma}_{\epsilon} \right),
\end{align}
where $\alpha_t$ represents a mean for each year, $\bm{X}_{s,t}$ represents a vector of predictors (survey ID, depth, depth squared, and a spline [with a basis dimension of 3] for proportion rocky and proportion muddy), and $\bm{\beta}$ represents a vector of corresponding parameters.
The symbol $\omega_s$ represents spatially correlated random effects that are constant through time, which are assumed to follow a multivariate normal distribution with covariance matrix $\bm{\Sigma}_\omega$ (a "random field").
This covariance matrix is constrained via the Matérn covariance function.
The symbol $\epsilon_{s,t}$ represents spatially correlated random effects that are independent each year (spatiotemporal random effects), similarly constrained by multivariate normal distribution with covariance matrix $\bm{\Sigma}_{\epsilon}$ and a Matérn covariance function.

Our halibut model followed the same form as the YE model, but modelled biomass density as a product of two component models:

\begin{align}
  D_{s,t} &\sim 
  \operatorname{Bernoulli} \left( \varphi_{s,t} \right) \cdot
    \operatorname{Gamma} \left( \vartheta, \frac{\mu_{2,s,t}}{\vartheta} \right),
\end{align}

where $\varphi_{s,t}$ represents the expected probability of catching any halibut in a given observation, $\mu_{2,s,t}$ represents the expected value conditional on a positive observation and $\vartheta$ represents the Gamma distribution shape parameter ($\mu_{s,t} / \vartheta$ represents the Gamma scale).
These two components are modelled with logit and log links with a form similar to the YE model:

\begin{align}
  \varphi_{s,t} &= \operatorname{logit}^{-1} 
  \left(\alpha_{1,t} + \bm{X}_{1,s,t} \bm{\beta_1} + \omega_{1,s} + \epsilon_{1,s,t} \right),\\
    \mu_{2,s,t} &= \exp 
  \left(\alpha_{2,t} + \bm{X}_{2,s,t} \bm{\beta_2} + \omega_{2,s} + \epsilon_{2,s,t} \right).
\end{align}

The symbols have the same meaning as in the YE equations, but the subscript 1 and 2 denote the equivalent parameters from the first (Bernoulli) and second (Gamma) component models.

<!-- Philina, can you break up and clarify this next sentence? -->
We calculated expected biomass densities, if sampled using HBLL gear, but for the larger area encompassing the both trawl and HBLL survey areas, depths between 20 and 1000 m (those covered in either survey), and excluding Rockfish Conservation Areas (RCAs) where fishing is prohibited.
For halibut, this was an estimate of landable biomass, while for YE it was for total catchable biomass.
<!-- These estimates were then used to produce maps of expected biomass distributions for each species, as well as the spatial distribution of expected catch ratios between these species. -->
These expected densities were multiplied by the area of water within survey grid cells (2 x 2 km), and adjacent portions of cells where part fell inside RCAs, to produce overall biomass indices and overall average biomass ratios for different subregions (within the CDA vs. Area 3CD5A outside the CDA and Area 3CD5A north of 50º vs. Area 3CD5A south of 50º and outside the CDA; Fig. \@ref(fig:region-col-key)).
Splitting at 50º separates the areas adjacent to the CDA from those not adjacent, as well as accounting for potential ecological or latitudinal variation implied by a positive correlation between HBLL catch counts of halibut and YE in the south, but not in the north (Fig. \@ref(fig:hbll-catch)).

Specifically, we calculated biomass $B_t$ (or abundance) indexes for each biennial year combination $t$ by summing the predicted biomass in every grid cell $j$ (1 through $n_j$) weighted by the cell area ($w_j$):

\begin{equation}
\label{eq:Bt}
B_t = \sum_{j = 1}^{n_j} w_j  D_{j,t}.
\end{equation}

We fit our models in R version 4.1.1 [@R2021] with the R package sdmTMB [@anderson2019synopsis; @sdmTMB] version 0.0.18.9000, which combines automatic differentiation and the Laplace approximation from the TMB (Template Model Builder) R package [@kristensen2016] with the SPDE (Stochastic Partial Differential Equation) approximation to Gaussian Markov fields from the INLA R package [@rue2009].
sdmTMB carries out optimization using the non-linear minimization function `nlminb` in R and finds the value of the fixed effects that minimizes the marginal negative log likelihood.
We confirmed the models were consistent with convergence by checking that the Hessian matrix was positive definite and the maximum absolute gradient across fixed effects was $< 0.005$.

We derived uncertainty on the predictions for each grid cell ($D_{j,t}$) by simulating 500 draws from the estimated (multivariate normal) joint precision matrix. We then used these draws to calculate uncertainty on the biomass estimates $B_t$ (Eq. \@ref(eq:Bt)), which we summarized at specific quantiles. This approach avoids the need to account for any re-transformation bias of the random effects [e.g., as in @thorson2016a] and facilitates calculating uncertainty on derived quantites combined from multiple models such as the ratio of YE to halibut biomass.

In addition to biennial estimates of relative biomass, we used cell-specific biomass estimates to explore how contrasting fishing strategies might affect expected catch ratios for a given total area of each region.
We examined two strategies: (1) select cells in order from lowest to highest YE densities or (2) select cells with the highest to lowest halibut densities.
<!-- TODO: a bit more here about what this can show and exactly what was done? -->

```{r qq-ye, fig.cap="QQ-plot (quantile-quantile plot) of randomized quantile residuals from the YE model. Three random iterations have been overlaid.", out.width="2.5in"}
include_graphics(here("figs/ye-qq.png"))
```

```{r qq-hal, fig.cap="QQ-plots of residuals from landable halibut models using different observation distributions. The predictions from the binomial and Gamma models were combined to produce the delta-Gamma predictions.", out.width="6in"}
include_graphics(here("figs/halibut-qq.png"))
```

```{r survey-grid-map, fig.cap="Map of 2 x 2 km grid cells comprising both fishery-independent surveys used in this analysis and the Court Defined Area (CDA) outlined in red. The trawl survey area north of Vancouver Island belongs to the Queen Charlotte Sound Synoptic Survey, whereas the area west of the island is covered by the West Coast Vancouver Island Synoptic Survey. Cells within these area that are excluded from the trawl survey grid are either protected areas or have been deemed unfishable by trawl gear, often due to rockiness or the presence of corals or sponges. Light grey area underlying both survey grids forms the prediction grid used to derive indices.", out.width="5.5in"}
include_graphics(here("figs/map-stitched-grid-overlap-expanded.png"))
```

```{r region-col-key, fig.cap="Illustration of the filled-in grid and the sub-regions for which indices were calculated. Blue area is not illustrated as it is comprised of the green and purple areas combined.", out.width="4.5in"}
include_graphics(here("figs/region-colour-map-3x3-expanded.png"))
```

(ref:fig-hbll-catch) Species correlations within HBLL catch counts. Colours correspond to the sub-regions in Fig. \@ref(fig:region-col-key) except that catch within the CDA has been included in panel B.

```{r hbll-catch, fig.cap="(ref:fig-hbll-catch)", out.width="3in"}
include_graphics(here("figs/hbll-catch-correlations.png"))
```

