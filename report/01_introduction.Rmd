```{r, echo=FALSE, message=FALSE, warning=FALSE}
here::i_am("report/01_introduction.Rmd")
library(here)
library(knitr)
library(ggplot2)
library(sdmTMB)
here::dr_here()
```


# Introduction {#sec:introduction}

* Yelloweye Rockfish (YE)
* Hard Bottom Longline survey (HBLL)
* Court Defined Area (CDA)

# Methods {#sec:methods}

* We fit geostatistical spatial/spatiotemporal models using sdmTMB.

* For YE, the remaining spatiotemporal correlation was minimal and so we used a spatial model with an annual mean estimate. Spatiotemporal correlation was considerable for Halibut, and so we used a spatiotemporal model.

* We used a negative binomial observation model with a log link and an with an 'offset' for number of hooks. This means we're modelling fish caught per hook but with a statistical approach that lets us use a count distribution. The negative binomial distribution lets the observation variance scale quadratically with the mean.

* We are not accounting for hook competition currently---the outside YE assessment chose to ignore it after some analysis.

* We have many diagnostic and validation plots; they are not included here.

* We have included a quadratic effect of depth, annual means for years, and latent "random fields" for spatial and, in the case of Halibut, spatiotemporal fields. These random fields soak up remaining spatial or spatiotemporal correlation from predictors not explicitely included in the model.

# Results {#sec:results}

```{r}
i_ye_cda <- readRDS(here("data-generated/yelloweye-spatial-index-cda.rds"))
i_ye_noncda <- readRDS(here("data-generated/yelloweye-spatial-index-3CD-outside-cda.rds"))
i_ye_5A <- readRDS(here("data-generated/yelloweye-spatial-index-5A.rds"))

i_hal <- readRDS(here("data-generated/halibut-index-all-S.rds"))
i_hal_cda <- readRDS(here("data-generated/halibut-index-cda.rds"))
i_hal_noncda <- readRDS(here("data-generated/halibut-index-3CD-outside-cda.rds"))
i_hal_5A <- readRDS(here("data-generated/halibut-index-5A.rds"))

cda_grid <- readRDS(here("data-generated/cda_grid.rds"))
noncda_grid <- readRDS(here("data-generated/noncda_grid.rds"))
s_5A_grid <- readRDS(here("data-generated/s_5A_grid.rds"))
full_s_grid <- readRDS(here("data-generated/full_s_grid.rds"))
```

```{r r2-func}
r2 <- function(x) {
  sprintf("%.2f", round(x, 2))
}
```

```{r halibut-preds-all, fig.cap="Halibut across all years.", out.width="\\textwidth"}
include_graphics(here("figs/halibut-predictions-S.png"))
```

```{r halibut-preds-2020, fig.cap="Halibut in 2020.", out.width="5.5in"}
include_graphics(here("figs/halibut-2020-predictions-S.png"))
```

```{r ye-preds-2020, fig.cap="YE in 2020.", out.width="5.5in"}
include_graphics(here("figs/yelloweye-2020-predictions-S.png"))
```

```{r ye-per-hal-preds-2020, fig.cap="YE per Halibut in 2020.", out.width="5.5in"}
include_graphics(here("figs/ye-per-halibut-2020-w-hal-catch-S.png"))
```

```{r halibut-indexes, fig.cap="Halibut index of relative abundance in various regions. Lines are means and ribbons are 95\\% confidence intervals (CIs).", out.width="6in"}
include_graphics(here("figs/halibut-index-by-area.png"))
```

```{r halibut-indexes-avg, fig.cap="Average Halibut relative abundance per HBLL grid cell in CDA vs. outside CDA.", out.width="6in"}
include_graphics(here("figs/halibut-average-index-by-area.png"))
```

\clearpage

```{r filter-hal}
i_hal_cda2020 <- filter(i_hal_cda, year == 2020)
i_hal_noncda2020 <- filter(i_hal_noncda, year == 2020)
i_hal_5A2020 <- filter(i_hal_5A, year == 2020)
```

## Some calculated statistics:

Proportion of area 3CD inside CDA: `r r2(nrow(cda_grid) / (nrow(cda_grid) + nrow(noncda_grid)))`

Proportion of estimated total Halibut in 3CD expected to be inside CDA in 2020: 
`r r2(i_hal_cda2020$est / (i_hal_cda2020$est + i_hal_noncda2020$est))`

Proportion of estimated total Halibut in areas 3CD + 5A expected to be inside CDA:
`r r2(i_hal_cda2020$est / (i_hal_cda2020$est + i_hal_noncda2020$est + i_hal_5A2020$est))`

Average estimated Halibut caught per 100 hooks inside CDA in 2020:
`r r2(i_hal_cda2020$est / nrow(cda_grid))`

Average estimated Halibut caught per 100 hooks in area 3CD outside CDA in 2020:
`r r2(i_hal_noncda2020$est / nrow(noncda_grid))`

Average estimated Halibut caught per 100 hooks in areas 3CD + 5A (outside CDA):
`r r2((i_hal_noncda2020$est + i_hal_5A2020$est) / (nrow(noncda_grid) + nrow(s_5A_grid)))`


Proportion of estimated YE in area 3CD expected to be inside CDA:
`r r2(i_ye_cda$est / (i_ye_cda$est + i_ye_noncda$est))`

Proportion of estimated YE in areas 3CD + 5A expected to be inside CDA:
`r r2(i_ye_cda$est / (i_ye_cda$est + i_ye_noncda$est + i_ye_5A$est))`


Average estimated YE caught per 100 hooks inside CDA:
`r r2(i_ye_cda$est / nrow(cda_grid))`

Average estimated YE caught per 100 hooks in area 3CD outside CDA:
`r r2(i_ye_noncda$est / nrow(noncda_grid))`

Average estimated YE caught per 100 hooks in areas 3CD + 5A (outside CDA):
`r r2((i_ye_noncda$est + i_ye_5A$est) / (nrow(noncda_grid) + nrow(s_5A_grid)))`



# Discussion

* We can add static covariates like bottom type, that would create more local-scale resolution (but unlikely to change the overall calculations).

* We haven't presented uncertainty on the inside vs. outside CDA ratios; this is possible but would require some more work.

* Note that we're only including the HBLL grid within the various boundaries. We could try extrapolating to the full management areas, but at the very least we'd want a habitate type covariate.
