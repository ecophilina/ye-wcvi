```{r, echo=FALSE, message=FALSE, warning=FALSE}
here::i_am("report/01_introduction.Rmd")
library(here)
library(knitr)
library(ggplot2)
library(sdmTMB)
here::dr_here()
```


# Introduction {#sec:introduction}

* Yelloweye Rockfish (YE)
* Hard Bottom Longline survey (HBLL)
* Court Defined Area (CDA)

# Methods {#sec:methods}

* We fit geostatistical spatial/spatiotemporal models using the R package sdmTMB <https://github.com/pbs-assess/sdmTMB>.

* For YE, the spatiotemporal correlation was minimal and so we used a spatial model with annual mean parameters. Spatiotemporal correlation was considerable for Halibut, and so we used a spatiotemporal model. Our Halibut model is very similar to the model used by the IPHC for index standardization.

* We used a negative binomial observation model with a log link and an an 'offset' for number of hooks. This means we are modelling fish caught per hook but with a statistical approach that lets us use a count distribution. The negative binomial distribution lets the observation variance scale quadratically with the mean, which is typically needed for this type of data.

* We are not accounting for hook competition currently---the outside YE assessment chose to ignore it after some analysis. This could be included.

* We have many diagnostic and validation plots; they are not included here.

* We have included a quadratic effect of depth, annual means for years, and latent "random fields" for spatial and, in the case of Halibut, spatiotemporal fields. These random fields soak up remaining spatial or spatiotemporal correlation from predictors not explicitly included in the model.

* We then calculate expected fish caught for HBLL grid cells in a particular region for a given constant number of hooks and sum these values to come up with an expected number for an entire region.

# Results {#sec:results}

```{r}
i_ye_cda <- readRDS(here("data-generated/yelloweye-spatial-index-cda.rds"))
i_ye_noncda <- readRDS(here("data-generated/yelloweye-spatial-index-3CD-outside-cda.rds"))
i_ye_5A <- readRDS(here("data-generated/yelloweye-spatial-index-5A.rds"))

i_hal <- readRDS(here("data-generated/halibut-index-all-S.rds"))
i_hal_cda <- readRDS(here("data-generated/halibut-index-cda.rds"))
i_hal_noncda <- readRDS(here("data-generated/halibut-index-3CD-outside-cda.rds"))
i_hal_5A <- readRDS(here("data-generated/halibut-index-5A.rds"))

cda_grid <- readRDS(here("data-generated/cda_grid.rds"))
noncda_grid <- readRDS(here("data-generated/noncda_grid.rds"))
s_5A_grid <- readRDS(here("data-generated/s_5A_grid.rds"))
full_s_grid <- readRDS(here("data-generated/full_s_grid.rds"))
```

```{r r2-func}
r2 <- function(x) {
  sprintf("%.2f", round(x, 2))
}
```

```{r halibut-preds-all, fig.cap="Observed (circle area) and predicted (colour) Halibut in the HBLL survey per 100 hooks across all years. The CDA is outlined in red. Note that the colour axis in fourth-root transformed to improve visual interpretation.", out.width="\\textwidth"}
include_graphics(here("figs/halibut-predictions-S.png"))
```

```{r ye-preds-all, fig.cap="Observed (circle area) and predicted (colour) Yelloweye Rockfish in the HBLL survey per 100 hooks across all years. The CDA is outlined in red. Note that the colour axis in fourth-root transformed to improve visual interpretation. The spatial distribution is assumed constant across years right now, but the mean is allowed to change through time (it is relatively constant).", out.width="\\textwidth"}
include_graphics(here("figs/ye-predictions-S.png"))
```

```{r halibut-preds-2020, fig.cap="Halibut in 2020. This is a zoomed in version of just 2020.", out.width="5.5in"}
include_graphics(here("figs/halibut-2020-predictions-S.png"))
```

```{r ye-preds-2020, fig.cap="Yelloweye Rockfish in 2020. Legend otherwise the same.", out.width="5.5in"}
include_graphics(here("figs/yelloweye-2020-predictions-S.png"))
```

```{r ye-per-hal-preds-2020, fig.cap="YE per Halibut in 2020. Note that the circles represent the number of halibut caught and so are a different data type from the predictions.", out.width="5.5in"}
include_graphics(here("figs/ye-per-halibut-2020-w-hal-catch-S.png"))
```

```{r halibut-indexes, fig.cap="Halibut index of relative abundance in HBLL grid cells within various regions. Lines are means and ribbons are 95\\% confidence intervals (CIs). We could do the same for YE and YE/Halibut if needed.", out.width="6in"}
include_graphics(here("figs/halibut-index-by-area.png"))
```

```{r halibut-indexes-avg, fig.cap="Average Halibut relative abundance per HBLL grid cell in CDA vs. in area 3CD but outside CDA. Again, could be done for YE and YE/Halibut.", out.width="6in"}
include_graphics(here("figs/halibut-average-index-by-area.png"))
```

\clearpage

```{r filter-hal}
i_hal_cda2020 <- filter(i_hal_cda, year == 2020)
i_hal_noncda2020 <- filter(i_hal_noncda, year == 2020)
i_hal_5A2020 <- filter(i_hal_5A, year == 2020)
```

## Some calculated statistics:

All values are for only those 2x2 km grid cells included in the HBLL surveys.


Proportion of HBLL grid cells inside area 3CD that are also inside the CDA: `r r2(nrow(cda_grid) / (nrow(cda_grid) + nrow(noncda_grid)))`

Proportion of estimated total Halibut from HBLL grid cells in **Area 3CD** expected to be inside CDA in 2020: 
`r r2(i_hal_cda2020$est / (i_hal_cda2020$est + i_hal_noncda2020$est))`

Proportion of estimated total Halibut from HBLL grid cells in **Areas 3CD + 5A** expected to be inside CDA:
`r r2(i_hal_cda2020$est / (i_hal_cda2020$est + i_hal_noncda2020$est + i_hal_5A2020$est))`

Average estimated Halibut caught per 100 hooks inside CDA in 2020:
`r r2(i_hal_cda2020$est / nrow(cda_grid))`

Average estimated Halibut caught per 100 hooks in **Area 3CD** outside CDA in 2020:
`r r2(i_hal_noncda2020$est / nrow(noncda_grid))`

Average estimated Halibut caught per 100 hooks in **Areas 3CD + 5A** in 2020 (outside CDA):
`r r2((i_hal_noncda2020$est + i_hal_5A2020$est) / (nrow(noncda_grid) + nrow(s_5A_grid)))`


Proportion of estimated YE from HBLL grid cells in **Area 3CD** expected to be inside CDA:
`r r2(i_ye_cda$est / (i_ye_cda$est + i_ye_noncda$est))`

Proportion of estimated YE from HBLL grid cells in **Areas 3CD + 5A** expected to be inside CDA:
`r r2(i_ye_cda$est / (i_ye_cda$est + i_ye_noncda$est + i_ye_5A$est))`


Average estimated YE caught per 100 hooks inside CDA:
`r r2(i_ye_cda$est / nrow(cda_grid))`

Average estimated YE caught per 100 hooks in **Area 3CD** outside CDA:
`r r2(i_ye_noncda$est / nrow(noncda_grid))`

Average estimated YE caught per 100 hooks in **Areas 3CD + 5A** (outside CDA):
`r r2((i_ye_noncda$est + i_ye_5A$est) / (nrow(noncda_grid) + nrow(s_5A_grid)))`



# Discussion

* We can add static covariates like bottom type. We expect this would create more fine-scale spatial resolution to the predictions, but is unlikely to change the overall calculations qualitatively.

* We have not presented uncertainty on the inside vs. outside CDA ratios; this is possible but would require additional work.

* Note that we're only including the HBLL grid within the various boundaries. We could try extrapolating to the full management areas, but at the very least we'd want a habitate type covariate.
