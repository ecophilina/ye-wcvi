```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(here)
library(knitr)
library(ggplot2)
library(sdmTMB)
here::dr_here()
```


# Introduction {#sec:introduction}

Yelloweye Rockfish (YE)

# Methods {#sec:methods}

* We fit geostatistical spatial/spatiotemporal models using sdmTMB.

* Remaining spatiotemporal correlation was minimal and so we used a spatial model for YE with an annual mean estimate. Spatiotemporal correlation was considerable for Halibut, and so we used a spatiotemporal model.

* We used a negative binomial observation model with a log link and an with an 'offset' for number of hooks. This means we're modelling fish caught per hook but with a statistical approach that lets us use a count distribution. The negative binomial distribution lets the observation variance scale quadratically with the mean.

* We are not accounting for hook competition currently---the outside YE assessment chose to ignore it after some analysis.

* We have many diagnostic and validation plots; they are not included here.

* We have included a quadratic effect of depth, annual means for years, and latent "random fields" for spatial and, in the case of Halibut, spatiotemporal fields. These random fields soak up remaining spatial or spatiotemporal correlation from predictors not explicitely included in the model.

# Results {#sec:results}

```{r}
i_ye_cda <- readRDS(here("data-generated/yelloweye-spatial-index-cda.rds"))
i_ye_noncda <- readRDS(here("data-generated/yelloweye-spatial-index-3CD-outside-cda.rds"))
i_hal <- readRDS(here("data-generated/halibut-index-all-S.rds"))
i_hal_cda <- readRDS(here("data-generated/halibut-index-cda.rds"))
i_hal_noncda <- readRDS(here("data-generated/halibut-index-3CD-outside-cda.rds"))
i_hal_5A <- readRDS(here("data-generated/halibut-index-5A.rds"))
cda_grid <- readRDS(here("data-generated/cda_grid.rds"))
noncda_grid <- readRDS(here("data-generated/noncda_grid.rds"))
```

```{r r2-func}
r2 <- function(x) {
  sprintf("%.2f", round(x, 2))
}
```

```{r halibut-preds-all, fig.cap="Caption here", out.width="\\textwidth"}
include_graphics(here("figs/halibut-predictions-S.png"))
```

```{r halibut-preds-2020, fig.cap="Caption here", out.width="5.5in"}
include_graphics(here("figs/halibut-2020-predictions-S.png"))
```

```{r ye-preds-2020, fig.cap="Caption here", out.width="5.5in"}
include_graphics(here("figs/yelloweye-2020-predictions-S.png"))
```

```{r ye-per-hal-preds-2020, fig.cap="Caption here", out.width="5.5in"}
include_graphics(here("figs/ye-per-halibut-2020-w-hal-catch-S.png"))
```

```{r halibut-indexes, fig.cap="Caption here", out.width="6in"}
include_graphics(here("figs/halibut-index-by-area.png"))
```

```{r halibut-indexes-avg, fig.cap="Caption here", out.width="6in"}
include_graphics(here("figs/halibut-average-index-by-area.png"))
```

\clearpage

```{r filter-hal}
i_hal_cda2020 <- filter(i_hal_cda, year == 2020)
i_hal_noncda2020 <- filter(i_hal_noncda, year == 2020)
```

## Some calculated statistics:

Proportion of HBLL grid inside CDA: `r r2(nrow(cda_grid) / (nrow(cda_grid) + nrow(noncda_grid)))`

Proportion of estimated total Halibut caught inside CDA in 2020: 
`r r2(i_hal_cda2020$est / (i_hal_cda2020$est + i_hal_noncda2020$est))`

Average estimated Halibut caught per 100 hooks inside CDA:
`r r2(i_hal_cda2020$est / nrow(cda_grid))`

Average estimated Halibut caught per 100 hooks outside CDA:
`r r2(i_hal_noncda2020$est / nrow(noncda_grid))`

Proportion of estimated YE catch inside CDA:
`r r2(i_ye_cda$est / (i_ye_cda$est + i_ye_noncda$est))`

Average estimated YE caught per 100 hooks inside CDA:
`r r2(i_ye_cda$est / nrow(cda_grid))`

Average estimated YE caught per 100 hooks outside CDA:
`r r2(i_ye_noncda$est / nrow(noncda_grid))`

# Discussion

* We can add static covariates like bottom type, that would create more local-scale resolution (but likely not change the overall calculations).

* We haven't presented uncertainty on the inside vs. outside CDA ratios; this is possible but would require some more work.

* Note that we're only including the HBLL grid within the various boundaries. We could try extrapolating to the full management areas, but at the very least we'd want a habitate type covariate.
