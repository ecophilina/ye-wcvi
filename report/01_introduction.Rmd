```{r, echo=FALSE, message=FALSE, warning=FALSE}
here::i_am("report/01_introduction.Rmd")
library(here)
library(knitr)
library(ggplot2)
library(dplyr)
library(sdmTMB)
here::dr_here()
```


# Introduction {#sec:introduction}

* Yelloweye Rockfish (YE)
* Hard Bottom Longline survey (HBLL)
* Court Defined Area (CDA)

# Methods {#sec:methods}

We fit geostatistical spatiotemporal models to the southern outside Hard Bottom Longline survey (HBLL) and synoptic trawl survey data using the R package sdmTMB <https://github.com/pbs-assess/sdmTMB>. 
The HBLL survey focuses on rockfish habitats, rather than a broader range of habitats and depths that halibut occupy. 
This survey is usually conducted in alternating years, except that no survey occurred in both 2012 and 2013. 
The synoptic trawl surveys sample soft-bottom habitats, but use a different gear type and record biomass densities, rather than fish counts as on the HBLLL. 
Two of these surveys overlap spatially with the HBLL: the southern portion with the West Coast Vancouver Island Synoptic Survey conducted in even years (except 2020 due to covid **is this true?**), and the northern portion with the Queen Charlotte Sound Synoptic Survey conducted in odd years.
In order to stitch all three of these surveys together and produce estimates of local variation in biomass density, we pooled odd and even year pairs and converted the catch counts from the HBLL into biomass densities. 
HBLL catch counts are converted to biomass using an estimate of mean weight (currently using all fish sampled on the trawl surveys, because we don't have the Halibut measurements from the HBLL in our database and yelloweye sizes do not seem differ between the survey types). 
This biomass estimate is further divided by the "area swept" calculation of hook count x a hook spacing of 0.0024384 km) x an assumed catch radius of 0.009144 km and converted from km2.
Both this density and that from the trawl survey data are then converted from kg per km2 to kg per ha. 
**is this going to make my index values inflated? In other words, does the calculation assume that the units are at a particular spatial scale?**

Spatiotemporal correlation was much higher for Halibut than from YE, but improved model fit for both > delta 10 AIC. 
For Halibut, including an AR1 correlation between spatiotemporal fields only marginally improved model fit (~5 AIC), so we use independent spatiotemporal fields for both species. 
Our Halibut model is very similar to the model used by the IPHC for index standardization. **still true without an AR1?**
We use a Tweedie...

Survey type is included in the model as a fixed effect that captures differences in both selectivity **is that the right word?** and in the habitat types represented in the two survey types. 
We also include a quadratic effect of depth, annual means for years, and latent "random fields" for spatial and spatiotemporal fields. 
These random fields soak up remaining spatial or spatiotemporal correlation from predictors not explicitly included in the model.
If we added a substrate layer that could more fully account for the difference in habitats represented by the survey types, than the fixed effect of survey type would be mostly an estimate of differences in selectivity which might allow for somewhat better extrapolation of predicted catch between gear types and into neighbouring unsampled grid cells. 

**should we include this bit and the comparison fig?**
We also built models based on just the HBLL data to confirm that stiching of the survey types was still representative of the HBLL survey results. 
For this count-based model we used a negative binomial observation model with a log link and an an 'offset' for number of hooks. 
This means we are modelling fish caught per hook, but with a statistical approach that lets us use a count distribution. 
The negative binomial distribution lets the observation variance scale quadratically with the mean, which is typically needed for this type of data. 
- Describe predictions to matching grid and post-modeling conversion to biomass density
- include fig in results? 

We are not accounting for hook competition in any of these models because the goal here is to estimate likely catch ratios and not the underlying abundances. 

**should we add any diagnostic and validation plots?**

We then calculate expected fish densities for only those 2x2 km grid cells included in either the HBLL or trawl surveys, catch estimates are based on HBLL survey type, if a cell is part of the that grid, otherwise assumed to be better represenated by the trawl survey values.

We then calculate expected fish densities for all grid cells in a particular region for a given constant number of hooks and sum these values to come up with an expected number for grid cells within each region.

\clearpage

# Results {#sec:results}

```{r}
i_ye <- readRDS(here("data-generated/hybrid-yelloweye-trawlinhbllyrs-paired-index-all-S-sim-500.rds"))[[1]]
i_ye_cda <- readRDS(here("data-generated/hybrid-yelloweye-trawlinhbllyrs-paired-index-cda-sim-500.rds"))[[1]]
i_ye_noncda <- readRDS(here("data-generated/hybrid-yelloweye-trawlinhbllyrs-paired-index-3CD-outside-cda-sim-500.rds"))[[1]]
i_ye_5A <- readRDS(here("data-generated/hybrid-yelloweye-trawlinhbllyrs-paired-index-5A-sim-500.rds"))[[1]]

i_hal <- readRDS(here("data-generated/hybrid-halibut-trawlinhbllyrs-paired-index-all-S-sim-500.rds"))[[1]]
i_hal_cda <- readRDS(here("data-generated/hybrid-halibut-trawlinhbllyrs-paired-index-cda-sim-500.rds"))[[1]]
i_hal_noncda <- readRDS(here("data-generated/hybrid-halibut-trawlinhbllyrs-paired-index-3CD-outside-cda-sim-500.rds"))[[1]]
i_hal_5A <- readRDS(here("data-generated/hybrid-halibut-trawlinhbllyrs-paired-index-5A-sim-500.rds"))[[1]]

cda_grid <- readRDS(here("data-generated/hybrid_cda_grid_paired.rds"))
noncda_grid <- readRDS(here("data-generated/hybrid_noncda_grid_paired.rds"))
s_5A_grid <- readRDS(here("data-generated/hybrid_5A_grid_paired.rds"))
full_s_grid <- readRDS(here("data-generated/full_hybrid_grid_paired.rds"))
```

```{r r2-func}
r2 <- function(x) {
  sprintf("%.2f", round(x, 2))
}
```

```{r halibut-preds-all, fig.cap="Observed Pacific Halibut counts per 100 hooks from HBLL and converted equivalent from trawl survey (circle area) and predicted biomass densities (colour). The CDA is outlined in red. Note that the colour axis is square root transformed to improve visual interpretation.", out.width="\\textwidth"}
include_graphics(here("figs/hybrid-halibut-predictions-trawlinhbllyrs-paired.png"))
```

```{r ye-preds-all, fig.cap="Observed Yelloweye Rockfish counts per 100 hooks from HBLL and converted equivalent from trawl survey (circle area) and predicted biomass densities (colour). The CDA is outlined in red. Note that the colour axis is square root transformed to improve visual interpretation.", out.width="\\textwidth"}
include_graphics(here("figs/hybrid-ye-predictions-trawlinhbllyrs-paired.png"))
```

```{r halibut-preds-2020, fig.cap="Predicted Halibut densities and observed counts/count equivalents for 2019-2020. This is a zoomed-in version of just 2020.", out.width="5.5in"}
include_graphics(here("figs/hybrid-halibut-2020-predictions-trawlinhbllyrs-paired.png"))
```

```{r ye-preds-2020, fig.cap="Predicted Yelloweye Rockfish densities and observed counts/count equivalents for 2019-2020. Legend otherwise the same.", out.width="5.5in"}
include_graphics(here("figs/hybrid-yelloweye-2020-predictions-trawlinhbllyrs-paired.png"))
```

```{r ye-per-hal-preds-2020, fig.cap="Ratio of Yelloweye Rockfish biomass to Halibut biomass in 2019-2020. Note that the colour axis is square root transformed to improve visual interpretation.", out.width="5.5in"}
include_graphics(here("figs/hybrid-ye-to-halibut-2020-w-hal-catch-trawlinhbllyrs-paired.png"))
```

```{r hal-per-ye-preds-2020, fig.cap="Ratio of Halibut biomass to Yelloweye Rockfish biomass in 2019-2020. Because yelloweye often occur at much lower densities than Halibut, this calculation requires first truncating their biomass density to a minimum of 1 kg per km2. Note that the colour axis is square root transformed to improve visual interpretation.", out.width="5.5in"}
include_graphics(here("figs/hybrid-halibut-to-ye-2020-w-hal-catch-trawlinhbllyrs-paired.png"))
```

```{r halibut-indexes, fig.cap="Halibut index of relative abundance in combined HBLL and trawl survey grid within various regions. The full combined grid includes all of the trawl survey grid cells that fall within the latitudinal limits of the South outside HBLL. Lines are means and ribbons are 95\\% confidence intervals (CIs) from 500 simulations.", out.width="6in"}
include_graphics(here("figs/hybrid-halibut-trawlinhbllyrs-paired-index-by-area.png"))
```

```{r yelloweye-indexes, fig.cap="Yelloweye Rockfish index of relative abundance in combined HBLL and trawl survey grid within various regions. Lines are means and ribbons are 95\\% confidence intervals (CIs) from 500 simulations.", out.width="6in"}
include_graphics(here("figs/hybrid-yelloweye-trawlinhbllyrs-paired-index-by-area.png"))
```

```{r halibut-indexes-avg, fig.cap="Average Halibut relative abundance \\textbf{per HBLL and trawl survey grid cell} in CDA vs. in area 3CD but outside CDA.", out.width="6in"}
include_graphics(here("figs/hybrid-halibut-trawlinhbllyrs-paired-average-index.png"))
```

```{r yelloweye-indexes-avg, fig.cap="Average Yelloweye Rockfish relative abundance per HBLL and trawl survey grid grid cell in CDA vs. in area 3CD but outside CDA.", out.width="6in"}
include_graphics(here("figs/hybrid-yelloweye-trawlinhbllyrs-paired-average-index.png"))
```

```{r ye-ratio-through-time, fig.cap="Estimated ratio of Yelloweye Rockfish biomass to Halibut biomass for combined HBLL and trawl survey grid in CDA vs. in area 3CD but outside CDA.", out.width="6in"}
include_graphics(here("figs/hybrid-ye-to-hal-index-trawlinhbllyrs-paired.png"))
```

\clearpage

```{r filter-indices}
i_hal_cda2020 <- filter(i_hal_cda, year == 2020)
i_hal_noncda2020 <- filter(i_hal_noncda, year == 2020)
i_hal_5A2020 <- filter(i_hal_5A, year == 2020)
i_hal2020 <- filter(i_hal, year == 2020)
i_ye_cda2020 <- filter(i_ye_cda, year == 2020)
i_ye_noncda2020 <- filter(i_ye_noncda, year == 2020)
i_ye_5A2020 <- filter(i_ye_5A, year == 2020)
i_ye2020 <- filter(i_ye, year == 2020)

rel_hal <- readRDS(here("data-generated/mean_hal_ratios.rds")) 
rel_ye <- readRDS(here("data-generated/mean_ye_ratios.rds"))
spp_ratios <- readRDS(here("data-generated/ratios-yelloweye-to-halibut.rds"))

rel_hal_3CD <- filter(rel_hal, area == "CDAto3CD")
rel_ye_3CD <- filter(rel_ye, area == "CDAto3CD")
rel_hal_full <- filter(rel_hal, area == "CDAtoFull")
rel_ye_full <- filter(rel_ye, area == "CDAtoFull")

spp_ratios2020 <- filter(spp_ratios, year == 2020)
```

## Some calculated statistics for 2019-2020:



Proportion of grid cells inside area 3CD that are also inside the CDA: `r r2(nrow(cda_grid) / (nrow(cda_grid) + nrow(noncda_grid)))`

Proportion of estimated total Halibut biomass from grid cells in **Area 3CD** expected to be inside CDA: 
`r r2(rel_hal_3CD$ratio_mean)` (95% CI: `r r2(rel_hal_3CD$ratio_lwr)` to `r r2(rel_hal_3CD$ratio_upr)`) 

Proportion of estimated total Halibut biomass from cells in **full combinded grid** expected to be inside CDA:
`r r2(rel_hal_full$ratio_mean)` (95% CI: `r r2(rel_hal_full$ratio_lwr)` to `r r2(rel_hal_full$ratio_upr)`) 


Average estimated Halibut biomass density inside CDA:
`r r2(i_hal_cda2020$est / nrow(cda_grid))` (95% CI: `r r2(i_hal_cda2020$lwr / nrow(cda_grid))` to `r r2(i_hal_cda2020$upr / nrow(cda_grid))`) 

Average estimated Halibut biomass density in **Area 3CD** outside CDA:
`r r2(i_hal_noncda2020$est / nrow(noncda_grid))` (95% CI: `r r2(i_hal_noncda2020$lwr / nrow(noncda_grid))` to `r r2(i_hal_noncda2020$upr / nrow(noncda_grid))`) 

Average estimated Halibut biomass density overall for **full combinded grid**:
`r r2(i_hal2020$est / nrow(full_s_grid))` (95% CI: `r r2(i_hal2020$lwr / nrow(full_s_grid))` to `r r2(i_hal2020$upr / nrow(full_s_grid))`) 


Proportion of estimated YE from grid cells in **Area 3CD** expected to be inside CDA:
<!-- `r r2(i_ye_cda2020$est / (i_ye_cda2020$est + i_ye_noncda2020$est))` -->
`r r2(rel_ye_3CD$ratio_mean)` (95% CI: `r r2(rel_ye_3CD$ratio_lwr)` to `r r2(rel_ye_3CD$ratio_upr)`) 


Proportion of estimated YE from grid cells in **full combinded grid** expected to be inside CDA:
<!-- `r r2(i_ye_cda2020$est / (i_ye_cda2020$est + i_ye_noncda2020$est + i_ye_5A2020$est))` -->
`r r2(rel_ye_full$ratio_mean)` (95% CI: `r r2(rel_ye_full$ratio_lwr)` to `r r2(rel_ye_full$ratio_upr)`) 


Average estimated YE biomass density inside CDA:
<!-- `r r2(i_ye_cda2020$est / nrow(cda_grid))` -->
`r r2(i_ye_cda2020$est / nrow(cda_grid))` (95% CI: `r r2(i_ye_cda2020$lwr / nrow(cda_grid))` to `r r2(i_ye_cda2020$upr / nrow(cda_grid))`) 

Average estimated YE biomass density in **Area 3CD** outside CDA:
<!-- `r r2(i_ye_noncda2020$est / nrow(noncda_grid))` -->
`r r2(i_ye_noncda2020$est / nrow(noncda_grid))` (95% CI: `r r2(i_ye_noncda2020$lwr / nrow(noncda_grid))` to `r r2(i_ye_noncda2020$upr / nrow(noncda_grid))`) 

Average estimated YE biomass density overall for **full combinded grid**:
<!-- `r r2((i_ye_noncda2020$est + i_ye_5A2020$est) / (nrow(noncda_grid) + nrow(s_5A_grid)))` -->
`r r2(i_ye2020$est / nrow(full_s_grid))` (95% CI: `r r2(i_ye2020$lwr / nrow(full_s_grid))` to `r r2(i_ye2020$upr / nrow(full_s_grid))`) 



# Discussion

* Currently, these calculations are based on only the HBLL survey grid within the various boundaries. 

* Adding static covariates like bottom type would create more fine-scale spatial resolution to the predictions. While this is unlikely to change these calculations qualitatively within the HBLL grids, it might allow extrapolation beyond the survey grid. However, extrapolation to inadequately sampled habitat types is still problematic.

* We have not presented uncertainty on the inside vs. outside CDA ratios; this is possible but would require additional work.

* Building similar models from International Pacific Halibut Commission (IPHC) survey data could provide alternate estimates of catch ratios, but the local resolution would be coarser. 

