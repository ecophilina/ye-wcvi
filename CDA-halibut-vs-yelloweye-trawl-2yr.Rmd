---
title: "Estimating relative biomass of Pacific Halibut and Yelloweye Rockfish off west coast of Vancouver Island"
author: "Philina English"
date: "`r Sys.Date()`"
output: html_document
---

```{r message = F}
library(sf)
library(dplyr)
library(ggplot2)
library(tidyr)
# will need this version to replicate report
# remotes::install_github("pbs-assess/sdmTMB", ref = "47d997dd07b")
library(sdmTMB)
# Do we need instructions for installing other dependencies like "pbsmapping"?
# devtools::install_github("seananderson/ggsidekick")
library(ggsidekick) # for fourth_root_power_trans and theme_sleek
library(patchwork)
library(here)
theme_set(ggsidekick::theme_sleek())
dir.create("data", showWarnings = FALSE)
dir.create("data-generated", showWarnings = FALSE)
dir.create("models", showWarnings = FALSE)
```

# Retrieve all survey data 
Must be on network.

```{r eval=F}
halsetdata <- gfdata::get_survey_sets("Pacific Halibut")
saveRDS(halsetdata, "data/halibut-surv-sets-all.rds")

yesetdata <- gfdata::get_survey_sets("Yelloweye Rockfish")
saveRDS(yesetdata, "data/yelloweye-surv-sets-all.rds")

# get detailed biological data, I have retrieved data from all surveys in case comparisons between surveys are needed later
yesampledata <- gfdata::get_survey_samples("Yelloweye Rockfish")
saveRDS(yesampledata, "data/yelloweye-surv-samples-all.rds")

halsampledata <- gfdata::get_survey_samples("Pacific Halibut")
saveRDS(halsampledata, "data/halibut-surv-samples-all.rds")

# I also copied ####_grid.rda from gfplot into "data" folder
# and will need a folder called "shape-files" containing "taaqwiihak_areaVer2.shp"
# download gshhg-shp-2.3.7 from https://www.ngdc.noaa.gov/mgg/shorelines/data/gshhg/latest/ add place in data folder
```


# Stitch together trawl and HBLL survey data

Load custom functions including one that takes all the set data and hook data retrieved for each species and produces a dataframe for use in sdmTMB model. 

These models will be of estimated biomass density, so HBLL catch counts are converted to biomass using the mean weight of all fish sampled on the trawl surveys. 
The HBLL biomass estimate is further divided by the "area swept" calculation I found in a hook competition script (total_hooks * 0.0024384 * 0.009144 * 1000) except that I am using density estimates in kg/ha from the trawl instead of kg/km2, so I am multiplying by 10000 instead of 1000. 
This results in similar, but not identical, value ranges for both surveys, as would be expected given the different habitats they sample. 


```{r echo=F}
# load misc custom functions
source("functions.R")
```

```{r message=F}
model_data_prep <- function(trawldata, hblldata, mean_weight) {
  d <- hblldata

  d <- d %>%
    mutate(
      year_pair = case_when(
        year %in% c(2007, 2008) ~ 2008,
        year %in% c(2009, 2010) ~ 2010,
        year %in% c(2011, 2012) ~ 2012,
        year %in% c(2013, 2014) ~ 2014, 
        year %in% c(2015, 2016) ~ 2016,
        year %in% c(2017, 2018) ~ 2018,
        year %in% c(2019, 2020) ~ 2020  # no WCVI
      ),
      year_true = year,
      density = catch_count * mean_weight / (hook_count * 0.0024384 * 0.009144 * 10000) 
      # hook spacing = 0.0024384 km
      # assumed catch radius = 0.009144 km (30 feet)  TODO: I think we need to *2 to get diameter
      # this area swept calc was for km2, so * 10000 gives it in hectares
    ) %>%
    select(
      survey_abbrev, year_pair, year_true, 
      longitude, latitude, fishing_event_id, depth_m, density,
      catch_count, hook_count
    ) %>%
    mutate(lon = longitude, lat = latitude) %>%
    mutate(survey = "HBLL")

  dt <- trawldata %>%
    mutate(
      year_pair = case_when(
        year %in% c(2007, 2008) ~ 2008,
        year %in% c(2009, 2010) ~ 2010,
        year %in% c(2011, 2012) ~ 2012,
        year %in% c(2013, 2014) ~ 2014,
        year %in% c(2015, 2016) ~ 2016,
        year %in% c(2017, 2018) ~ 2018,
        year %in% c(2019, 2020) ~ 2020
      ),
      year_true = year,
      density = density_kgpm2 * 10000 # making density of trawl kg per hectare
    ) %>%
    select(
      survey_abbrev, year_pair, year_true,
      longitude, latitude, fishing_event_id, depth_m, density
    ) %>%
    mutate(lon = longitude, lat = latitude) %>%
    mutate(survey = "TRAWL")

  d <- bind_rows(d, dt) %>% 
    filter(depth_m > 1)

  # convert to utms for sdmTMB model
  d_utm <- convert2utm(d, coords = c("lon", "lat"))

  d_utm$depth_log <- log(d_utm$depth_m)
  d_utm$depth_centred <- d_utm$depth_log - mean(d_utm$depth_log)
  d_utm$depth_mean <- mean(d_utm$depth_log)
  d_utm$depth_sd <- sd(d_utm$depth_centred)
  d_utm$depth_scaled <- d_utm$depth_centred / sd(d_utm$depth_centred)
  d_utm$Y_cent <- d_utm$Y - mean(d_utm$Y)
  d_utm$X_cent <- d_utm$X - mean(d_utm$X)

  d_utm
}
```

Estimate commercial-sized halibut biomass in both trawl and HBLL data
```{r}
# trawl 
halsampledata <- readRDS("data/halibut-surv-samples-all.rds") %>% filter(survey_abbrev == c("SYN WCVI", "SYN QCS")) 

ggplot(halsampledata, aes(length)) + geom_histogram() + geom_vline(xintercept = 81.3) + geom_text(x = 84, y = 300, label = "threshold to keep", angle = 90)

halsampledata2 <- halsampledata %>% select(fishing_event_id, sex, length, weight) %>% mutate(
  log_length = log(length),
  log_weight = -11.94 + (3.14 * log_length) , # sex is missing for many fish, so will use F coefficients from synopsis report for all
  est_weight = exp(log_weight)*1000, # samples are in grams, but total catch and densities are in kg
  new_weight = if_else(!is.na(weight), as.numeric(weight)/1000,  as.numeric(exp(log_weight)))
)

# ggplot(halsampledata2, aes(weight,est_weight)) + geom_point() + geom_abline(b=1, a=1)

# proportion of trawl halibut biomass that belongs to halibut that were large enough to keep
small <- filter(halsampledata2, length < 81.3)
sum_small <- sum(small$est_weight/1000, na.rm = T)
N_small <- nrow(small)

keepers <- filter(halsampledata2, length >= 81.3)
sum_keepers <- sum(keepers$est_weight/1000, na.rm = T)
N_keepers <- nrow(keepers)

trawl_mean_ratio <- sum_keepers/(sum_keepers + sum_small) # almost 38% of biomass is from fish large enough to keep
N_keepers/(N_keepers + N_small) # almost 20% of individuals are large enough to keep

# fishing event specific ratios of small to keeper biomass...
halsampledata3 <- halsampledata2 %>% group_by(fishing_event_id) %>% summarise(
  sample_N = n(),
  sample_mass = sum(est_weight, na.rm = T),
  small_mass = sum(ifelse(length < 81.3, est_weight, 0), na.rm = T),
  keeper_mass = sum(ifelse(length >= 81.3, est_weight, 0), na.rm = T),
  small_N = sum(ifelse(length < 81.3, 1, 0), na.rm = T),
  keeper_N = sum(ifelse(length >= 81.3, 1, 0), na.rm = T)
)

# estimated weight of fish at min length threshold for keeping
min_weight <- exp(-11.94 + (3.14 * log(81.3)))

# calculate biomass density of sufficiently large halibut to be kept... 
# use sample-specific biomass ratio if 10 or more fish were measured OR more than 70% of biomass was sampled
# otherwise use global mean ratio from all trawl samples of 38% of halibut biomass belonging to keepers
haltrawldata <- readRDS("data/halibut-surv-sets-all.rds") %>% filter(survey_abbrev %in% c("SYN WCVI", "SYN QCS"))

haltrawldata <- left_join(haltrawldata, halsampledata3) %>% mutate(
  density_allsizes = density_kgpm2,
  sample_N = if_else(sample_N > 0, as.double(sample_N), 0, 0),
  prop_sampled = if_else(catch_weight == 0, 1, if_else((sample_mass/1000)/catch_weight >1, 1, (sample_mass/1000)/catch_weight, 0), 0),
  ratio_keepers = if_else(sample_mass > 0, keeper_mass/sample_mass, trawl_mean_ratio, missing = trawl_mean_ratio),
  density_kgpm2 = ifelse(catch_weight < min_weight, 0, ifelse(prop_sampled > 0.7 | sample_N > 9, ratio_keepers * density_kgpm2, trawl_mean_ratio * density_kgpm2))
)

saveRDS(haltrawldata, "data/halibut-surv-sets-trawl-keepers.rds") 

# see offload_counts.R script for calculation of average kg of commercially retainable halibut per fish caught in HBLL 
```


Check relative sizes of yelloweye caught in both surveys
```{r}
print("Mean Yelloweye weight from trawl")
yesampledataSYN <- readRDS("data/yelloweye-surv-samples-all.rds") %>% filter(survey_abbrev == c("SYN WCVI", "SYN QCS"))
yemeanweightSYN <- mean(yesampledataSYN$weight / 1000, na.rm = T)
round(yemeanweightSYN, 2)

print("Mean Yelloweye weight from HBLL")
yesampledata <- readRDS("data/yelloweye-surv-samples-all.rds") %>% filter(survey_abbrev == c("HBLL OUT S"))
yemeanweightHBLL <- mean(yesampledata$weight / 1000, na.rm = T)
round(yemeanweightHBLL, 2)

print("Mean Yelloweye weight in commerical data")
3.2 # 7 lbs =3.18 kg  
```

Prep data 
```{r}
# prep halibut
haltrawldata <- readRDS("data/halibut-surv-sets-trawl-keepers.rds") 
halhblldata <- readRDS("data/halibut-surv-sets-all.rds") %>% filter(survey_abbrev == "HBLL OUT S")

halmeanweight <- 4.23 # average kg of commercially retainable halibut per fish caught based on HBLL offload_round_weights/catch_counts

d_hal <- model_data_prep(haltrawldata, halhblldata, mean_weight = halmeanweight) %>%
    mutate(year = year_pair)
    # mutate(year = year_true)
saveRDS(d_hal, "data-generated/halibut-model-data-keepable-weight.rds")

# prep yelloweye
yetrawldata <- readRDS("data/yelloweye-surv-sets-all.rds") %>% filter(survey_abbrev %in% c("SYN WCVI", "SYN QCS"))
yehblldata <- readRDS("data/yelloweye-surv-sets-all.rds") %>% filter(survey_abbrev == "HBLL OUT S")

yemeanweight <- round(yemeanweightHBLL, 2)

d_ye <- model_data_prep(yetrawldata, yehblldata, mean_weight = yemeanweight)%>%
    mutate(year = year_pair)
    # mutate(year = year_true)
saveRDS(d_ye, "data-generated/yelloweye-model-data-hbll-weights.rds")

# yr <- d_ye %>% filter(year > 2006)
years <- sort(unique(d_ye$year))
```

# Make grids

Scale covariates for models
```{r}
f1 <- "data-generated/events_w_substrate_1km_buffer.rds"
if(!file.exists(f1)) {
  stop("Need to run part 1 of get-substrate.R script.")
} else {
substrate <- readRDS(file = f1) %>% 
  select(X, Y, fishing_event_id, any_rock, rocky, mixed, muddy)
}

d_utm <- readRDS("data-generated/yelloweye-model-data-hbll-weights.rds") %>% 
  filter(latitude < 52.15507) %>%
  filter(year %in% years) %>% left_join(select(substrate, -X, -Y)) # looks like no missing data to worry about

if(sum(is.na(d_utm$muddy))) { stop("Check for missing substrate data before running models.")}

# check depth range and use as starting point for filtering grid
ggplot(d_utm) + geom_histogram(aes(depth_m)) + scale_x_log10(breaks=c(25, 50, 100, 200, 400, 600, 800, 1000))

f2 <- "grids/norca_grid_w_substrate_expanded.rds"

if(!file.exists(f2)) {
  stop("Need to run make-grid.Rmd")
} else {
grid <- readRDS(file = f2) %>% 
  filter(depth > 2 & depth < 600) # produces best match to combination of HBLL S and trawl grids 
}
# grid <- grid[complete.cases(grid), ] # run this if only wanting complete 2x2 km cells

grid_utm <- expand_prediction_grid(grid, years = years) %>%
  # mutate(any_rock_scaled = (any_rock - mean(substrate$any_rock)/ sd(substrate$any_rock)) %>%
  mutate(depth_centred = log(depth) - mean(d_utm$depth_log)) %>%
  mutate(depth_scaled = depth_centred / sd(d_utm$depth_centred)) 

# grid_utm$source_data <- grid_utm$survey # can use this if you use original hybrid grid
# # if we want to predict for HBLL catch rates across full grid
grid_utm$survey <- "HBLL"
```


Prediction grid that covers full outside S HBLL

```{r}
full_s_grid_utm <- grid_utm %>% filter(longitude < -124.9)

full_s_grid_sf <- st_as_sf(full_s_grid_utm, coords = c("longitude", "latitude"))
st_crs(full_s_grid_sf) <- 4326 # set the coordinate reference system
full_s_grid1 <- sfc_as_cols(full_s_grid_sf, c("longitude", "latitude"))
st_geometry(full_s_grid1) <- NULL
```

Trim prediction grid for area 5A 

```{r}
s_5A_grid_utm <- filter(grid_utm, latitude < 51.24999 & latitude > 50.5) # trims grid to be just area 5A
s_5A_grid_sf <- st_as_sf(s_5A_grid_utm, coords = c("longitude", "latitude"))
st_crs(s_5A_grid_sf) <- 4326 # set the coordinate reference system
s_5A_grid <- sfc_as_cols(s_5A_grid_sf, c("longitude", "latitude"))
st_geometry(s_5A_grid) <- NULL
s_5A_grid$region <- "5A"
saveRDS(s_5A_grid, file = "report-data/filled_5A_grid_paired.rds")
```

Split area 3CD into areas inside and outside court defined area (CDA)

```{r message= F}
s_3CD_grid_utm <- filter(grid_utm, latitude < 50.5 & longitude < -124.9) # trims grid to be just area 3CD
s_3CD_grid_sf <- st_as_sf(s_3CD_grid_utm, coords = c("longitude", "latitude"))
st_crs(s_3CD_grid_sf) <- 4326 # set the coordinate reference system
# s_grid_sf

focal_area <- sf::st_read(dsn = "shape-files/taaqwiihak_areaVer2.shp", layer = "taaqwiihak_areaVer2")
focal_area <- sf::st_transform(focal_area, crs = 4326)

intersected <- sf::st_intersects(s_3CD_grid_sf, focal_area)

cda_grid_sf <- s_3CD_grid_sf[which(lengths(intersected) > 0), ]
noncda_3CD_grid_sf <- s_3CD_grid_sf[which(lengths(intersected) == 0), ]


only_3CD_grid <- sfc_as_cols(s_3CD_grid_sf, c("longitude", "latitude"))
saveRDS(only_3CD_grid, file = "report-data/filled_3CD_grid_paired.rds")
cda_grid <- sfc_as_cols(cda_grid_sf, c("longitude", "latitude"))
noncda_3CD_grid <- sfc_as_cols(noncda_3CD_grid_sf, c("longitude", "latitude"))
st_geometry(cda_grid) <- NULL
st_geometry(noncda_3CD_grid) <- NULL
cda_grid$region <- "CDA"
noncda_3CD_grid$region <- "non-CDA 3CD"
saveRDS(cda_grid, file = "report-data/filled_cda_grid_paired.rds")
saveRDS(noncda_3CD_grid, file = "report-data/filled_noncda_3CD_grid_paired.rds")
```

Area 3CD5A outside CDA 

```{r message= F}
noncda_grid <- bind_rows(noncda_3CD_grid, s_5A_grid)

noncda_grid$region <- "non-CDA 3CD5A"
saveRDS(noncda_grid, file = "report-data/filled_noncda_grid_paired.rds")


noncda_gridN <- filter(noncda_grid, latitude > 50)
noncda_gridN$region <- "3CD5A N"

noncda_gridS <- filter(noncda_grid, latitude <= 50)
noncda_gridS$region <- "non-CDA 3CD5A S"
```

Grids for different management regions
 
```{r eval = F}
library(PBSmapping) # needs this for some reason
library(maptools)
majorbound <- load_boundaries(9)

ggplot() + geom_polygon(data = majorbound,  aes(X * 1000, Y * 1000, 
            group = PID), colour = "grey", lty = 1, fill = NA) 

attributes(majorbound)$PolyData  

bound3C <- fortify(majorbound) %>% mutate(X = X * 1000, Y = Y * 1000) %>%
    filter(PID %in% c(3))

bound3D <- fortify(majorbound) %>% mutate(X = X * 1000, Y = Y * 1000) %>%
    filter(PID %in% c(4))

bound5A <- fortify(majorbound) %>% mutate(X = X * 1000, Y = Y * 1000) %>%
    filter(PID %in% c(5))
bound5B <- fortify(majorbound) %>% mutate(X = X * 1000, Y = Y * 1000) %>%
    filter(PID %in% c(6))


poly3C <- PolySet2SpatialPolygons(bound3C, close_polys=TRUE)
poly3C_sf <-  st_as_sf(poly3C)
st_crs(poly3C_sf) <- 3156
poly3C_sf <- sf::st_transform(poly3C_sf, crs = 4326)
intersected3C <- sf::st_intersects(full_s_grid_sf, poly3C_sf)
poly3C_grid_sf <- full_s_grid_sf[which(lengths(intersected3C) > 0), ]
poly3C_grid <- sfc_as_cols(poly3C_grid_sf, c("longitude", "latitude"))
st_geometry(poly3C_grid) <- NULL
poly3C_grid$region <- "3C"
poly3D <- PolySet2SpatialPolygons(bound3D, close_polys=TRUE)
poly3D_sf <-  st_as_sf(poly3D)
st_crs(poly3D_sf) <- 3156
poly3D_sf <- sf::st_transform(poly3D_sf, crs = 4326)
intersected3D <- sf::st_intersects(full_s_grid_sf, poly3D_sf)
poly3D_grid_sf <- full_s_grid_sf[which(lengths(intersected3D) > 0), ]
poly3D_grid <- sfc_as_cols(poly3D_grid_sf, c("longitude", "latitude"))
st_geometry(poly3D_grid) <- NULL
poly3D_grid$region <- "3D"

poly5A <- PolySet2SpatialPolygons(bound5A, close_polys=TRUE)
poly5A_sf <-  st_as_sf(poly5A)
st_crs(poly5A_sf) <- 3156
poly5A_sf <- sf::st_transform(poly5A_sf, crs = 4326)
intersected5A <- sf::st_intersects(full_s_grid_sf, poly5A_sf)
poly5A_grid_sf <- full_s_grid_sf[which(lengths(intersected5A) > 0), ]
poly5A_grid <- sfc_as_cols(poly5A_grid_sf, c("longitude", "latitude"))
st_geometry(poly5A_grid) <- NULL
poly5A_grid$region <- "5A"

poly5B <- PolySet2SpatialPolygons(bound5B, close_polys=TRUE)
poly5B_sf <-  st_as_sf(poly5B)
st_crs(poly5B_sf) <- 3156
poly5B_sf <- sf::st_transform(poly5B_sf, crs = 4326)
intersected5B <- sf::st_intersects(full_s_grid_sf, poly5B_sf)
poly5B_grid_sf <- full_s_grid_sf[which(lengths(intersected5B) > 0), ]
poly5B_grid <- sfc_as_cols(poly5B_grid_sf, c("longitude", "latitude"))
st_geometry(poly5B_grid) <- NULL
poly5B_grid$region <- "5B"

ggplot() + geom_sf(data = poly3C_sf, colour = "blue", lty = 2, fill = NA) +
  geom_sf(data = poly3D_sf, colour = "green", lty = 2, fill = NA) +
  geom_sf(data = poly5A_sf, colour = "red", lty = 2, fill = NA) +
  geom_sf(data = poly5B_sf, colour = "yellow", lty = 2, fill = NA) 


# full_s_grid_sf_utm <- st_transform(full_s_grid_sf, crs = 3156)
# intersected3C <- sf::st_intersects(full_s_grid_sf_utm, poly3C_sf)
# poly3C_grid_sf <- full_s_grid_sf_utm[which(lengths(intersected3C) > 0), ]

ggplot() + geom_sf(data = poly3C_sf, colour = "blue", lty = 2, fill = NA) +
  geom_sf(data = poly3D_sf, colour = "green", lty = 2, fill = NA) +
  geom_sf(data = poly5A_sf, colour = "red", lty = 2, fill = NA) +
  geom_sf(data = poly5B_sf, colour = "yellow", lty = 2, fill = NA) +
  geom_sf(data = poly3C_grid_sf, colour = "blue", lty = 2, fill = NA) + 
  geom_sf(data = poly3D_grid_sf, colour = "green", lty = 2, fill = NA) +
  geom_sf(data = poly5A_grid_sf, colour = "red", lty = 2, fill = NA) +
  geom_sf(data = poly5B_grid_sf, colour = "yellow", lty = 2, fill = NA) 


poly5A_grid <- poly5A_grid %>% filter(!(latitude < 50.85 & latitude > 50.75 & longitude > -128.94 & longitude < -128.6))
regions_grid <- bind_rows(poly3C_grid, poly3D_grid, poly5A_grid, poly5B_grid)

saveRDS(regions_grid, file = "report-data/filled_regions_grid.rds")
```


Just the HBLL S grid 

```{r message= F}
hbll_s_grid <- readRDS("data-generated/full_hybrid_grid_w_substrate.rds") %>% 
  filter(survey == "HBLL")
hbll_s_grid <- hbll_s_grid[complete.cases(hbll_s_grid), ]
hbll_s_grid <- expand_prediction_grid(hbll_s_grid, years = years) %>%
    mutate(depth_centred = log(depth) - mean(d_utm$depth_log)) %>%
    mutate(depth_scaled = depth_centred / sd(d_utm$depth_centred)) 
```


Merge back into one grid with regions

```{r }
noncda_gridS_named <- select(noncda_gridS, X, Y, region) 
noncda_gridN_named <- select(noncda_gridN, X, Y, region) 
cda_grid_named <- select(cda_grid, X, Y, region) 

region_names <- bind_rows(noncda_gridS_named ,noncda_gridN_named, cda_grid_named) %>% distinct()
full_s_grid <- left_join(full_s_grid1, region_names)

# remove two partial cells within the Scott Islands RCA
full_s_grid <- full_s_grid %>% filter(!(latitude < 50.85 & latitude > 50.75 & longitude > -128.94 & longitude < -128.6))

full_s_grid[is.na(full_s_grid$region), ]$region <- "other"
saveRDS(full_s_grid, file = "report-data/full_filled_grid_paired.rds")
```

```{r eval = F}
# determine how to exclude partial cells within Scott Island RCA
full_s_grid2 <- filter(full_s_grid, area < 4000000)
full_s_grid3 <- filter(full_s_grid, 
  latitude < 50.85 & latitude > 50.75 & longitude > -128.94 & longitude < -128.6)

full_s_grid3$area/1000000

ggplot() + geom_point(data = filter(full_s_grid2, 
    latitude < 50.9 & latitude > 50.5 & longitude > -128.99 & longitude < -128.5
    ), aes(longitude, latitude),
        colour = "grey85", fill = "grey85") +
  geom_point(data = filter(full_s_grid, 
    latitude < 50.85 & latitude > 50.75 & longitude > -128.94 & longitude < -128.6
    ), aes(longitude, latitude, size = area))
```

```{r}
f <- paste0("figs/region-colour-map-3x3-expanded.png")
if (!file.exists(f)) {
full_s_grid2 <- full_s_grid  
  
full_s_grid2$region <- ordered(full_s_grid2$region, 
  levels = c("CDA", "other", "3CD5A N", "non-CDA 3CD5A S"), 
  labels = c("CDA", "non-CDA 3CD5A", "3CD5A N of 50º", "non-CDA 3CD5A S of 50º"))

g1 <- ggplot(full_s_grid2, aes(X,Y, colour = region)) + geom_point() +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer("Sub-region", palette = "Set1")

leg <- cowplot::get_legend(g1)

min_map_lat <- 48.3
# max_map_lat <- 51.4
min_map_lon <- -130.1
max_map_lon <- -124.85

g <- map_predictions(
  pred_data = full_s_grid2,
  fill_aes = region,
  fill_lab = "Region",
  map_lat_limits = c(min_map_lat, 51.25),
  map_lon_limits = c(min_map_lon, max_map_lon)
)+ theme(legend.position = "none") +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
g <- g + leg + patchwork::plot_layout(widths = c(1, 0.55))
ggsave("figs/region-colour-map-3x3-expanded.png", 
  width = 5, height = 3, dpi = 300)
}
```

### Make map of grids
```{r}
# make map of grid areas and their overlap
f <- "figs/map-stitched-grid-overlap-expanded.png"

if (!file.exists(f)) {
coast_gshhg_proj <- readRDS("data-generated/coast_gshhg.rds")

focal_area <- sf::st_read(dsn = "shape-files/taaqwiihak_areaVer2.shp",
    layer = "taaqwiihak_areaVer2", quiet = TRUE)
focal_area_proj <- sf::st_transform(focal_area, crs = 3156)

library(PBSmapping) # needs this for some reason
  majorbound <- load_boundaries(9)
  # attributes(majorbound)$PolyData
  # 5AB
  bound5Bnorth <- fortify(majorbound) %>%
    filter(PID %in% c(6)) %>%
    filter( # POS != 46 & # strange jog over HG
      X > 200 & X < 560 & Y > 5700
    )
  bound5Anorth <- fortify(majorbound) %>%
    filter(PID %in% c(5)) %>%
    filter(
      X > 200 & X < 600 & Y > 5650
    )
  # 3CD
  bound3Cnorth <- fortify(majorbound) %>%
    filter(PID %in% c(3)) %>%
    filter(X > 200 & X < 725 & Y > 5400) #%>%
  # gfplot:::utm2ll(utm_zone = 9)
  bound3Dnorth <- fortify(majorbound) %>%
    filter(PID %in% c(4)) %>%
    filter(X > 200 & X < 600 & Y > 5550)
  bound3Csouth <- fortify(majorbound) %>%
    filter(PID %in% c(3)) %>%
    filter(X > 200 & X < 900 & Y < 5420) #%>%

  
hbll_s_grid <- readRDS(here::here("grids/hbll_s_grid.rds")) 
hbll_s_grid <- hbll_s_grid$grid #%>% filter(latitude < 51.24999)

hbll_sf <- st_as_sf(hbll_s_grid, coords = c("longitude", "latitude"), crs = 4326)  
hbll_sf <- st_transform(hbll_sf, crs = 3156)
hbll_sf$source_data <- "HBLL"
hbll_sf_grid <- sf::st_make_grid(x = hbll_sf,
  offset = st_bbox(hbll_sf)[c("xmin", "ymin")]+ c(-1000, -1000),
  cellsize=c(2000, 2000))

# plot(st_geometry(hbll_sf_grid))
# plot(st_geometry(hbll_sf), col= "red", add = T)

keep <- st_intersects(hbll_sf, hbll_sf_grid)
hbll_sf_grid <- hbll_sf_grid[unlist(keep)]
hbll_sf2 <- st_as_sf(hbll_sf_grid)
hbll_sf2$source_data <- "HBLL"


load("grids/synoptic_grid.rda")
trawl <- synoptic_grid %>%
  mutate(X = round(X), Y = round(Y),
    X = X*1000, Y = Y*1000,
    source_data = "TRAWL"
  )

# to veiw the filled in trawl grid, but not illustrate actual survey cells
# trawl <- readRDS(here::here("grids/nd_all_synoptic_new.rds")) %>% 
#   mutate(#X = round(X), Y = round(Y),
#     X = X*1000, Y = Y*1000,
#     source_data = "TRAWL"
#   ) 

trawl_sf <- st_as_sf(trawl, coords = c("X", "Y"), crs = 3156)
trawl_sf_grid <- sf::st_make_grid(x = trawl_sf,
  offset = st_bbox(trawl_sf)[c("xmin", "ymin")]+ c(-1000, -1000),
  cellsize=c(2000, 2000))

keep <- st_intersects(trawl_sf, trawl_sf_grid)
trawl_sf_grid <- trawl_sf_grid[unlist(keep)]
trawl_sf2 <- st_as_sf(trawl_sf_grid)
trawl_sf2$source_data <- "TRAWL"

# full_s_grid_utm <- grid_utm
# full_s_grid_sf <- st_as_sf(full_s_grid_utm, coords = c("longitude", "latitude"))
# st_crs(full_s_grid_sf) <- 4326 # set the coordinate reference system
# 
# full_s_grid_sf2 <- st_transform(full_s_grid_sf, crs = 3156)
# full_sf_grid <- sf::st_make_grid(x = full_s_grid_sf2,
#   offset = st_bbox(hbll_sf)[c("xmin", "ymin")]+ c(-1000, -1000),
#   cellsize=c(2000, 2000))
# keep <- st_intersects(full_s_grid_sf2, full_sf_grid)
# full_sf_grid <- full_sf_grid[unlist(keep)]
# full_sf_grid2 <- st_as_sf(full_sf_grid)
full_s_grid_trim <- full_s_grid %>% filter(depth <= 600)

g <- ggplot(focal_area_proj) +
  # geom_sf(data=full_sf_grid2, fill = "white", colour = NA, alpha = 0.9) +
  geom_tile(data = full_s_grid_trim, aes(X * 100000, Y * 100000),
        # colour = "white", fill = "white", #colour = NA,
        colour = "grey85", fill = "grey85", #colour = NA,
        width = 2000, height = 2000) +
  # geom_sf(data=full_sf_grid2, fill = "grey90", colour = NA, alpha = 0.9) +
  geom_sf(data=trawl_sf2,  aes(fill = source_data), colour = NA,
    alpha = 0.7) +
  geom_sf(data=hbll_sf2,  aes(fill = source_data), colour = NA,
    alpha = 0.7) +
  geom_line( # add major management region boundaries
      data = bound3Csouth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
   geom_line( # add major management region boundaries
      data = bound3Cnorth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
    geom_line( # add major management region boundaries
      data = bound3Dnorth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
    geom_line( # add major management region boundaries
      data = bound5Anorth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
    geom_sf(colour = "red", fill = NA, size = 0.70) + # add focal area behind coast
    geom_sf(data = coast_gshhg_proj, size = 0.07, fill = "grey75", col = "grey55") +
    annotate("text",
      x = convert2utm9(-129.8, 50.7)[1],
      y = convert2utm9(-129.8, 50.7)[2], label = "5A") +
    annotate("text",
      x = convert2utm9(-129.8, 50.3)[1],
      y = convert2utm9(-129.8, 50.3)[2],
      label = "3D") +
    annotate("text",
      x = convert2utm9(-129.8, 48.8)[1],
      y = convert2utm9(-129.8, 48.8)[2],
      label = "3C") +
  scale_fill_viridis_d(name = "Survey", begin = 0.2, end = 0.5, direction = -1) +
  geom_sf(colour = "red", fill = NA, size = 0.70) + # add focal area behind coast
  geom_sf(data = coast_gshhg_proj, size = 0.07, fill = "grey99", col = "grey55") +
  coord_sf(
      # xlim = c(230957.7 + 205000, 1157991 - 385000),
      # ylim = c(5366427 + 25000, 6353456 - 590000)
      xlim = c(230957.7 + 205000, 1157991 - 370000),
      ylim = c(5366427 + 2000, 6353456 - 590000)
    ) +
   annotate("text",
      x = convert2utm9(-126.25, 50.1)[1],
      y = convert2utm9(-126.25, 50.1)[2],
      colour = "gray65",
     size = 3.5,
      label = "Vancouver\nIsland") +
  annotate("text",
      x = convert2utm9(-126.1, 51.4)[1],
      y = convert2utm9(-126.1, 51.4)[2],
      colour = "gray65",
    size = 5,
      label = "British\nColumbia") +
  ggsidekick::theme_sleek() + theme(
      panel.grid.major = element_line(colour = "grey60", size = 0.3),
      legend.key = element_rect(colour = NA, fill = "grey70"),
      axis.title = element_blank(),
      legend.box.background = element_rect(color = NA, size = 1, fill = "#ffffff90"),
      legend.position = c(0.99, 0.99),
      legend.justification = c(1, 1),
      panel.background = element_rect(color = NA, size = 1, fill = "grey70")) 

ggsave("figs/map-stitched-grid-overlap-expanded.png", width = 5.5, height = 5.5, dpi = 400)
}
```

# Explore depth variation across regions
```{r}
f <- paste0("figs/depth-map.png")
if (!file.exists(f)) {
coast_gshhg_proj <- readRDS("data-generated/coast_gshhg.rds")

focal_area <- sf::st_read(dsn = "shape-files/taaqwiihak_areaVer2.shp",
    layer = "taaqwiihak_areaVer2", quiet = TRUE)
focal_area_proj <- sf::st_transform(focal_area, crs = 3156)

library(PBSmapping) # needs this for some reason
  majorbound <- load_boundaries(9)
  # attributes(majorbound)$PolyData
  # 5AB
  bound5Bnorth <- fortify(majorbound) %>%
    filter(PID %in% c(6)) %>%
    filter( # POS != 46 & # strange jog over HG
      X > 200 & X < 560 & Y > 5700
    )
  bound5Anorth <- fortify(majorbound) %>%
    filter(PID %in% c(5)) %>%
    filter(
      X > 200 & X < 600 & Y > 5650
    )
  # 3CD
  bound3Cnorth <- fortify(majorbound) %>%
    filter(PID %in% c(3)) %>%
    filter(X > 200 & X < 725 & Y > 5400) #%>%
  # gfplot:::utm2ll(utm_zone = 9)
  bound3Dnorth <- fortify(majorbound) %>%
    filter(PID %in% c(4)) %>%
    filter(X > 200 & X < 600 & Y > 5550)
  bound3Csouth <- fortify(majorbound) %>%
    filter(PID %in% c(3)) %>%
    filter(X > 200 & X < 900 & Y < 5420) #%>%

full_s_grid_trim <- full_s_grid %>% filter(depth <= 600)
g <- ggplot(focal_area_proj) +
  geom_tile(data = full_s_grid_trim, aes(X * 100000, Y * 100000, fill = depth),
        width = 2000, height = 2000) +
  geom_line( # add major management region boundaries
      data = bound3Csouth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
   geom_line( # add major management region boundaries
      data = bound3Cnorth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
    geom_line( # add major management region boundaries
      data = bound3Dnorth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
    geom_line( # add major management region boundaries
      data = bound5Anorth,
      aes(X * 1e3, Y * 1e3), colour = "grey20", lty = 1,
      inherit.aes = F
    ) +
    geom_sf(colour = "red", fill = NA, size = 0.70) + # add focal area behind coast
    geom_sf(data = coast_gshhg_proj, size = 0.07, fill = "grey75", col = "grey55") +
    annotate("text",
      x = convert2utm9(-129.8, 50.7)[1],
      y = convert2utm9(-129.8, 50.7)[2], label = "5A") +
    annotate("text",
      x = convert2utm9(-129.8, 50.3)[1],
      y = convert2utm9(-129.8, 50.3)[2],
      label = "3D") +
    annotate("text",
      x = convert2utm9(-129.8, 48.8)[1],
      y = convert2utm9(-129.8, 48.8)[2],
      label = "3C") +
  scale_fill_viridis_c(trans = "sqrt", name = "Depth", direction = -1) +
  geom_sf(colour = "red", fill = NA, size = 0.70) + # add focal area behind coast
  geom_sf(data = coast_gshhg_proj, size = 0.07, fill = "grey99", col = "grey55") +
  coord_sf(
      # xlim = c(230957.7 + 205000, 1157991 - 385000),
      # ylim = c(5366427 + 25000, 6353456 - 590000)
      xlim = c(230957.7 + 205000, 1157991 - 370000),
      ylim = c(5366427 + 2000, 6353456 - 590000)
    ) +
   annotate("text",
      x = convert2utm9(-126.25, 50.1)[1],
      y = convert2utm9(-126.25, 50.1)[2],
      colour = "gray65",
     size = 3.5,
      label = "Vancouver\nIsland") +
  annotate("text",
      x = convert2utm9(-126.1, 51.4)[1],
      y = convert2utm9(-126.1, 51.4)[2],
      colour = "gray65",
    size = 5,
      label = "British\nColumbia") +
  ggsidekick::theme_sleek() + theme(
      panel.grid.major = element_line(colour = "grey60", size = 0.3),
      legend.key = element_rect(colour = NA, fill = "grey70"),
      axis.title = element_blank(),
      legend.box.background = element_rect(color = NA, size = 1, fill = "#ffffff90"),
      legend.position = c(0.99, 0.99),
      legend.justification = c(1, 1),
      panel.background = element_rect(color = NA, size = 1, fill = "grey70")) 

g

ggsave("figs/depth-map.png", 
 width = 5.5, height = 5.5, dpi = 400)
}
```

```{r}
full_s_grid3 <- full_s_grid  %>% filter(region != "other")

full_s_grid_all <- full_s_grid  %>% filter(region %in% c("3CD5A N", "non-CDA 3CD5A S")) %>% mutate(region = "non-CDA 3CD5A")

full_s_grid_all <- bind_rows(full_s_grid3, full_s_grid_all)

full_s_grid_all$region <- ordered(full_s_grid_all$region, 
  levels = c("CDA", "non-CDA 3CD5A", "3CD5A N", "non-CDA 3CD5A S"), 
  labels = c("CDA", "non-CDA 3CD5A", "3CD5A N of 50º", "non-CDA 3CD5A S of 50º"))

ggplot(full_s_grid_all, aes(depth, fill = region)) + 
  geom_histogram() + facet_grid(rows=vars(region)) +
  scale_fill_brewer(palette = "Set1") +
  # scale_fill_manual(values = c("red", "#4DAF4A", "#984EA3")) +
  xlab("Depth") + ylab("Cell count")+
  ggsidekick::theme_sleek() + theme(
      legend.position = "none") 

ggsave("figs/depth-hist.png", width = 3.5, height = 7.5, dpi = 300)
```

```{r}
d_hal <- readRDS("data-generated/halibut-model-data-keepable-weight.rds") %>%
  filter(latitude < 52.15507) %>%
  filter(year %in% years)%>% left_join(select(substrate, -X, -Y)) 

ggplot(d_hal, aes(depth_m, density, colour = survey)) + geom_point()

```


# Make relatively finescale mesh

```{r }
# again the same grid should work for both species because the sets are identical in both
mesh400kn <- make_mesh(d_utm, c("X", "Y"), n_knots = 400)
# mesh_cu <- make_mesh(d_utm, c("X", "Y"), cutoff = 0.075)
# mesh_cu$mesh$n
# plot(mesh_cu$mesh, asp = 1, main = "");points(d_utm$X, d_utm$Y, pch = ".")
plot(mesh400kn$mesh, asp = 1, main = "");points(d_utm$X, d_utm$Y, pch = ".")
# plot(mesh400kn)
```

# Pacific Halibut model 

```{r eval = TRUE}
d_hal <- readRDS("data-generated/halibut-model-data-keepable-weight.rds") %>%
  filter(latitude < 52.15507) %>%
  filter(year %in% years)%>% left_join(select(substrate, -X, -Y)) 
f <- paste0("models/halibut-hybrid-keepable-model-rocky-muddy-400kn-tweedie2.rds")
if (!file.exists(f)) {
  m_halibut_tweedie <- sdmTMB(
    formula = density ~ 0 + as.factor(year) + as.factor(survey) + 
      s(rocky, k = 3) + s(muddy, k = 3) +
      depth_scaled + I(depth_scaled^2),
    data = d_hal,
    spde = mesh400kn,
    fields = "IID",
    time = "year",
    silent = FALSE,
    # anisotropy = TRUE,
    family = tweedie(link = "log")
  )
  saveRDS(m_halibut_tweedie, file = f)
}

f <- paste0("models/halibut-hybrid-keepable-model-rocky-muddy-400kn-binomial2.rds")
if (!file.exists(f)) {
  d_hal$present <- ifelse(d_hal$density > 0, 1, 0)
  m_halibut_bin <- sdmTMB(
    formula = present ~ 0 + as.factor(year) + as.factor(survey) + 
      s(rocky, k = 3) + s(muddy, k = 3) +
      depth_scaled + I(depth_scaled^2),
    data = d_hal,
    spde = mesh400kn,
    fields = "IID",
    time = "year",
    silent = FALSE,
    # anisotropy = TRUE,
    family = binomial(link = "logit")
  )
  saveRDS(m_halibut_bin, file = f)
}

f <- paste0("models/halibut-hybrid-keepable-model-rocky-muddy-400kn-gamma2.rds")
if (!file.exists(f)) {
  d_hal_pos <- subset(d_hal, density > 0)
  mesh400kn_pos <- make_mesh(d_hal_pos, c("X", "Y"), n_knots = 400)
  m_halibut_pos <- sdmTMB(
    formula = density ~ 0 + as.factor(year) + as.factor(survey) + 
      s(rocky, k = 3) + s(muddy, k = 3) +
      depth_scaled + I(depth_scaled^2),
    data = d_hal_pos,
    spde = mesh400kn_pos,
    fields = "IID",
    time = "year",
    silent = FALSE,
    # anisotropy = TRUE,
    family = Gamma(link = "log")
  )
  saveRDS(m_halibut_pos, file = f)
}
```

## Load saved models

```{r}
m_halibut_tweedie <- readRDS(paste0("models/halibut-hybrid-keepable-model-rocky-muddy-400kn-tweedie2.rds"))
m_halibut_bin <- readRDS(paste0("models/halibut-hybrid-keepable-model-rocky-muddy-400kn-binomial2.rds"))
m_halibut_pos <- readRDS(paste0("models/halibut-hybrid-keepable-model-rocky-muddy-400kn-gamma2.rds"))
```

## Comparing models

```{r echo = F}
m_halibut_tweedie
tidy(m_halibut_tweedie, "ran_pars", conf.int = TRUE)
```

```{r}
m_halibut_bin
tidy(m_halibut_bin, "ran_pars", conf.int = TRUE)

m_halibut_pos
tidy(m_halibut_pos, "ran_pars", conf.int = TRUE)
```

```{r warning=F, message=F}
get_diag(m_halibut_tweedie)
```

```{r warning=F, message=F}
get_diag(m_halibut_bin, response = "present")
```

```{r warning=F, message=F}
get_diag(m_halibut_pos)
```



# Yelloweye Rockfish model

Much less temporal variation, so have confirmed that an AR1 didn't improve model. But what about a spatial-only model?

```{r eval=TRUE}
d_ye <- readRDS("data-generated/yelloweye-model-data-hbll-weights.rds") %>%
  filter(latitude < 52.15507) %>%
  filter(year %in% years)%>% left_join(select(substrate, -X, -Y))

f <- "models/yelloweye-hybrid-hbll-mw-rocky-muddy-400kn.rds"
if (!file.exists(f)) {
  m_ye <- sdmTMB(
    formula = density ~ 0 + as.factor(year) + as.factor(survey) + 
      s(rocky, k = 3) +
      s(muddy, k = 3) +
      depth_scaled + I(depth_scaled^2),
    data = d_ye,
    spde = mesh400kn,
    fields = "IID",
    time = "year",
    silent = FALSE,
    anisotropy = TRUE,
    # reml = T, # F is simplier to explain. 
    family = tweedie(link = "log")
  )
  saveRDS(m_ye, file = f)
}

f <- "models/yelloweye-hybrid-hbll-mw-rocky-muddy-400kn-no-anisotropy.rds"
if (!file.exists(f)) {
  m_ye0 <- sdmTMB(
    formula = density ~ 0 + as.factor(year) + as.factor(survey) + 
      s(rocky, k = 3) +
      s(muddy, k = 3) +
      depth_scaled + I(depth_scaled^2),
    data = d_ye,
    spde = mesh400kn,
    fields = "IID",
    time = "year",
    silent = FALSE,
    # anisotropy = TRUE,
    # reml = T, # F is simplier to explain. 
    family = tweedie(link = "log")
  )
  saveRDS(m_ye0, file = f)
}

# 
# d_ye$present <- ifelse(d_ye$density > 0, 1, 0)
# m_ye1 <- sdmTMB(
#     formula = present ~ 0 + as.factor(year) + as.factor(survey) +
#       s(rocky, k = 3) +
#       s(muddy, k = 3) +
#       depth_scaled + I(depth_scaled^2),
#     data = d_ye,
#     spde = mesh400kn,
#     fields = "IID",
#     time = "year",
#     silent = FALSE,
#     anisotropy = TRUE,
#     # reml = T, # F is simplier to explain.
#     family = binomial(link = "logit")
#   )
# saveRDS(m_ye1, file = "models/yelloweye-hybrid-delta-mw-rocky-muddy-400kn-binomial.rds")
# 
# d_ye_pos <- subset(d_ye, density > 0)
# mesh400kn_pos <- make_mesh(d_ye_pos, c("X", "Y"), n_knots = 400)
# m_ye2 <- sdmTMB(
#   formula = density ~ 0 + as.factor(year) + as.factor(survey) +
#     s(rocky, k = 3) +
#     s(muddy, k = 3) +
#     depth_scaled + I(depth_scaled^2),
#   data = d_ye_pos,
#   spde = mesh400kn_pos,
#   fields = "IID",
#   time = "year",
#   silent = FALSE,
#   anisotropy = TRUE,
#   # reml = T, # F is simplier to explain.
#   family = Gamma(link = "log")
# )
# saveRDS(m_ye2, file = "models/yelloweye-hybrid-delta-mw-rocky-muddy-400kn-gamma.rds")
```


## Load saved models

```{r}
m_ye <- readRDS(file = "models/yelloweye-hybrid-hbll-mw-rocky-muddy-400kn.rds")
```

## Comparing models

```{r echo = F}
m_ye
AIC(m_ye)
tidy(m_ye, "ran_pars", conf.int = TRUE)

print("without anisotropy")

m_ye0 <- readRDS(file = "models/yelloweye-hybrid-hbll-mw-rocky-muddy-400kn-no-anisotropy.rds")
# m_ye0
AIC(m_ye0) # worse by > 10 AIC
```

```{r warning=F, message=F}
get_diag(m_ye)
```

# QQ-plots

```{r}
r_ye <- residuals(m_ye)
qq_ye1 <- qqnorm(r_ye)
r_ye2 <- residuals(m_ye)
qq_ye2 <- qqnorm(r_ye2)
r_ye3 <- residuals(m_ye)
qq_ye3 <- qqnorm(r_ye3)

png("figs/ye-qq.png", width = 3, height = 3.25, units = "in", res = 200)
par(mfrow = c(1, 1), mar = c(4, 4, 2, 0), oma = c(1, 1, 1, 1))
plot(qq_ye1$x, qq_ye1$y, type = "p", col = "#00000050", asp = 1, 
  xlab = "Theoretical Quantiles", ylab = "Sample Quantiles", main = "Tweedie\n")
lines(qq_ye1$x, qq_ye1$y, type = "p", col = "#00000050")
lines(qq_ye2$x, qq_ye2$y, type = "p", col = "#00000050")
qqline(r_ye)
qqline(r_ye2)
qqline(r_ye3)
dev.off()

# m_ye1 <- readRDS(file = "models/yelloweye-hybrid-hbll-mw-rocky-muddy-400kn-binomial.rds")
# m_ye2 <- readRDS(file = "models/yelloweye-hybrid-hbll-mw-rocky-muddy-400kn-gamma.rds")
# 
# r_ye1 <- residuals(m_ye1)
# qqnorm(r_ye1);qqline(r_ye1)
# 
# r_ye2 <- residuals(m_ye2)
# qqnorm(r_ye2);qqline(r_ye2)
```


```{r eval=F}
r_hal_tw <- residuals(m_halibut_tweedie)
qq_hal_tw1 <- qqnorm(r_hal_tw)
r_hal_tw2 <- residuals(m_halibut_tweedie)
qq_hal_tw2 <- qqnorm(r_hal_tw2)
r_hal_tw3 <- residuals(m_halibut_tweedie)
qq_hal_tw3 <- qqnorm(r_hal_tw3)

r_hal_bin <- residuals(m_halibut_bin)
qq_hal_bin1 <- qqnorm(r_hal_bin)
r_hal_bin2 <- residuals(m_halibut_bin)
qq_hal_bin2 <- qqnorm(r_hal_bin2)
r_hal_bin3 <- residuals(m_halibut_bin)
qq_hal_bin3 <- qqnorm(r_hal_bin3)

r_hal_pos <- residuals(m_halibut_pos)
qq_hal_pos1 <- qqnorm(r_hal_pos)
r_hal_pos2 <- residuals(m_halibut_pos)
qq_hal_pos2 <- qqnorm(r_hal_pos2)
r_hal_pos3 <- residuals(m_halibut_pos)
qq_hal_pos3 <- qqnorm(r_hal_pos3)


png("figs/halibut-qq.png", width = 6, height = 2.5, units = "in", res = 200)
par(mfrow = c(1, 3), mar = c(4, 4, 2, 0), oma = c(1, 1, 1, 1))
# qqnorm(r_hal_tw, main = "Tweedie", asp = 1);qqline(r_hal_tw)
plot(qq_hal_tw3$x, qq_hal_tw3$y, type = "p", col = "#00000050", asp = 1, 
  xlab = "", ylab = "Sample Quantiles", main = "Tweedie\n ")
lines(qq_hal_tw1$x, qq_hal_tw1$y, type = "p", col = "#00000050")
lines(qq_hal_tw2$x, qq_hal_tw2$y, type = "p", col = "#00000050")
qqline(r_hal_tw)
qqline(r_hal_tw2)
qqline(r_hal_tw3)

# qqnorm(r_hal_bin, main = "Binomial", asp = 1);qqline(r_hal_bin)
plot(qq_hal_bin3$x, qq_hal_bin3$y, type = "p", col = "#00000050", asp = 1, 
  xlab = "Theoretical Quantiles", ylab = "", main = "Binomial\n ")
lines(qq_hal_bin1$x, qq_hal_bin1$y, type = "p", col = "#00000050")
lines(qq_hal_bin2$x, qq_hal_bin2$y, type = "p", col = "#00000050")
qqline(r_hal_bin)
qqline(r_hal_bin2)
qqline(r_hal_bin3)
# qqnorm(r_hal_pos, main = "Gamma", asp = 1);qqline(r_hal_pos)
plot(qq_hal_pos3$x, qq_hal_pos3$y, type = "p", col = "#00000050", asp = 1, 
  xlab = "", ylab = "", main = "Gamma\n ")
lines(qq_hal_pos1$x, qq_hal_pos1$y, type = "p", col = "#00000050")
lines(qq_hal_pos2$x, qq_hal_pos2$y, type = "p", col = "#00000050")
qqline(r_hal_pos)
qqline(r_hal_pos2)
qqline(r_hal_pos3)
dev.off()


# off <- d_hal[which(r_hal_tw > 2.2), ]
# off <- d_hal[which(r_hal_tw > 2.2), ]
# table(off$survey_abbrev)
# table(off$present)
# ggplot(d_hal, aes(X, Y, colour = density, shape = survey)) + geom_point(size = 1) +
#   facet_wrap(~year) +
#   scale_color_viridis_c(trans = "sqrt") +
#   coord_equal() +
#   geom_point(data = off, colour = "red")
# 
# plot(d_hal$depth_scaled);points(off$depth_scaled, col = "red")
# table(off$year)
# 
# d_hal$id <- seq_len(nrow(d_hal))
# off <- d_hal[which(r_hal_tw > 2.4), ]
# ggplot(d_hal, aes(id, density, colour = depth_m, shape = survey)) + geom_point() +
#   geom_point(data = off, pch = 21) +
#   scale_color_viridis_c(trans = "log10")
# 
# plot(d_hal$rocky)
# plot(d_hal$rocky);points(off$rocky, col = "red")
# plot(d_hal$muddy);points(off$muddy, col = "red")
# plot(d_hal$mixed);points(off$mixed, col = "red")
# plot(d_hal$density);points(off$density, col = "red")
# plot(d_hal$density);points(d_hal$density[d_hal$survey != "TRAWL"], col = "red");points(off$density, col = "blue")
# plot(d_ye$density);points(d_ye$density[d_ye$survey != "TRAWL"], col = "red")
# 
# d_hal$off <- ifelse(r_hal_tw > 2.5, TRUE, FALSE)
# d_hal$resids <- r_hal_tw 
# ggplot(d_hal, aes(X, Y, colour = density, shape = survey)) + geom_point(size = 1) +
#   facet_wrap(~year) +
#   scale_color_viridis_c(trans = "sqrt") +
#   coord_equal() +
#   geom_point(data = off, colour = "red")
# 
```

# Catch predictions and indices
## Pacific Halibut 
using filled in grid (includes partial cells but not sure how to account for cell area index code) and HBLL gear type

For entire filled in southern outside HBLL grid area including CDA, but excluding RCAs 

```{r eval = T, echo=F}
f <- "data-generated/filled-keepable-halibut-delta-est-rock-mud-predictions-all-S.rds"
if (!file.exists(f)) {
  p_hal_S_bin <- predict(m_halibut_bin, newdata = full_s_grid, return_tmb_object = TRUE)
  
  p_hal_S_pos <- predict(m_halibut_pos, newdata = full_s_grid, return_tmb_object = TRUE) 

  p_hal_S <-  p_hal_S_bin
  p_hal_S$data$est_bin <- p_hal_S$data$est
  p_hal_S$data$est_pos <- p_hal_S_pos$data$est
  p_hal_S$data$est <- log(plogis(p_hal_S$data$est_bin) * exp(p_hal_S$data$est_pos))
  saveRDS(p_hal_S, f)
}
```


Non-CDA 3CD5A

```{r  echo=F}
ss <- "data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A3CD-outside-cda-sim-500.rds"

if (!file.exists(ss)) {
  i_hal_noncda <- get_all_sims(fit_obj_bin = m_halibut_bin, fit_obj_pos = m_halibut_pos, 
    newdata = noncda_grid, split_by_region = F)
  saveRDS(i_hal_noncda, ss)
}
```


For subregions using same batch of simulations

```{r hal-sim-subregions, eval = T, echo=F}
## this takes up a lot of space and duplicates the components saved below...
# ss <- "data-generated/filled-keepable-halibut-delta-est-rock-mud-index-list-sim-500.rds"
# if (!file.exists(ss)) {
#   i_hal_combined <- get_all_sims(m_halibut, newdata = full_s_grid)
#   saveRDS(i_hal_combined, ss)
# }

s1 <- "data-generated/filled-keepable-halibut-delta-est-rock-mud-index-all-S-sim-500.rds"
if (!file.exists(s1)) {
  i_hal_combined <- get_all_sims(fit_obj_bin = m_halibut_bin, fit_obj_pos = m_halibut_pos,  newdata = full_s_grid)
  i_hal_S <- i_hal_combined[[1]] 
  saveRDS(i_hal_S, s1)
}

s3 <- "data-generated/filled-keepable-halibut-delta-est-rock-mud-index-cda-sim-500.rds"
if (!file.exists(s3)) {
  i_hal_cda2 <- i_hal_combined[[3]] 
  saveRDS(i_hal_cda2, s3)
}

s4 <- "data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A3CDN-outside-cda-sim-500.rds"
if (!file.exists(s4)) {
  i_hal_noncda2N <- i_hal_combined[[4]] 
  saveRDS(i_hal_noncda2N, s4)
}

s2 <- "data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A3CDS-outside-cda-sim-500.rds"
if (!file.exists(s2)) {
  i_hal_noncda2S <- i_hal_combined[[2]] 
  saveRDS(i_hal_noncda2S, s2)
}

s5 <- "data-generated/filled-keepable-halibut-delta-est-rock-mud-index-other-sim-500.rds"
if (!file.exists(s5)) {
  i_hal_other <- i_hal_combined[[5]] 
  saveRDS(i_hal_other, s5)
}
```


For management regions using same batch of simulations

```{r hal-sim-manregions, eval = F, echo=F}
## this takes up a lot of space and duplicates the components saved below...
# ss <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-list-sim-500.rds"
# if (!file.exists(ss)) {
#   i_ye_combined <- get_all_sims(m_ye, newdata = full_s_grid)
#   saveRDS(i_ye_combined, ss)
# }

s1 <- "data-generated/filled-keepable-halibut-delta-est-rock-mud-index-all-regions-sim-500.rds"
if (!file.exists(s1)) {
  i_hal_combined <- get_all_sims(fit_obj_bin = m_halibut_bin, fit_obj_pos = m_halibut_pos, newdata = regions_grid)
  i_hal_1 <- i_hal_combined[[1]] 
  saveRDS(i_hal_1, s1)
}

s2 <- "data-generated/filled-keepable-halibut-delta-est-rock-mud-index-3C-sim-500.rds"
if (!file.exists(s2)) {
  i_hal_2 <- i_hal_combined[[2]] 
  saveRDS(i_hal_2, s2)
}

s3 <- "data-generated/filled-keepable-halibut-delta-est-rock-mud-index-3D-sim-500.rds"
if (!file.exists(s3)) {
  i_hal_3 <- i_hal_combined[[3]] 
  saveRDS(i_hal_3, s3)
}

s4 <- "data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A-sim-500.rds"
if (!file.exists(s4)) {
  i_hal_4 <- i_hal_combined[[4]] 
  saveRDS(i_hal_4, s4)
}

s5 <- "data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5B-sim-500.rds"
if (!file.exists(s5)) {
  i_hal_5 <- i_hal_combined[[5]] 
  saveRDS(i_hal_5, s5)
}
```

For just southern outside HBLL 

```{r  echo=F}
# hbll_s_grid <- readRDS(here::here("grids/hbll_s_grid.rds"))
f <- "data-generated/filled-keepable-halibut-delta-est-rock-mud-predictions-hbll-S.rds"
if (!file.exists(f)) {

  p_hal_S_bin <- predict(m_halibut_bin, newdata = hbll_s_grid, return_tmb_object = TRUE)
  p_hal_S_pos <- predict(m_halibut_pos, newdata = hbll_s_grid, return_tmb_object = TRUE)

  p_hal_S <-  p_hal_S_bin
  p_hal_S$data$est_bin <- p_hal_S$data$est
  p_hal_S$data$est_pos <- p_hal_S_pos$data$est
  p_hal_S$data$est <- log(plogis(p_hal_S$data$est_bin) * exp(p_hal_S$data$est_pos))
  saveRDS(p_hal_S, f)
}

ss <- "data-generated/filled-keepable-halibut-delta-est-rock-mud-index-hbll-S-sim-500.rds"
if (!file.exists(ss)) {
  i_hal_S2b <- get_all_sims(fit_obj_bin = m_halibut_bin, fit_obj_pos = m_halibut_pos, 
    newdata = hbll_s_grid, split_by_region = F)
  saveRDS(i_hal_S2b, ss)
}
```


## Yelloweye Rockfish 

For entire filled in southern outside HBLL grid including CDA, but excluding RCAs.
This is roughly equivilant to entire southern outside yelloweye stock.  

```{r eval = T, echo=F}
f <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-all-S.rds"
if (!file.exists(f)) {
  p_ye_S <- predict(m_ye, newdata = full_s_grid, return_tmb_object = TRUE)
  saveRDS(p_ye_S, "data-generated/filled-keepable-yelloweye-est-rock-mud-predictions-all-S.rds")

  i_ye_S <- get_index(p_ye_S, bias_correct = F)
  saveRDS(i_ye_S, f)
}

# ss <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-all-S-sim-500.rds"
# if (!file.exists(ss)) {
#   i_ye_S2 <- get_all_sims(m_ye, newdata = full_s_grid)
#   saveRDS(i_ye_S2, ss)
# }
```

For 5A3CD outside CDA 

```{r eval = T, echo=F}
s0 <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CD-outside-cda-sim-500.rds"

if (!file.exists(s0)) {
  i_ye_noncda <- get_all_sims(m_ye, newdata = noncda_grid, split_by_region = F)
  saveRDS(i_ye_noncda, s0)
}

# f <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CD-outside-cda.rds"
# if (!file.exists(f)) {
#   p_ye_noncda <- predict(m_ye, newdata = noncda_grid, return_tmb_object = TRUE)
#   saveRDS(p_ye_noncda, "data-generated/filled-keepable-yelloweye-est-rock-mud-predictions-5A3CD-outside-cda.rds")
# 
#   i_ye_noncda <- get_index(p_ye_noncda, bias_correct = F)
#   saveRDS(i_ye_noncda, f)
# }
# 
# ss <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CD-outside-cda-sim-500.rds"
# if (!file.exists(ss)) {
#   i_ye_noncda2 <- get_all_sims(m_ye, newdata = noncda_grid, split_by_region = F)
#   saveRDS(i_ye_noncda2, ss)
# }
```


For subregions using same batch of simulations

```{r ye-sim-subregions, eval = T, echo=F}
## this takes up a lot of space and duplicates the components saved below...
# ss <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-list-sim-500.rds"
# if (!file.exists(ss)) {
#   i_ye_combined <- get_all_sims(m_ye, newdata = full_s_grid)
#   saveRDS(i_ye_combined, ss)
# }

s1 <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-all-S-sim-500.rds"
if (!file.exists(s1)) {
  i_ye_combined <- get_all_sims(m_ye, newdata = full_s_grid)
  i_ye_S <- i_ye_combined[[1]] 
  saveRDS(i_ye_S, s1)
}

s3 <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-cda-sim-500.rds"
if (!file.exists(s3)) {
  i_ye_cda2 <- i_ye_combined[[3]] 
  saveRDS(i_ye_cda2, s3)
}

s4 <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CDN-outside-cda-sim-500.rds"
if (!file.exists(s4)) {
  i_ye_noncda2N <- i_ye_combined[[4]] 
  saveRDS(i_ye_noncda2N, s4)
}

s2 <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CDS-outside-cda-sim-500.rds"
if (!file.exists(s2)) {
  i_ye_noncda2S <- i_ye_combined[[2]] 
  saveRDS(i_ye_noncda2S, s2)
}

s5 <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-other-outside-cda-sim-500.rds"
if (!file.exists(s5)) {
  i_ye_other <- i_ye_combined[[5]] 
  saveRDS(i_ye_other, s5)
}
```

For management regions using same batch of simulations

```{r ye-sim-manregions, eval = F, echo=F}
## this takes up a lot of space and duplicates the components saved below...
# ss <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-list-sim-500.rds"
# if (!file.exists(ss)) {
#   i_ye_combined <- get_all_sims(m_ye, newdata = full_s_grid)
#   saveRDS(i_ye_combined, ss)
# }

s1 <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-all-regions-sim-500.rds"
if (!file.exists(s1)) {
  i_ye_combined <- get_all_sims(m_ye, newdata = regions_grid)
  saveRDS(i_ye_combined, "data-generated/filled-keepable-yelloweye-est-rock-mud-predictions-all-regions-sim-500.rds")
  i_ye_1 <- i_ye_combined[[1]] 
  saveRDS(i_ye_1, s1)
}

s2 <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-3C-sim-500.rds"
if (!file.exists(s2)) {
  i_ye_2 <- i_ye_combined[[2]] 
  saveRDS(i_ye_2, s2)
}

s3 <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-3D-sim-500.rds"
if (!file.exists(s3)) {
  i_ye_3 <- i_ye_combined[[3]] 
  saveRDS(i_ye_3, s3)
}

s4 <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A-sim-500.rds"
if (!file.exists(s4)) {
  i_ye_4 <- i_ye_combined[[4]] 
  saveRDS(i_ye_4, s4)
}

s5 <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-5B-sim-500.rds"
if (!file.exists(s5)) {
  i_ye_5 <- i_ye_combined[[5]] 
  saveRDS(i_ye_5, s5)
}
```


For just southern outside HBLL 
```{r eval = T, echo = F}
ss <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-hbll-S-sim-500.rds"
if (!file.exists(ss)) {
  
  i_ye_S2b <- get_all_sims(m_ye, newdata = hbll_s_grid, split_by_region = F)
  saveRDS(i_ye_S2b, ss)
}

## not needed right now
# f <- "data-generated/filled-keepable-yelloweye-est-rock-mud-index-hbll-S.rds"
# if (!file.exists(f)) {
# 
#   p_ye_Sb <- predict(m_ye, newdata = hbll_s_grid, return_tmb_object = TRUE)
#   saveRDS(p_ye_Sb, "data-generated/filled-keepable-yelloweye-est-rock-mud-predictions-hbll-S.rds")
# 
#   i_ye_Sb <- get_index(p_ye_Sb, bias_correct = F) # bias_correction not working only for full grid
#   saveRDS(i_ye_Sb, f)
# }
```

# Just simulated indices for report
```{r}
i_ye <- readRDS(here("data-generated/filled-keepable-yelloweye-est-rock-mud-index-all-S-sim-500.rds"))[[1]]
saveRDS(i_ye, here("report-data/filled-keepable-yelloweye-est-rock-mud-index-all-S-sim-500.rds"))
i_ye_cda <- readRDS(here("data-generated/filled-keepable-yelloweye-est-rock-mud-index-cda-sim-500.rds"))[[1]]
saveRDS(i_ye_cda, here("report-data/filled-keepable-yelloweye-est-rock-mud-index-cda-sim-500.rds"))
i_ye_noncda <- readRDS(here("data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CD-outside-cda-sim-500.rds"))[[1]]
saveRDS(i_ye_noncda, here("report-data/filled-keepable-yelloweye-est-rock-mud-index-5A3CD-outside-cda-sim-500.rds"))
i_ye_noncdaN <- readRDS(here("data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CDN-outside-cda-sim-500.rds"))[[1]]
saveRDS(i_ye_noncdaN, here("report-data/filled-keepable-yelloweye-est-rock-mud-index-5A3CDN-outside-cda-sim-500.rds"))
i_ye_noncdaS <- readRDS(here("data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CDS-outside-cda-sim-500.rds"))[[1]]
saveRDS(i_ye_noncdaS, here("report-data/filled-keepable-yelloweye-est-rock-mud-index-5A3CDS-outside-cda-sim-500.rds"))


i_hal <- readRDS(here("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-all-S-sim-500.rds"))[[1]]
saveRDS(i_hal, here("report-data/filled-keepable-halibut-delta-est-rock-mud-index-all-S-sim-500.rds"))
i_hal_cda <- readRDS(here("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-cda-sim-500.rds"))[[1]]
saveRDS(i_hal_cda, here("report-data/filled-keepable-halibut-delta-est-rock-mud-index-cda-sim-500.rds"))
i_hal_noncda <- readRDS(here("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A3CD-outside-cda-sim-500.rds"))[[1]]
saveRDS(i_hal_noncda, here("report-data/filled-keepable-halibut-delta-est-rock-mud-index-5A3CD-outside-cda-sim-500.rds"))
i_hal_noncdaN <- readRDS(here("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A3CDN-outside-cda-sim-500.rds"))[[1]]
saveRDS(i_hal_noncdaN, here("report-data/filled-keepable-halibut-delta-est-rock-mud-index-5A3CDN-outside-cda-sim-500.rds"))
i_hal_noncdaS <- readRDS(here("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A3CDS-outside-cda-sim-500.rds"))[[1]]
saveRDS(i_hal_noncdaS, here("report-data/filled-keepable-halibut-delta-est-rock-mud-index-5A3CDS-outside-cda-sim-500.rds"))
```

# Model checks 

```{r eval = F}
p <- predict(m_halibut_tweedie)
p2 <- predict(m_halibut_bin)
p3 <- predict(m_halibut_pos, newdata = m_halibut_bin$data) 
p$est_delta <- log(plogis(p2$est) * exp(p3$est))
plot(est_delta~est, data=p)
abline(a = 0, b = 1, lty = 2)
```


```{r eval = F, echo=F}
f <- "data-generated/filled-keepable-halibut-delta-est-rock-mud-predictions-all-S-sim2.rds"
if (!file.exists(f)) {

  p_hal_S_bin <- predict(m_halibut_bin, newdata = full_s_grid, se_fit = F, sims = 500)
  p_hal_S_pos <- predict(m_halibut_pos, newdata = full_s_grid, se_fit = F, sims = 500)
  
  p_hal_S <- full_s_grid
  
  p_hal_S_combined <- log(plogis(p_hal_S_bin) * exp(p_hal_S_pos))
  p_hal_S$est <- apply(p_hal_S_combined, 1, function(x) {median(x)})
  
  
  # p_hal_S_bin_out <- apply(p_hal_S_bin, 1, function(x) {median(x)})
  # p_hal_S_pos_out <- apply(p_hal_S_pos, 1, function(x) {median(x)})
  # p_hal_S$est <- log(plogis(p_hal_S_bin_out) * exp(p_hal_S_pos_out))
  
# p_hal_S_bin_out <- apply(p_hal_S_bin, 1, function(x) {
#   data.frame(est = median(x))
# })
# p_hal_S_bin_out <- do.call("rbind", p_hal_S_bin_out)
# p_hal_S_bin_out <- p_hal_S_bin_out[, c("est"), drop = FALSE]
# 
# p_hal_S_bin2 <- bind_cols(full_s_grid, p_hal_S_bin_out)
# 
# p_hal_S_pos_out <- apply(p_hal_S_pos, 1, function(x) {
#   data.frame(est = median(x)
#   )
# })
# p_hal_S_pos_out <- do.call("rbind", p_hal_S_pos_out)
# p_hal_S_pos_out <- p_hal_S_pos_out[, c("est"), drop = FALSE]
# 
# p_hal_S_pos2 <- bind_cols(full_s_grid, p_hal_S_pos_out)
#  
# p_hal_S$data$est <- log(plogis(p_hal_S_bin2$est) * exp(p_hal_S_pos2$est))
  
  saveRDS(p_hal_S, f)
}
```


```{r eval = F}
p_hal_delta <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-predictions-all-S.rds")[[1]] %>% select(X, Y, year, est) %>% rename(est_delta = est)

p_hal_delta_sim <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-predictions-all-S-sim2.rds") %>% select(X, Y, year, est) %>% rename(est_delta_sim = est)

p_hal_tw <- readRDS("data-generated/filled-keepable-halibut-est-rock-mud-predictions-all-S.rds")[[1]] %>% rename(est_tw = est)

p_hal <- left_join(p_hal_tw, p_hal_delta)

plot(est_delta~est_tw, data = p_hal, alpha=0.5)
abline(a = 0, b = 1, lty = 2)

p_hal <- left_join(p_hal_tw, p_hal_delta_sim)

plot(est_delta_sim~est_tw, data = p_hal, alpha=0.5)
abline(a = 0, b = 1, lty = 2)

p_hal <- left_join(p_hal_delta, p_hal_delta_sim)

plot(est_delta_sim~est_delta, data = p_hal, alpha=0.5)
abline(a = 0, b = 1, lty = 2)

```

## Check predictions against those from the HBLL-only count model

```{r echo=F, message=F, warning=F}
hybrid_pred <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-predictions-hbll-S.rds")
poisson_pred <- readRDS("data-generated/halibut-predictions-all-S.rds")

hyb <- hybrid_pred$data %>% 
  # mutate(est = exp(est)) %>%
  select(X, Y, year, log_biomass = est)

pois <- poisson_pred$data %>% 
  # mutate(est_exp = exp(est)) %>%
  mutate(      
      year_true = year,
      year = case_when(
        year %in% c(2007, 2008) ~ 2008,
        year %in% c(2009, 2010) ~ 2010,
        year %in% c(2011, 2012) ~ 2012,
        year %in% c(2013, 2014) ~ 2014,
        year %in% c(2015, 2016) ~ 2016,
        year %in% c(2017, 2018) ~ 2018,
        year %in% c(2019, 2020) ~ 2020
      ),
    X = round(X*100)/100, Y = round(Y*100)/100) %>% 
  select(X, Y, year, year_true, log_count = est)

d_test <- left_join(hyb, pois)

d_test_hal <- d_test[complete.cases(d_test), ]

ggplot(d_test_hal, aes(log_count, log_biomass)) + 
  geom_point(alpha = 0.1) + 
  ylim(-3, 2) + xlim(-3, 3) + 
  facet_wrap(~year_true)
```

```{r echo=F, message=F, warning=F}
hybrid_pred <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-predictions-hbll-S.rds")
poisson_pred <- readRDS("data-generated/yelloweye-spatial-predictions-all-S.rds")

hyb <- hybrid_pred$data %>% 
  # mutate(est = exp(est)) %>%
  select(X, Y, year, log_biomass = est)

pois <- poisson_pred$data %>% 
  # mutate(est_exp = exp(est)) %>%
  mutate( year_true = year, 
    year = case_when(
        year %in% c(2007, 2008) ~ 2008,
        year %in% c(2009, 2010) ~ 2010,
        year %in% c(2011, 2012) ~ 2012,
        year %in% c(2013, 2014) ~ 2014,
        year %in% c(2015, 2016) ~ 2016,
        year %in% c(2017, 2018) ~ 2018,
        year %in% c(2019, 2020) ~ 2020
      ), 
    X = round(X*100)/100, Y = round(Y*100)/100) %>% 
  select(X, Y, year, year_true, log_count = est)

d_test <- left_join(hyb, pois) 

d_test_ye <- d_test[complete.cases(d_test), ]

ggplot(d_test_ye, aes(log_count, log_biomass)) + geom_point(alpha = 0.1) + 
  ylim(-6, 2) + xlim(-3, 3) + 
  facet_wrap(~year_true)
```

## Check distribution of simulations

```{r message=F, echo=F, warning=F}
sim_hal_cda <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-cda-sim-500.rds")[[2]]
sim_hal_noncdaN <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A3CDN-outside-cda-sim-500.rds")[[2]]
sim_hal_noncdaS <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A3CDS-outside-cda-sim-500.rds")[[2]]

ggplot(sim_hal_cda, aes(as.factor(year), .value)) + geom_violin(colour = "red") + 
  geom_violin(data = sim_hal_noncdaS, aes(as.factor(year), .value), colour = "blue") + 
  geom_violin(data = sim_hal_noncdaN, aes(as.factor(year), .value), fill= NA, colour = "darkgreen") +
  ylab("Halibut Index Simulations") + xlab("Year")
```

```{r message=F, echo=F, warning=F}
sim_ye_cda <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-cda-sim-500.rds")[[2]]
sim_ye_noncdaN <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CDN-outside-cda-sim-500.rds")[[2]]
sim_ye_noncdaS <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CDS-outside-cda-sim-500.rds")[[2]]

ggplot(sim_ye_cda, aes(as.factor(year), .value)) + geom_violin(colour = "red") + 
  geom_violin(data = sim_ye_noncdaS, aes(as.factor(year), .value), colour = "blue") + 
  geom_violin(data = sim_ye_noncdaN, aes(as.factor(year), .value), fill= NA, colour = "darkgreen") +
  ylab("Yelloweye Index Simulations") + xlab("Year")
```

## Compare indices between species and model types 
Uses only HBLL S grid and transforms predicted counts from HBLL model into biomass density using same formula as used on the observed densities before stitching the two survey types together.

```{r echo=F, message=F, warning=F}
i_hal_hbll <- readRDS("data-generated/halibut-index-all-S-sim-500.rds")[[1]]
i_ye_hbll <- readRDS("data-generated/yelloweye-spatial-index-all-S-sim-500.rds")[[1]]
i_hal <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-hbll-S-sim-500.rds")[[1]]
i_ye <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-hbll-S-sim-500.rds")[[1]]

.dat <- bind_rows(mutate(i_hal, Model = "B. HBLL + trawl (biomass)", Species = "Halibut"),
  mutate(i_hal_hbll, Model = "A. HBLL (counts x mean weight)", Species = "Halibut", 
    est = est * halmeanweight/ (100 * 0.0024384 * 0.009144 * 10000) 
    , 
    lwr = lwr * halmeanweight/ (100 * 0.0024384 * 0.009144 * 10000) 
    , 
    upr = upr * halmeanweight/ (100 * 0.0024384 * 0.009144 * 10000) 
    ),
  mutate(i_ye, Model = "B. HBLL + trawl (biomass)", Species = "Yelloweye"),
  mutate(i_ye_hbll, Model = "A. HBLL (counts x mean weight)",  Species = "Yelloweye", 
    est = est * yemeanweight/ (100 * 0.0024384 * 0.009144 * 10000) 
    , 
    lwr = lwr * yemeanweight/ (100 * 0.0024384 * 0.009144 * 10000) 
    , 
    upr = upr * yemeanweight/ (100 * 0.0024384 * 0.009144 * 10000) 
    )
)
.dat$Species <- ordered(.dat$Species, levels = c("Halibut", "Yelloweye"))
.dat$year <- as.integer(.dat$year)

ggplot(.dat, aes(year, est/1000, fill = Species, colour = Species)) +
  geom_line() +
  geom_ribbon(aes(ymin = lwr/1000, ymax = upr/1000), alpha = 0.2, colour = NA) +
  xlab("Year") +
  ylab("Biomass Index (HBLL S grid only)") +
  theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
  scale_fill_viridis_d(option = "D", begin = 0.5, end = 0.95) +
  scale_colour_viridis_d(option = "D", begin = 0.5, end = 0.95) +
  facet_wrap_custom(~Model, nrow = 2, scales = "free", scale_overrides = list(
    scale_override(1, scale_x_continuous(breaks = seq(1950, 2050, 2))),
    scale_override(2, scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)))
  ))+
    theme(strip.text.x = element_text(angle = 0, hjust = 0))

ggsave("figs/compare-model-indices.png", width = 7, height = 5, dpi = 400)
```

# Results

## Index of total Pacific Halibut catch through time

```{r message=F, echo=F}
# i_hal <- readRDS("data-generated/halibut-index-all-S.rds")
# i_hal_cda <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-cda.rds")
# i_hal_noncda <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A3CD-outside-cda.rds")
# i_hal_5A <- readRDS("data-generated/halibut-index-5A.rds")
i_hal <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-all-S-sim-500.rds")[[1]]
i_hal_cda <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-cda-sim-500.rds")[[1]]
i_hal_noncda <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A3CD-outside-cda-sim-500.rds")[[1]]
i_hal_noncdaN <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A3CDN-outside-cda-sim-500.rds")[[1]]
i_hal_noncdaS <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A3CDS-outside-cda-sim-500.rds")[[1]]
# i_hal_5A <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A-sim-500.rds")[[1]]
i_hal_hbll <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-hbll-S-sim-500.rds")[[1]]

.datH <- bind_rows(
  # mutate(i_hal, Area = "Full combined"),
  # mutate(i_hal_hbll, Area = "HBLL grid only"),
  # mutate(i_hal_5A, Area = "5A"),
  mutate(i_hal_noncdaN, Area ="3CD5A N of 50º"),
  mutate(i_hal_noncdaS, Area = "non-CDA 3CD5A S of 50º"),
  mutate(i_hal_noncda, Area = "non-CDA 3CD5A"),
  mutate(i_hal_cda, Area = "CDA")
)


.datH$Area <- ordered(.datH$Area, levels = c("CDA", "non-CDA 3CD5A", "3CD5A N of 50º", "non-CDA 3CD5A S of 50º", "Full combined", "HBLL grid only"))
g_i_hal <- ggplot(.datH, aes(year, est/1000, fill = Area, colour = Area)) + # convert kg to tonnes
  geom_line(size = 1.25) +
  geom_ribbon(aes(ymin = lwr/1000, ymax = upr/1000), alpha = 0.2, colour = NA) +
  xlab("Year") +
  ylab("Biomass index (landable tonnes)") +
  ggtitle("A. Pacific Halibut") +
  coord_cartesian( #expand = FALSE, 
    ylim = c(0, max(.datH$upr)/1000)) +
  # scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
g_i_hal
ggsave("figs/filled-keepable-halibut-delta-est-rock-mud-index-by-area.png", width = 7, height = 4, dpi = 400)
```

## Index of total Yelloweye Rockfish catch through time

```{r message=F, echo=F}
i_ye <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-all-S-sim-500.rds")[[1]]
i_ye_cda <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-cda-sim-500.rds")[[1]]
i_ye_noncda <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CD-outside-cda-sim-500.rds")[[1]]
i_ye_noncdaN <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CDN-outside-cda-sim-500.rds")[[1]]
i_ye_noncdaS <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CDS-outside-cda-sim-500.rds")[[1]]
# i_ye_5A <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A-sim-500.rds")[[1]]

i_ye_hbll <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-hbll-S-sim-500.rds")[[1]]

.dat <- bind_rows(
  # mutate(i_ye, Area = "Full combined"),
  # mutate(i_ye_hbll, Area = "HBLL grid only"),
  # mutate(i_ye_5A, Area = "5A"),
  mutate(i_ye_noncda, Area = "non-CDA 3CD5A"),
  mutate(i_ye_noncdaN, Area = "3CD5A N of 50º"),
  mutate(i_ye_noncdaS, Area = "non-CDA 3CD5A S of 50º"),
  mutate(i_ye_cda, Area = "CDA")
)

.dat$Area <- ordered(.dat$Area, levels = c("CDA", "non-CDA 3CD5A", "3CD5A N of 50º", "non-CDA 3CD5A S of 50º", "Full combined", "HBLL grid only"))
g_i_ye <- ggplot(.dat, aes(year, est/1000, fill = Area, colour = Area)) +
  geom_line(size = 1.25) +
  geom_ribbon(aes(ymin = lwr/1000, ymax = upr/1000), alpha = 0.2, colour = NA) +
  # geom_line(data = .dat1, linetype = 2) +
  xlab("Year") +
  ylab("Biomass index (tonnes)") +
  ggtitle("B. Yelloweye Rockfish") +
  coord_cartesian(#expand = FALSE, 
    ylim = c(0, max(.dat$upr)/1000)) +
  # scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
g_i_ye
ggsave("figs/filled-keepable-yelloweye-est-rock-mud-index-by-area.png", width = 7, height = 4, dpi = 400)
```


```{r}
g_i_hal  <- g_i_hal + theme(
  axis.title.x = element_blank(),axis.text.x = element_blank(),
  legend.position = "none")
g_i_ye <- g_i_ye + 
  coord_cartesian(#expand =F, 
    ylim = c(0, max(.datH$est)/1000)) +
  theme(
      # axis.title.y = element_blank(),axis.text.y = element_blank(),
      legend.position = c(0.75, 0.75))   

(g_i_hal / g_i_ye) + plot_layout() #guides = 'collect') & theme(legend.position = c(0.8, 0.8))

ggsave("figs/filled-keepable-rock-mud-index-by-area.png", width = 6, height = 7, dpi = 300)
```

```{r eval = F, message=F, echo=F}
i_hal_1 <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-3C-sim-500.rds")[[1]]
i_hal_2 <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-3D-sim-500.rds")[[1]]
i_hal_3 <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A-sim-500.rds")[[1]]
i_hal_4 <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5B-sim-500.rds")[[1]]

.datH <- bind_rows(
  mutate(i_hal_1, Area = "3C"),
  mutate(i_hal_2, Area = "3D"),
  mutate(i_hal_3, Area = "5A"),
  mutate(i_hal_4, Area = "5B")
)


# .datH$Area <- ordered(.datH$Area, levels = c("CDA", "non-CDA 3CD5A", "3CD5A N of 50º", "non-CDA 3CD5A S of 50º", "Full combined", "HBLL grid only"))
g_i_hal <- ggplot(.datH, aes(year, est/1000, fill = Area, colour = Area)) + # convert kg to tonnes
  geom_line(size = 1.25) +
  geom_ribbon(aes(ymin = lwr/1000, ymax = upr/1000), alpha = 0.2, colour = NA) +
  xlab("Year") +
  ylab("Biomass index (landable tonnes)") +
  ggtitle("A. Pacific Halibut") +
  coord_cartesian( #expand = FALSE, 
    ylim = c(0, max(.datH$upr)/1000)) +
  # scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
g_i_hal
ggsave("figs/filled-keepable-halibut-delta-est-rock-mud-index-by-region.png", width = 7, height = 4, dpi = 400)
```


```{r eval = F, message=F, echo=F}
i_ye_1 <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-3C-sim-500.rds")[[1]]
i_ye_2 <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-3D-sim-500.rds")[[1]]
i_ye_3 <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A-sim-500.rds")[[1]]
i_ye_4 <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-5B-sim-500.rds")[[1]]

.dat <- bind_rows(
  mutate(i_ye_1, Area = "3C"),
  mutate(i_ye_2, Area = "3D"),
  mutate(i_ye_3, Area = "5A"),
  mutate(i_ye_4, Area = "5B")
)

# .dat$Area <- ordered(.dat$Area, levels = c("CDA", "non-CDA 3CD5A", "3CD5A N of 50º", "non-CDA 3CD5A S of 50º", "Full combined", "HBLL grid only"))
g_i_ye <- ggplot(.dat, aes(year, est/1000, fill = Area, colour = Area)) +
  geom_line(size = 1.25) +
  geom_ribbon(aes(ymin = lwr/1000, ymax = upr/1000), alpha = 0.2, colour = NA) +
  # geom_line(data = .dat1, linetype = 2) +
  xlab("Year") +
  ylab("Biomass index (tonnes)") +
  ggtitle("B. Yelloweye Rockfish") +
  coord_cartesian(#expand = FALSE, 
    ylim = c(0, max(.dat$upr)/1000)) +
  # scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
g_i_ye
ggsave("figs/filled-keepable-yelloweye-est-rock-mud-index-by-region.png", width = 7, height = 4, dpi = 400)
```

## Estimated average catch through time

Average predicted catch within the entire court defined area is in red, remainder of the 5A3CD area is in blue.

### Pacific Halibut

```{r message = F, echo= F}
i_hal_cda <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-cda-sim-500.rds")[[1]]
i_hal_noncda <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A3CD-outside-cda-sim-500.rds")[[1]]
i_hal_noncdaN <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A3CDN-outside-cda-sim-500.rds")[[1]]
i_hal_noncdaS <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A3CDS-outside-cda-sim-500.rds")[[1]]

.datH <- bind_rows(
  mutate(i_hal_noncda,
    est = est / (sum(noncda_grid$area)/ 10000),
    lwr = lwr / (sum(noncda_grid$area)/ 10000),
    upr = upr /(sum(noncda_grid$area)/ 10000),
    Area = "non-CDA 3CD5A"
  ),
  mutate(i_hal_noncdaS,
    est = est / (sum(noncda_gridS$area)/ 10000),
    lwr = lwr / (sum(noncda_gridS$area)/ 10000),
    upr = upr / (sum(noncda_gridS$area)/ 10000),
    Area = "non-CDA 3CD5A S of 50º"
  ),
  mutate(i_hal_noncdaN,
    est = est / (sum(noncda_gridN$area)/ 10000),
    lwr = lwr / (sum(noncda_gridN$area)/ 10000),
    upr = upr / (sum(noncda_gridN$area)/ 10000),
    Area = "3CD5A N of 50º"
  ),

  mutate(i_hal_cda,
    est = est / (sum(cda_grid$area)/ 10000),
    lwr = lwr / (sum(cda_grid$area)/ 10000),
    upr = upr / (sum(cda_grid$area)/ 10000),
    Area = "CDA"
  )
)

.datH$Area <- ordered(.datH$Area, levels = c("CDA", "non-CDA 3CD5A", "3CD5A N of 50º", "non-CDA 3CD5A S of 50º"))

ggplot(.datH, aes(year, est)) +
  geom_line(aes(colour = Area), size = 1.5) +
  geom_ribbon(aes(
    ymin = lwr,
    ymax = upr, fill = Area
  ), alpha = 0.2) +
  xlab("Year") +
  ylab("Biomass density (kg/ha)") +
  # scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/filled-keepable-halibut-delta-est-rock-mud-average-index-NS.png", width = 7, height = 4, dpi = 400)

g_a_hal  <- ggplot(filter(.datH, Area %in% c("CDA", "non-CDA 3CD5A")), aes(year, est)) +
  geom_line(aes(colour = Area), size = 1.5) +
  geom_ribbon(aes(
    ymin = lwr,
    ymax = upr, fill = Area
  ), alpha = 0.2) +
  xlab("Year") +
  ylim(0, max(.datH$upr)) +
  ylab("Biomass density (landable kg/ha)") +
  # scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/filled-keepable-halibut-delta-est-rock-mud-average-index.png", width = 7, height = 4, dpi = 400)
```

### Yelloweye Rockfish

```{r message = F, echo= F}
i_ye_cda <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-cda-sim-500.rds")[[1]]
i_ye_noncda <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CD-outside-cda-sim-500.rds")[[1]]
i_ye_noncdaN <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CDN-outside-cda-sim-500.rds")[[1]]
i_ye_noncdaS <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CDS-outside-cda-sim-500.rds")[[1]]


.dat <- bind_rows(
  mutate(i_ye_noncda,
    est = est / (sum(noncda_grid$area)/ 10000),
    lwr = lwr / (sum(noncda_grid$area)/ 10000),
    upr = upr /(sum(noncda_grid$area)/ 10000),
    Area = "non-CDA 3CD5A"
  ),
  mutate(i_ye_noncdaN,
    est = est / (sum(noncda_gridN$area)/ 10000),
    lwr = lwr / (sum(noncda_gridN$area)/ 10000),
    upr = upr / (sum(noncda_gridN$area)/ 10000),
    Area = "3CD5A N of 50º"
  ),
  mutate(i_ye_noncdaS,
    est = est / (sum(noncda_gridS$area)/ 10000),
    lwr = lwr / (sum(noncda_gridS$area)/ 10000),
    upr = upr / (sum(noncda_gridS$area)/ 10000),
    Area = "non-CDA 3CD5A S of 50º"
  ),
  mutate(i_ye_cda,
    est = est / (sum(cda_grid$area)/ 10000),
    lwr = lwr / (sum(cda_grid$area)/ 10000),
    upr = upr / (sum(cda_grid$area)/ 10000),
    Area = "CDA"
  )
)

.dat$Area <- ordered(.dat$Area, levels = c("CDA", "non-CDA 3CD5A", "3CD5A N of 50º", "non-CDA 3CD5A S of 50º"))


ggplot(.dat, aes(year, est)) +
  geom_line(aes(colour = Area), size = 1.5) +
  geom_ribbon(aes(
    ymin = lwr,
    ymax = upr, fill = Area
  ), alpha = 0.2) +
  xlab("Year") +
  ylab("Biomass density (kg/ha)") +
  # scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/filled-keepable-yelloweye-est-rock-mud-average-index-NS.png", width = 7, height = 4, dpi = 400)

g_a_ye <- ggplot(filter(.dat, Area %in% c("CDA", "non-CDA 3CD5A")), aes(year, est)) +
  geom_line(aes(colour = Area), size = 1.5) +
  geom_ribbon(aes(
    ymin = lwr,
    ymax = upr, fill = Area
  ), alpha = 0.2) +
  #
  xlab("Year") +
  ylab("Biomass density (kg/ha)") +
  # scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/filled-keepable-yelloweye-est-rock-mud-average-index.png", width = 7, height = 4, dpi = 400)
```

```{r}
g_a_hal  <- g_a_hal + 
  labs(tag ="A.") +
  theme(plot.tag.position = c(0.15,0.9),
  axis.title.x = element_blank(),
  axis.text.x = element_blank(),
  legend.position = "none")
g_a_ye <- g_a_ye + labs(tag ="B.") +
  theme(plot.tag.position = c(0.15,0.9),
      # axis.title.y = element_blank(),
      # axis.text.y = element_blank(),
      # axis.ticks.y = element_blank(),
      legend.position = c(0.75, 0.8))   

(g_a_hal /g_a_ye) + plot_layout() #guides = 'collect') & theme(legend.position = c(0.8, 0.8))
ggsave("figs/filled-keepable-rock-mud-avg-by-area.png", width = 5.5, height = 5.5, dpi = 300)
# # horizontal orientation
# g_a_hal  <- g_a_hal + theme(
#   axis.title.x = element_blank(),
#   # axis.text.x = element_blank(),
#   legend.position = "none")
# g_a_ye <- g_a_ye +  ylim(0, max(.datH$upr)) +
#   theme(
#       axis.title = element_blank(),
#       axis.text.y = element_blank(),
#       axis.ticks.y = element_blank(),
#       legend.position = c(0.75, 0.75))   

# (g_a_hal + g_a_ye) + plot_layout() #guides = 'collect') & theme(legend.position = c(0.8, 0.8))

# ggsave("figs/filled-keepable-rock-mud-avg-by-area.png", width = 10, height = 4, dpi = 300)

```


# Calculate predicted catch rates in the different areas

```{r}
i_hal2 <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-all-S-sim-500.rds")[[2]]
i_hal_cda2 <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-cda-sim-500.rds")[[2]]
i_hal_noncda2 <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A3CD-outside-cda-sim-500.rds")[[2]]
i_hal_noncda2N <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A3CDN-outside-cda-sim-500.rds")[[2]]
i_hal_noncda2S <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A3CDS-outside-cda-sim-500.rds")[[2]]
# i_hal_5A2 <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-5A-sim-500.rds")[[2]]

.dat2 <- bind_rows(
  mutate(i_hal2, Area = "Full combined", area_size = (sum(full_s_grid$area)/ 10000)),
  # mutate(i_hal_5A2, Area = "5A", num_cells = nrow(s_5A_grid)),
  mutate(i_hal_noncda2, Area = "non-CDA 3CD5A", area_size = (sum(noncda_grid$area)/ 10000)),
  mutate(i_hal_noncda2N, Area = "3CD5A N of 50º", area_size = (sum(noncda_gridN$area)/ 10000)),
  mutate(i_hal_noncda2S, Area = "non-CDA 3CD5A S of 50º", area_size = (sum(noncda_gridS$area)/ 10000)),
  mutate(i_hal_cda2, Area = "CDA", area_size = (sum(cda_grid$area)/ 10000))
)
.dat2$Area <- ordered(.dat2$Area, levels = c("CDA", "non-CDA 3CD5A", "3CD5A N of 50º", "non-CDA 3CD5A S of 50º", "Full combined"))

i_hal_2020 <- filter(.dat2, year == 2020) #%>% filter(.iteration <= 200)

dens_per_hectare <- i_hal_2020 %>%
  group_by(Area) %>%
  summarise(
    catch = mean(.value / area_size),
    catch_med = median(.value / area_size),
    catch_lwr = quantile(.value / area_size, 0.025),
    catch_upr = quantile(.value / area_size, 0.975)
  )

saveRDS(dens_per_hectare, "report-data/dens_per_hectare.rds")
```

```{r}
i_ye2 <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-all-S-sim-500.rds")[[2]]
i_ye_cda2 <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-cda-sim-500.rds")[[2]]
i_ye_noncda2 <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CD-outside-cda-sim-500.rds")[[2]]
i_ye_noncda2N <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CDN-outside-cda-sim-500.rds")[[2]]
i_ye_noncda2S <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A3CDS-outside-cda-sim-500.rds")[[2]]
# i_ye_5A2 <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-index-5A-sim-500.rds")[[2]]

.dat2 <- bind_rows(
  mutate(i_ye2, Area = "Full combined", area_size = (sum(full_s_grid$area)/ 10000)),
  # mutate(i_ye_5A2, Area = "5A", num_cells = nrow(s_5A_grid)),
  mutate(i_ye_noncda2, Area = "non-CDA 3CD5A", area_size = (sum(noncda_grid$area)/ 10000)),
  mutate(i_ye_noncda2N, Area = "3CD5A N of 50º", area_size = (sum(noncda_gridN$area)/ 10000)),
  mutate(i_ye_noncda2S, Area = "non-CDA 3CD5A S of 50º", area_size = (sum(noncda_gridS$area)/ 10000)),
  mutate(i_ye_cda2, Area = "CDA", area_size = (sum(cda_grid$area)/ 10000))
)
.dat2$Area <- ordered(.dat2$Area, levels = c("CDA", "non-CDA 3CD5A", "3CD5A N of 50º", "non-CDA 3CD5A S of 50º", "Full combined"))

i_ye_2020 <- filter(.dat2, year == 2020)# %>% filter(.iteration <= 200)

ye_dens_per_hectare <- i_ye_2020 %>%
  group_by(Area) %>%
  summarise(
    catch = mean(.value / area_size),
    catch_med = median(.value / area_size),
    catch_lwr = quantile(.value / area_size, 0.025),
    catch_upr = quantile(.value / area_size, 0.975)
  )

saveRDS(ye_dens_per_hectare, "report-data/ye_dens_per_hectare.rds")
```


```{r message=F, echo=F}
ggplot(i_hal_2020 %>% filter(Area %in% c("CDA","3CD5A N of 50º", "non-CDA 3CD5A S of 50º", "non-CDA 3CD5A"))) + geom_histogram(aes(.value / area_size, 
  fill = Area
  ), alpha = 0.5
  #, fill = "black"
  ) +
  geom_histogram(data = i_ye_2020 %>% filter(Area %in% c("CDA", "non-CDA 3CD5A", "3CD5A N of 50º", "non-CDA 3CD5A S of 50º")), 
    aes(.value / area_size, fill = Area), alpha = 0.75) +
  geom_vline(data = dens_per_hectare%>% filter(Area %in% c("CDA", "non-CDA 3CD5A", "3CD5A N of 50º", "non-CDA 3CD5A S of 50º")),
    aes(xintercept = catch_med,
    colour = Area
    ), linetype = 2, alpha = 0.5
    #, colour = "black"
    ) +
  geom_vline(data = ye_dens_per_hectare %>% 
      filter(Area %in% c("CDA", "non-CDA 3CD5A", "3CD5A N of 50º", "non-CDA 3CD5A S of 50º")), 
    aes(xintercept = catch_med, colour = Area), linetype = 2) +
  facet_grid(rows = vars(Area)) + xlab("Mean kg/ha") + ylab("Number of simulations") +
  scale_fill_brewer(palette = "Set1") + scale_colour_brewer(palette = "Set1") + theme(legend.position = "none") +
  ggtitle("Estimated 2020 biomass densities (dashed lines are median)",
    subtitle = "Yelloweye Rockfish (darker bars) vs. Pacific Halibut (paler bars)"
  )

ggsave("figs/filled-keepable-est-rock-mud-estimated-biomass-densities.png", width = 6, height = 7, dpi = 400)
```


# What proportion of estimated total catch is inside CDA in 2020?

What proportion of 5A3CD HBLL + trawl survey grid is inside CDA?

`r round(nrow(cda_grid) / (nrow(cda_grid) + nrow(noncda_grid)), 2)`

```{r echo=F, message=F, warning=F}
# clearly wrong at the moment because simulations producing numerator and denominator are not actually the same
hal_ratios <- i_hal_2020 %>%
    dplyr::select(-area_size, -region) %>%
  pivot_wider(names_from = Area, values_from = .value) %>%
  group_by(.iteration) %>%
  mutate(CDAto5A3CD = CDA / (CDA + `non-CDA 3CD5A S of 50º` + `3CD5A N of 50º`),
    CDAtoFull = CDA / (`Full combined`),
    prop5A3CDN = `3CD5A N of 50º`/(`non-CDA 3CD5A S of 50º` + `3CD5A N of 50º`),
    prop5A3CDS = `non-CDA 3CD5A S of 50º`/(`non-CDA 3CD5A S of 50º` + `3CD5A N of 50º`)
    )

mean_hal_ratios <- hal_ratios %>%
  pivot_longer(cols = c(CDAto5A3CD, prop5A3CDN, prop5A3CDS), names_to = "area", values_to = "ratio") %>%
  group_by(area) %>%
  summarise(
    ratio_mean = mean(ratio),
    ratio_med = median(ratio),
    ratio_lwr = quantile(ratio, 0.025),
    ratio_upr = quantile(ratio, 0.975)
  )
saveRDS(mean_hal_ratios, "report-data/mean_hal_ratios.rds")

ggplot(hal_ratios) +
  geom_histogram(aes(CDAto5A3CD), fill = "red", alpha = 0.75) +
  # geom_histogram(aes(CDAtoFull), fill = "black", alpha = 0.5) +
  geom_histogram(aes(prop5A3CDN), fill = "darkgreen", alpha = 0.5) +
  geom_histogram(aes(prop5A3CDS), fill = "blue", alpha = 0.5) +
  geom_vline(data = mean_hal_ratios, aes(xintercept = ratio_med), linetype = 2) +
  xlim(0, 1) +
  xlab("Proportion of total biomass relative to all of 3CD5A") + ylab("Number of simulations") +
  ggtitle("Pacific Halibut survey biomass in CDA (red), S of 50 (blue), and N of 50 (green)")
ggsave("figs/filled-keepable-halibut-delta-est-rock-mud-relative-biomass.png", width = 7, height = 3, dpi = 400)
```

```{r echo=F, message=F, warning=F}
ye_ratios <- i_ye_2020 %>%
  dplyr::select(-area_size, -region) %>%
  pivot_wider(names_from = Area, values_from = .value) %>%
  group_by(.iteration) %>%
  mutate(CDAto5A3CD = CDA / (CDA + `non-CDA 3CD5A S of 50º` + `3CD5A N of 50º`),
    # CDAto5A3CD = CDA / (CDA + `non-CDA 3CD5A`),
    prop5A3CDN = `3CD5A N of 50º`/(`non-CDA 3CD5A S of 50º` + `3CD5A N of 50º`),
    prop5A3CDS = `non-CDA 3CD5A S of 50º`/(`non-CDA 3CD5A S of 50º` + `3CD5A N of 50º`)
    )

mean_ye_ratios <- ye_ratios %>%
  pivot_longer(cols = c(CDAto5A3CD, prop5A3CDN, prop5A3CDS), names_to = "area", values_to = "ratio") %>%
  group_by(area) %>%
  summarise(
    ratio_mean = mean(ratio),
    ratio_med = median(ratio),
    ratio_lwr = quantile(ratio, 0.025),
    ratio_upr = quantile(ratio, 0.975)
  )
saveRDS(mean_ye_ratios, "report-data/mean_ye_ratios.rds")

ggplot(ye_ratios) +
  geom_histogram(aes(CDAto5A3CD), fill = "red", alpha = 0.75) +
  # geom_histogram(aes(CDAtoFull), fill = "black", alpha = 0.5) +
  geom_histogram(aes(prop5A3CDN), fill = "darkgreen", alpha = 0.5) +
  geom_histogram(aes(prop5A3CDS), fill = "blue", alpha = 0.5) +
  geom_vline(data = mean_ye_ratios, aes(xintercept = ratio_med), linetype = 2) +
  xlim(0, 1) +
  xlab("Proportion of total biomass relative to all of 3CD5A") + ylab("Number of simulations") +
  ggtitle("Yelloweye Rockfish survey biomass in CDA (red), S of 50 (blue), and N of 50 (green)")
ggsave("figs/filled-keepable-yelloweye-est-rock-mud-relative-biomass.png", width = 7, height = 3, dpi = 400)
```

# Correlations between species

### Merge survey catches
```{r}
# glimpse(d_ye_plots)
# glimpse(d_hal_plots) 
d_hal_plotsN <- readRDS("data-generated/halibut-model-data-keepable-weight.rds") %>%
  # plot observations for last 3 years to ensure sampling in all regions
  filter(latitude > 50.01 & latitude < 51.4) %>%
  # filter(year %in% c(#2017,
  #   2018,2019,2020)) %>%  
  mutate(
    # back transform densities into catch per 100 hooks
    catch_equiv = round(density * (100 * 0.0024384 * 0.009144 * 10000) / halmeanweight), 
    max_count = round((max(catch_count, na.rm = T)/mean(hook_count, na.rm = T))*100),
    catch_equiv2 = ifelse(catch_equiv < max_count, catch_equiv, max_count)
    )

d_ye_plotsN <- readRDS("data-generated/yelloweye-model-data-hbll-weights.rds") %>%
  filter(latitude > 50.01 & latitude < 51.4) %>% 
  # filter(year %in% c(#2017,
  #   2018,2019,2020)) %>% 
  mutate(
    # back transform densities into catch per 100 hooks
    catch_equiv = round(density * (100 * 0.0024384 * 0.009144 * 10000) / yemeanweight), 
    max_count = round((max(catch_count, na.rm = T)/mean(hook_count, na.rm = T))*100),
    catch_equiv2 = ifelse(catch_equiv < max_count, catch_equiv, max_count)
    )

ye_obs <- d_ye_plotsN %>% 
  mutate(catch_count_ye = (catch_count/hook_count)*100, catch_equiv_ye = catch_equiv) %>% 
  select(X,Y, depth = depth_m, year_pair, year_true, survey, catch_count_ye, density_ye = density, fishing_event_id, catch_equiv_ye)
hal_obs <- d_hal_plotsN %>% 
  mutate(catch_count_hal = (catch_count/hook_count)*100, catch_equiv_hal = catch_equiv) %>% 
  select(fishing_event_id, catch_count_hal, density_hal = density, catch_equiv_hal)
catch_compN <- left_join(ye_obs, hal_obs)%>% filter(depth < 200)


# glimpse(d_ye_plots)
# glimpse(d_hal_plots) 
d_hal_plotsS <- readRDS("data-generated/halibut-model-data-keepable-weight.rds") %>%
  # plot observations for last 3 years to ensure sampling in all regions
  filter(latitude < 50.01) %>%
  # filter(year %in% c(#2017,
  #   2018,2019,2020)) %>%  
  mutate(
    # back transform densities into catch per 100 hooks
    catch_equiv = round(density * (100 * 0.0024384 * 0.009144 * 10000) / halmeanweight), 
    max_count = round((max(catch_count, na.rm = T)/mean(hook_count, na.rm = T))*100),
    catch_equiv2 = ifelse(catch_equiv < max_count, catch_equiv, max_count)
    )

d_ye_plotsS <- readRDS("data-generated/yelloweye-model-data-hbll-weights.rds") %>%
  filter(latitude < 50.01)  %>% 
  # filter(year %in% c(#2017,
  #   2018,2019,2020)) %>% 
  mutate(
    # back transform densities into catch per 100 hooks
    catch_equiv = round(density * (100 * 0.0024384 * 0.009144 * 10000) / yemeanweight), 
    max_count = round((max(catch_count, na.rm = T)/mean(hook_count, na.rm = T))*100),
    catch_equiv2 = ifelse(catch_equiv < max_count, catch_equiv, max_count)
    )

ye_obs <- d_ye_plotsS %>% 
  mutate(catch_count_ye = (catch_count/hook_count)*100, catch_equiv_ye = catch_equiv) %>% 
  select(X,Y, depth = depth_m, year_pair, year_true, survey, catch_count_ye, density_ye = density, fishing_event_id, catch_equiv_ye)
hal_obs <- d_hal_plotsS %>% 
  mutate(catch_count_hal = (catch_count/hook_count)*100, catch_equiv_hal = catch_equiv) %>% 
  select(fishing_event_id, catch_count_hal, density_hal = density, catch_equiv_hal)
catch_compS <- left_join(ye_obs, hal_obs) %>% filter(depth < 200)
```

```{r}

focal_area <- sf::st_read(dsn = "shape-files/taaqwiihak_areaVer2.shp",
    layer = "taaqwiihak_areaVer2", quiet = TRUE)
focal_area_proj <- sf::st_transform(focal_area, crs = 3156)

catch_compS <- catch_compS %>% mutate (X2 = X*100000, Y2 = Y*100000)
catch_compS_sf <- st_as_sf(catch_compS, coords = c("X2", "Y2"), crs = 3156)
# catch_compS_sf <- st_transform(catch_compS_sf, crs = 3156)
keep <- st_intersects(focal_area_proj, catch_compS_sf)
catch_compS_cda <- catch_compS_sf[unlist(keep), ]
```



```{r}
p1 <- ggplot(catch_compN, aes(log(density_hal+1), log(density_ye+1))) + 
  geom_smooth(data = filter(catch_compN, survey == "TRAWL"), method = "lm", fill = "#4DAF4A", colour = "#4DAF4A") +
  geom_jitter(data = filter(catch_compN, survey == "TRAWL"), alpha=0.5, colour = "#4DAF4A") + 
  xlim(0, log(max(catch_compN$density_hal, na.rm = T)+1)) +
  ylab("log( YE density + 1)") +
  xlab("log(landable halibut density + 1)") +
  coord_cartesian()+ ggtitle("A. Trawl survey north of 50º latitude")


p2 <-ggplot(catch_compN, aes(log(catch_count_hal+1), log(catch_count_ye+1))) + 
  geom_smooth(method = "lm", fill = "#4DAF4A", colour = "#4DAF4A") +
  geom_jitter(alpha=0.5, colour = "#4DAF4A") +   
  # coord_cartesian(expand = F, xlim = c(0, log(max(catch_compN$catch_count_hal, na.rm = T)+1))) +
  xlim(0, log(max(catch_compN$catch_count_hal, na.rm = T)+1)) +
  ylab("log( YE catch count + 1)") +
  xlab("log( Halibut catch count + 1)") +
  coord_cartesian()+ ggtitle("A. HBLL survey north of 50º latitude")

# ggplot(catch_compN, aes(density_hal, density_ye)) + 
#   geom_smooth(method = "lm", colour = "grey") +
#   geom_jitter(aes(colour = survey)) + 
#   coord_cartesian(xlim=c(0, 3))

p3 <-ggplot(catch_compS, aes(log(density_hal+1), log(density_ye+1))) + 
  geom_smooth(data = filter(catch_compS, survey == "TRAWL"), method = "lm",fill = "#984EA3", colour = "#984EA3") +
  geom_jitter(data = filter(catch_compS, survey == "TRAWL"), alpha = 0.5, colour = "#984EA3") + 
  geom_point(data = catch_compS_cda, alpha = 0.5, colour = "red") +
  xlim(0, log(max(catch_compN$density_hal, na.rm = T)+1)) +
  ylab("log( YE density + 1)") +
  xlab("log(landable halibut density + 1)") +
  coord_cartesian()+ ggtitle("B. Trawl survey south of 50º latitude")

p4 <-ggplot(catch_compS, aes(log(catch_count_hal+1), log(catch_count_ye+1))) + 
  geom_smooth(method = "lm",fill = "#984EA3", colour = "#984EA3") + #"#E41A1C" "#377EB8" "#4DAF4A" "#984EA3"
  geom_jitter(alpha=0.5, colour = "#984EA3") +   
  geom_point(data = catch_compS_cda, alpha = 0.5, colour = "red") +
  # coord_cartesian(expand = F, xlim = c(0, log(max(catch_compN$catch_count_hal, na.rm = T)+1))) +
  xlim(0, log(max(catch_compN$catch_count_hal, na.rm = T)+1)) +
  ylab("log( YE catch count + 1)") +
  xlab("log( halibut catch count + 1)") +
  coord_cartesian()+ ggtitle("B. HBLL survey south of 50º latitude")

library(patchwork)
# p1 + p3 + plot_layout(nrow = 2)
p2 <-p2 + theme(axis.title.x = element_blank(),  axis.text.x = element_blank(),  axis.ticks.x = element_blank())
p2 + p4 + plot_layout(nrow = 2)
ggsave("figs/catch-correlations-hbll.png", width = 3.5, height = 5.5, dpi = 400)


p1 <-p1 + theme(axis.title.x = element_blank(),  axis.text.x = element_blank(),  axis.ticks.x = element_blank())
p1 + p3 + plot_layout(nrow = 2)
ggsave("figs/catch-correlations-trawl.png", width = 3.5, height = 5.5, dpi = 400)


# ggplot(catch_compS, aes(density_hal, density_ye)) + 
#   geom_smooth(method = "lm", colour = "grey") +
#   geom_jitter(aes(colour = survey)) + 
#   coord_cartesian(xlim=c(0, 3))
```

### Predictions
```{r}
p_hal2020 <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-predictions-all-S.rds")[[1]] %>%
  # filter(latitude < max_map_lat) %>% 
  filter(year == 2020) %>% 
  filter(area >= 3000000) %>%
  select(X,Y, depth, est, region) %>% rename(hal_est = est) 

p_ye2020 <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-predictions-all-S.rds")[[1]] %>%
  # filter(latitude < max_map_lat) %>% 
  filter(area >= 3000000) %>%
  filter(year == 2020) %>% select(X,Y, depth, est, region) %>% rename(ye_est = est) 


# max(cda_grid$depth)
p_both <- left_join(p_hal2020, p_ye2020) %>% filter(region != "other")
p_both2 <- left_join(p_hal2020, p_ye2020) %>% filter(region %in% c("3CD5A N", "non-CDA 3CD5A S")) %>% 
  filter(depth < max(cda_grid$depth)) %>% mutate(region = "non-CDA 3CD5A")

p_both <- bind_rows(p_both, p_both2)

p_both$region <- ordered(p_both$region, 
  levels = c("3CD5A N", "non-CDA 3CD5A S", "CDA", "non-CDA 3CD5A"), 
  labels = c("3CD5A N of 50º", "3CD5A S of 50º", "CDA", "non-CDA 3CD5A (< 130 m)"))

p_both %>% filter(region %in% c("CDA", "non-CDA 3CD5A (< 130 m)")) %>%
ggplot(., 
    aes(log(exp(hal_est)+1), log(exp(ye_est)+1), colour= region, fill= region)
    # aes(exp(hal_est), exp(ye_est), colour= region)
    ) + geom_point(alpha=0.1) + 
  # scale_fill_manual(values = c("red", "#4DAF4A", "#984EA3")) +
  # scale_colour_manual(values = c("red", "#4DAF4A", "#984EA3")) +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1") +
  # scale_y_log10() + scale_x_log10() +
    geom_smooth(method = "lm") + 
  xlab("Landable halibut (log(kg/ha + 1))") +
  ylab("YE (log(kg/ha + 1))")+
  coord_cartesian(expand = F) +
  # facet_wrap(~region
  facet_grid(rows=vars(region)
    # , scales = "free_y"
    ) + ggsidekick::theme_sleek() + theme(legend.position = "none")


ggsave("figs/predicted-correlations-cda.png", width = 3.5, height = 5.5, dpi = 400)

p_cda_overlay <- p_both %>% filter(region %in% c("CDA")) %>% mutate(region = "3CD5A S of 50º") 


p_both %>% 
  filter(region != "non-CDA 3CD5A (< 130 m)") %>%
  #filter(region %in% c("3CD5A N of 50º", "3CD5A S of 50º")) %>%
ggplot(., 
    aes(log(exp(hal_est)+1), log(exp(ye_est)+1), colour= region, fill= region)
    # aes(exp(hal_est), exp(ye_est), colour= region)
    ) + 
  geom_point(alpha=0.2) + 
  # geom_point(data=p_cda_overlay, colour= "red", alpha = 0.2) +
  scale_fill_manual(values = c("#4DAF4A", "#984EA3", "red")) +
  scale_colour_manual(values = c("#4DAF4A", "#984EA3", "red")) +
  # scale_y_log10() + scale_x_log10() +
    geom_smooth(method = "lm") + 
  xlab("Landable halibut ( log(kg/ha + 1) )") +
  ylab("YE ( log(kg/ha + 1) )")+
  coord_cartesian(expand = F) +
  # facet_wrap(~region
  facet_grid(
    # rows=vars(region)
    cols=vars(region)
    , scales = "free"
    ) + ggsidekick::theme_sleek() + theme(legend.position = "none")

# ggsave("figs/predicted-correlations-NS.png", width = 3.5, height = 5.5, dpi = 400)
ggsave("figs/predicted-correlations.png", width = 5.5, height = 2.5, dpi = 400)

p_both %>% filter(region %in% c("3CD5A N of 50º", "3CD5A S of 50º")) %>%
  filter(depth < max(cda_grid$depth)) %>%
ggplot(., 
    aes(log(exp(hal_est)+1), log(exp(ye_est)+1), colour= region, fill= region)
    # aes(exp(hal_est), exp(ye_est), colour= region)
    ) + 
  geom_point(alpha=0.2) + 
  geom_point(data=p_cda_overlay, colour= "red", alpha = 0.2) +
  scale_fill_manual(values = c("#4DAF4A", "#984EA3")) +
  scale_colour_manual(values = c("#4DAF4A", "#984EA3")) +
  # scale_y_log10() + scale_x_log10() +
    geom_smooth(method = "lm") + 
  xlab("Landable halibut (log(kg/ha + 1))") +
  ylab("YE (log(kg/ha + 1))")+
  # coord_cartesian(expand = F) +
  # facet_wrap(~region
  facet_grid(rows=vars(region)
    # , scales = "free_y"
    ) + ggsidekick::theme_sleek() + theme(legend.position = "none")

ggsave("figs/predicted-correlations-depth-matched.png", width = 3.5, height = 5.5, dpi = 400)

```


### Check commercial catch ratios 
(if data available)

```{r eval=F}
# only works on network
cye <- get_cpue_spatial_ll("yelloweye rockfish")
chal <- get_cpue_spatial_ll("pacific halibut")

cye2 <- cye %>% rename(ye_cpue = cpue,
                       ye_kg = landed_round_kg,
                       ye_realeased = total_released_pcs) %>%
                select(-species_code, -species_common_name, -species_scientific_name)
chal2 <- chal %>% rename(hal_cpue = cpue,
                       hal_kg = landed_round_kg,
                       hal_realeased = total_released_pcs) %>%
                select(-species_code, -species_common_name, -species_scientific_name)
both <- full_join(chal2, cye2)
cc <- both %>% select(-ye_realeased, -vessel_registration_number, - trip_id, -fishing_event_id)
saveRDS(cc, "hal-ye-ll-cpue-anon.rds")
```


```{r eval=F}
library(lubridate)

cc <- readRDS("data/hal-ye-ll-cpue-anon.rds") %>% 
  filter(fishery_sector %in% c("halibut", "halibut and sablefish")) %>%
  # filter(fishery_sector %in% c("halibut")) %>% 
  filter(major_stat_area_code %in% c("03","04","05")) %>% 
  # season based on summer shallow period versus winter deep period Loher 2011
  mutate(month = month(best_date), season = ifelse(month>4 & month<9, "Summer", "Winter"))

cc$hal_cpue[is.na(cc$hal_cpue)] <- 0
cc$hal_kg[is.na(cc$hal_kg)] <- 0
cc$ye_cpue[is.na(cc$ye_cpue)] <- 0
cc$ye_kg[is.na(cc$ye_kg)] <- 0

unique(cc$fishery_sector)

ccN <- cc %>% filter(lat >= 50.01)  
ccS <- cc %>% filter(lat < 50.01)  
ccN$region <- "3CD5A N of 50º"
ccS$region <- "3CD5A S of 50º"

focal_area <- sf::st_read(dsn = "shape-files/taaqwiihak_areaVer2.shp",
    layer = "taaqwiihak_areaVer2", quiet = TRUE)
focal_area_proj <- sf::st_transform(focal_area, crs = 3156)

ccS_sf <- st_as_sf(ccS, coords = c("lon","lat"), crs = 4326)
ccS_sf <- st_transform(ccS_sf, crs = 3156)
keep <- st_intersects(focal_area_proj, ccS_sf)
ccS_cda <- ccS_sf[unlist(keep), ]
st_geometry(ccS_cda) <- NULL
ccS_cda$region <- "CDA"

cc <- bind_rows(ccN, ccS) %>% select(-lat, -lon)
cc <- bind_rows(cc,ccS_cda)

cc %>% 
  # filter(year %in% c(2017, 2018, 2019, 2020, 2021)) %>%
ggplot(., 
    aes(
      log(hal_cpue+1), log(ye_cpue+1),
      colour= region, fill= region)
    ) + geom_point(alpha=0.1) + 
    geom_smooth(method = "lm") + 
  scale_fill_manual(values = c("#4DAF4A", "#984EA3", "red")) +
  scale_colour_manual(values = c("#4DAF4A", "#984EA3", "red")) +
  xlab("Landable halibut ( log(CPUE + 1) )") +
  ylab("YE ( log(CPUE + 1) )")+
  coord_cartesian(expand = F) +
  # facet_wrap(~region
  facet_grid(
    # rows=vars(region),cols=vars(season)
    cols=vars(region),rows=vars(season)
    ) + ggsidekick::theme_sleek() + theme(legend.position = "none")

# ggsave("figs/commercial-correlations-by-region-season.png", width = 3.5, height = 5.5, dpi = 400)
ggsave("figs/commercial-correlations-by-region-season2.png", width = 5.5, height = 4, dpi = 400)

ggplot(cc, 
    aes(
      # hal_cpue, ye_cpue,
      log(hal_cpue+1), log(ye_cpue+1),
      colour= as.factor(year), fill= as.factor(year))
    ) + 
    geom_smooth(method = "lm", se = T, alpha =0.15) + 
  scale_fill_viridis_d("Year")+
  scale_color_viridis_d("Year")+
  xlab("Landable halibut ( log(CPUE + 1) )") +
  ylab("YE ( log(CPUE + 1) )")+
  coord_cartesian(expand = F, ylim = c(0,3.5), xlim = c(0,5)) +
  facet_grid(cols=vars(region)
    ,rows=vars(fishery_sector)
    ) + ggsidekick::theme_sleek() #+ theme(legend.position = "none")

# ggsave("figs/commercial-correlations-by-year-all-sectors.png", width = 5.5, height = 3.5, dpi = 400)
ggsave("figs/commercial-correlations-by-year-by-sectors.png", width = 5.5, height = 8.5, dpi = 400)

cc %>% filter(region != "CDA") %>%
ggplot(
    aes(
      # hal_cpue, ye_cpue,
      log(hal_cpue+1), log(ye_cpue+1),
      colour= as.factor(year), fill= as.factor(year))
    ) + 
    geom_smooth(method = "lm", se = T, alpha =0.15) + 
  scale_fill_viridis_d("Year")+
  scale_color_viridis_d("Year")+
  xlab("Landable halibut ( log(CPUE + 1) )") +
  ylab("YE ( log(CPUE + 1) )")+
  coord_cartesian(expand = F, ylim = c(0,3.5), xlim = c(0,5)) +
  facet_grid(
    # rows=vars(region),cols=vars(season)
    cols=vars(region), rows=vars(season)
    ) + ggsidekick::theme_sleek() #+ theme(legend.position = "none")

# ggsave("figs/commercial-correlations-by-year-all-sectors.png", width = 5.5, height = 3.5, dpi = 400)

# ggsave("figs/commercial-correlations-by-year-by-season.png", width = 4.5, height = 5.5, dpi = 400)
ggsave("figs/commercial-correlations-by-year-by-season2.png", width = 5.5, height = 4, dpi = 400)

```


# Ratio of Yelloweye to Halibut through time

```{r message=F, echo=F, warning=F}
i_ye_noncda2Nb <- i_ye_noncda2N %>% rename(N = .value) %>% dplyr::select(-region)
i_ye_noncda2Sb <- i_ye_noncda2S %>% rename(S = .value) %>% dplyr::select(-region)
i_ye_noncda2 <- left_join(i_ye_noncda2Nb, i_ye_noncda2Sb) %>% mutate(.value = N + S) %>% dplyr::select(-S,-N)

.i_ye <- bind_rows(
  # mutate(i_ye2, Area = "Full combined", num_cells = nrow(full_s_grid)),
  # mutate(i_ye_5A2, Area = "5A", num_cells = nrow(s_5A_grid)),
  mutate(i_ye_noncda2, Area = "non-CDA 3CD5A", num_cells = sum(noncda_gridN$area)/10000 + sum(noncda_gridS$area)/10000),
  mutate(i_ye_noncda2N, Area = "3CD5A N of 50º", num_cells = sum(noncda_gridN$area)/10000),
  mutate(i_ye_noncda2S, Area = "non-CDA 3CD5A S of 50º", num_cells = sum(noncda_gridS$area)/10000),
  mutate(i_ye_cda2, Area = "CDA", num_cells = sum(cda_grid$area)/10000)
) %>%   filter(.iteration <= 500) %>%
  rename(yelloweye = .value) 

.i_ye$Area <- ordered(.i_ye$Area, 
  levels = c("CDA", "non-CDA 3CD5A", "3CD5A N of 50º", "non-CDA 3CD5A S of 50º", "Full combined"))


i_hal_noncda2Nb <- i_hal_noncda2N %>% rename(N = .value) %>% dplyr::select(-region)
i_hal_noncda2Sb <- i_hal_noncda2S %>% rename(S = .value) %>% dplyr::select(-region)
i_hal_noncda2 <- left_join(i_hal_noncda2Nb, i_hal_noncda2Sb) %>% mutate(.value = N + S) %>% dplyr::select(-S,-N)

.i_hal <- bind_rows(
  # mutate(i_hal2, Area = "Full combined", num_cells = nrow(full_s_grid)),
  # mutate(i_hal_5A2, Area = "5A", num_cells = nrow(s_5A_grid)),
  mutate(i_hal_noncda2, Area = "non-CDA 3CD5A", num_cells =sum(noncda_gridN$area)/10000 + sum(noncda_gridS$area)/10000),
  mutate(i_hal_noncda2N, Area = "3CD5A N of 50º", num_cells = sum(noncda_gridN$area)/10000),
  mutate(i_hal_noncda2S, Area = "non-CDA 3CD5A S of 50º", num_cells = sum(noncda_gridS$area)/10000),
  mutate(i_hal_cda2, Area = "CDA", num_cells = sum(cda_grid$area)/10000)
) %>% filter(.iteration <= 500) %>%
  rename(halibut = .value)

.i_hal$Area <- ordered(.i_hal$Area, 
  levels = c("CDA", "non-CDA 3CD5A", "3CD5A N of 50º", "non-CDA 3CD5A S of 50º", "Full combined"))

.dat <- left_join(.i_ye, .i_hal) %>% mutate(
    ye_per_hal = yelloweye / (halibut),
    hal_per_ye = (halibut) / yelloweye
  ) %>% 
  group_by(Area, year) %>%
  summarise(
    lwr = quantile(ye_per_hal, 0.025),
    upr = quantile(ye_per_hal, 0.975),
    ye_per_hal = mean(ye_per_hal),
    lwr_hal = quantile(hal_per_ye, 0.025),
    upr_hal = quantile(hal_per_ye, 0.975),
    hal_per_ye = mean(hal_per_ye)
  ) 

saveRDS(.dat, "report-data/ratios-yelloweye-to-halibut.rds")

.dat2 <- .dat %>% filter(Area %in% c(
  "non-CDA 3CD5A",
  "CDA"
  ))

ggplot(.dat2, aes(year, ye_per_hal, fill = Area, colour = Area)) +
  geom_line(size = 1.5) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.2, colour = NA) +
  xlab("Year") +
  ylab("Estimated YE to halibut biomass ratio") +
  coord_cartesian(expand = T, ylim = c(0.03, max(.dat2$upr))) +
  # scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  theme(legend.position = c(0.75, 0.8),
    plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/filled-keepable-ye-to-hal-index-est-rock-mud.png", width = 5.5, height =3.2, dpi = 400)

.dat3 <- .dat %>% filter(Area %in% c(
  "non-CDA 3CD5A S of 50º", "3CD5A N of 50º",
  "non-CDA 3CD5A",
  "CDA"
  ))

ggplot(.dat3, aes(year, ye_per_hal, fill = Area, colour = Area)) +
  geom_line(size = 1.5) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.2, colour = NA) +
  xlab("Year") +
  ylab("Estimated YE to halibut biomass ratio") +
  coord_cartesian(expand = T, ylim = c(0.03, max(.dat3$upr))) +
  # scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/filled-keepable-ye-to-hal-index-est-rock-mud-NS.png", width = 7, height = 4, dpi = 400)

# ggplot(.dat2, aes(year, hal_per_ye, fill = Area, colour = Area)) +
#   geom_line() +
#   geom_ribbon(aes(ymin = lwr_hal, ymax = upr_hal), alpha = 0.4, colour = NA) +
#   xlab("Year") +
#   ylab("Estimated halibut to yelloweye biomass ratio") +
#   coord_cartesian(expand = T, ylim = c(2, max(.dat2$upr_hal))) +
#   scale_x_continuous(
#     labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"),
#     breaks = seq(2008, 2020, 2)) +
#   theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
#   scale_fill_brewer(palette = "Set1") +
#   scale_colour_brewer(palette = "Set1")
# ggsave("figs/filled-keepable-hal-to-ye-index-est-rock-mud.png", width = 7, height = 4, dpi = 400)
```


# Maps

Predictions depicted for HBLL survey grid area that falls within region 5A3CD. "Court defined area" area is outlined in red. Only 2020 survey catch is included on first two maps, all years of halibut catch are included on the map showing number of Yelloweye Rockfish expected per halibut caught 2020. 

## Halibut

2020 predictions with all survey catches in 2018 through 2020

HBLL catch is converted to a biomass density by multiplying by the area swept per hook and the average landed biomass per fish caught.
TRAWL catch is converted to an adjusted biomass density by adjusting for lower catchability in trawl and the average proportion of biomass caught that belongs to "landable" individuals based on either set specific samples or the global mean. 


```{r echo=F}
# set map boundaries
# min_map_lat <- 48.3
max_map_lat <- 51.4
min_map_lon <- -130.1
# max_map_lon <- -124.9
min_map_lat2 <- 48.6
max_map_lat2 <- 50.01
min_map_lon2 <- -127.9
max_map_lon2 <- -125.2


min_map_lat <- 48.3
max_map_lon <- -124.85
min_map_lat3 <- 48.4

bs <- tidy(m_halibut_tweedie)
# bs[bs$term == "as.factor(survey)TRAWL",2]
# exp(bs[bs$term == "as.factor(survey)TRAWL",2])
bjye <- tidy(m_ye)
```


```{r message=F, echo=F}
p_hal2020 <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-predictions-all-S.rds")[[1]] %>%
  # plot observations for last 3 years to ensure sampling in all regions
  filter(latitude < max_map_lat) %>% 
  # filter(depth > 5 & depth < 650) %>%
  # filter(!(latitude < 50.85 & latitude > 50.75 & longitude > -128.94 & longitude < -128.7)) %>% 
  filter(year == 2020)

d_hal_plots <- readRDS("data-generated/halibut-model-data-keepable-weight.rds") %>%
  # plot observations for last 3 years to ensure sampling in all regions
  filter(latitude < max_map_lat) %>%
  filter(year %in% c(#2017,
    2018,2019,2020)) %>%  
  mutate(
    density_adj = ifelse(survey == "TRAWL", density/exp(bs[bs$term == "as.factor(survey)TRAWL",2]), density),
    # back transform densities into catch per 100 hooks
    catch_equiv = round(density * (100 * 0.0024384 * 0.009144 * 10000) / halmeanweight), 
    max_count = round((max(catch_count, na.rm = T)/mean(hook_count, na.rm = T))*100),
    catch_equiv2 = ifelse(catch_equiv < max_count, catch_equiv, max_count)
    ) #%>% rename(Survey = survey)

g <- map_predictions(
  pred_data = p_hal2020,
  pred_min = 0, #min(exp(p_hal2020$est), na.rm = T),
  pred_max = quantile(exp(p_hal2020$est), 0.995, na.rm = T),
  obs_data = d_hal_plots,
  fill_lab = "Predicted kg/ha",
  # pred_min = min(exp(p_hal2020$est), na.rm = T),
  # pred_max = quantile(exp(p_hal2020$est), 0.99, na.rm = T),
  map_lat_limits = c(min_map_lat , max_map_lat),
  map_lon_limits = c(min_map_lon, max_map_lon),
  # col_aes = Survey,
  size_lab = "Landable kg/ha", #2018-2020\observed catch\nper 100 hook\nequivalent
  size_aes = density #_adj
  # size_lab = "Adjusted catch\ncounts", #2018-2020\observed catch\nper 100 hook\nequivalent
  # size_aes = catch_equiv 
)+theme(legend.spacing.y = unit(0.1, "cm"))
g
dir.create("figs", showWarnings = FALSE)
ggsave("figs/filled-keepable-halibut-delta-2020-predictions-est-rock-mud.png", width = 6, height = 5.5, dpi = 400)
```

Close up of CDA 
```{r message=F, echo=F}
p_hal2020 <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-predictions-all-S.rds")[[1]] %>%
  # plot observations for last 3 years to ensure sampling in all regions
  filter(latitude < max_map_lat2) %>%
  # filter(depth > 10 & depth < 650) %>%
  filter(year == 2020)
d_hal_plots <- readRDS("data-generated/halibut-model-data-keepable-weight.rds") %>%
  # plot observations for last 3 years to ensure sampling in all regions
  filter(latitude < max_map_lat2) %>%
  filter(year %in% c(#2017,
    2018,2019,2020)) %>%  
  mutate(
    density_adj = ifelse(survey == "TRAWL", density/exp(bs[bs$term == "as.factor(survey)TRAWL",2]), density),
    # back transform densities into catch per 100 hooks
    catch_equiv = round(density * (100 * 0.0024384 * 0.009144 * 10000) / halmeanweight), 
    max_count = round((max(catch_count, na.rm = T)/mean(hook_count, na.rm = T))*100),
    catch_equiv2 = ifelse(catch_equiv < max_count, catch_equiv, max_count)
    ) 

g <- map_predictions(
  pred_data = p_hal2020,
  pred_min = 0, #min(exp(p_hal2020$est), na.rm = T),
  pred_max = quantile(exp(p_hal2020$est), 0.995, na.rm = T), #max(exp(p_hal2020$est)), #
  obs_data = d_hal_plots,
  fill_lab = "Predicted\nkg/ha",
  max_size_obs = 6,
  map_lat_limits = c(min_map_lat2, max_map_lat2),
  map_lon_limits = c(min_map_lon2, max_map_lon2),
  size_lab = "Landable\nkg/ha", #2018-2020\observed catch\nper 100 hook\nequivalent
  size_aes = density #_adj
  # size_lab = "Adjusted catch\ncounts", #2018-2020\observed catch\nper 100 hook\nequivalent
  # size_aes = catch_equiv 
) + theme(legend.box = 'horizontal') +
    guides(colour = "none") 
g
dir.create("figs", showWarnings = FALSE)
ggsave("figs/filled-keepable-halibut-delta-2020-predictions-est-rock-mud-closeup.png", width = 5.5, height = 4.5, dpi = 400)
```

```{r map-predictions-all, message=F, echo=F, warning=F, cache=TRUE}
p_hal <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-predictions-all-S.rds")
years <- unique(p_hal$data$year)
p_hal_d <- p_hal$data #%>% filter(depth > 10 & depth < 810) 

f <- "figs/filled-keepable-halibut-delta-predictions-est-rock-mud.png"
# if (!file.exists(f)) {
  
d_hal_facet <- readRDS("data-generated/halibut-model-data-keepable-weight.rds") %>%
  filter(latitude < 52.15507) %>% filter(year %in% years) %>% 
  mutate(
      pair_name = case_when(
        year %in% c(2007, 2008) ~ "2007-2008",
        year %in% c(2009, 2010) ~ "2009-2010",
        year %in% c(2011, 2012) ~ "2011-2012",
        year %in% c(2013, 2014) ~ "2013-2014",
        year %in% c(2015, 2016) ~ "2015-2016",
        year %in% c(2017, 2018) ~ "2017-2018",
        year %in% c(2019, 2020) ~ "2019-2020"
      ),
    density_adj = ifelse(survey == "TRAWL", density/exp(bs[bs$term == "as.factor(survey)TRAWL",2]), density),
    # back transform densities into catch per 100 hooks
    catch_equiv = round(density * (100 * 0.0024384 * 0.009144 * 10000) / halmeanweight), 
    max_count = round((max(catch_count, na.rm = T)/mean(hook_count, na.rm = T))*100),
    catch_equiv2 = ifelse(catch_equiv < max_count, catch_equiv, max_count)
    )

g <- map_predictions(
  pred_data = p_hal_d,
  pred_min = 0, #min(exp(p_hal_d$est), na.rm = T),
  pred_max = quantile(exp(p_hal_d$est), 0.995, na.rm = T),
  obs_data = d_hal_facet,
  fill_lab = "Predicted\nkg/ha",
  legend_position = "right",
  map_lat_limits = c(min_map_lat, max_map_lat),
  map_lon_limits = c(min_map_lon, max_map_lon),
  size_lab = "Landable\nkg/ha", #2018-2020\observed catch\nper 100 hook\nequivalent
  size_aes = density #_adj
  # size_lab = "Adjusted catch\ncounts", #2018-2020\observed catch\nper 100 hook\nequivalent
  # size_aes = catch_equiv 
) + facet_wrap(~pair_name)

# g <- g + theme(legend.position = c(0.35, 0), legend.justification = c(0,0))

ggsave("figs/filled-keepable-halibut-delta-predictions-est-rock-mud.png", width = 10, height = 8, dpi = 200)
# }
```


## Yelloweye Rockfish

2020 predictions with all survey catches in 2018 through 2020

```{r message=F, echo=F}
p_ye <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-predictions-all-S.rds")[[1]] %>%
  # filter(depth > 10 & depth < 810) %>% 
  # filter(!(latitude < 50.85 & latitude > 50.75 & longitude > -128.94 & longitude < -128.7)) %>% 
  filter(year == 2020)
d_ye_plots <- readRDS("data-generated/yelloweye-model-data-hbll-weights.rds") %>%
  filter(latitude < 52.15507)  %>% filter(year %in% c(#2017,
    2018,
    2019,2020)) %>% 
  mutate(
    density_adj = ifelse(survey == "TRAWL", density/exp(bjye[bjye$term == "as.factor(survey)TRAWL",2]), density),
    # back transform densities into catch per 100 hooks
    catch_equiv = round(density * (100 * 0.0024384 * 0.009144 * 10000) / yemeanweight), 
    max_count = round((max(catch_count, na.rm = T)/mean(hook_count, na.rm = T))*100),
    catch_equiv2 = ifelse(catch_equiv < max_count, catch_equiv, max_count)
    ) 

g <- map_predictions(
  pred_data = p_ye,
  pred_min = 0,
  pred_max = quantile(exp(p_ye$est), 0.995),
  fill_lab = "Predicted kg/ha", #\n
  obs_data = d_ye_plots,  
  map_lat_limits = c(min_map_lat, max_map_lat),
  map_lon_limits = c(min_map_lon, max_map_lon),
  size_lab = "Observed kg/ha", #2018-2020\observed catch\nper 100 hook\nequivalent
  size_aes = density#_adj
  # size_lab = "Observed catch\nper 100 hook\nequivalent",
  # size_aes = catch_equiv 
) + theme(legend.spacing.y = unit(0.1, "cm"))
g
dir.create("figs", showWarnings = FALSE)
ggsave("figs/filled-keepable-yelloweye-2020-predictions-est-rock-mud.png", width = 6, height = 5.5, dpi = 400)
```

Close up of CDA with 2018 to 2020 catch
```{r message=F, echo=F}
p_ye <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-predictions-all-S.rds")[[1]] %>%
  # filter(depth > 10 & depth < 810) %>% 
  # plot observations for last 3 years to ensure sampling in all regions
  filter(latitude < max_map_lat2) %>%
  filter(year == 2020)

d_ye_plots <- readRDS("data-generated/yelloweye-model-data-hbll-weights.rds") %>%
  # plot observations for last 3 years to ensure sampling in all regions
  filter(latitude < max_map_lat2) %>%
  filter(year %in% c(2018,
    2019,2020)) %>%  
  mutate(
    density_adj = ifelse(survey == "TRAWL", density/exp(bjye[bjye$term == "as.factor(survey)TRAWL",2]), density),
    # back transform densities into catch per 100 hooks
    catch_equiv = round(density * (100 * 0.0024384 * 0.009144 * 10000) / yemeanweight), 
    max_count = round((max(catch_count, na.rm = T)/mean(hook_count, na.rm = T))*100),
    catch_equiv2 = ifelse(catch_equiv < max_count, catch_equiv, max_count)
    ) 

g <- map_predictions(
  pred_data = p_ye,
  pred_min = 0, #min(exp(p_ye$est), na.rm = T),
  pred_max = quantile(exp(p_ye$est), 0.995, na.rm = T),
  fill_lab = "Predicted\nkg/ha",
  obs_data = d_ye_plots,  
  map_lat_limits = c(min_map_lat2, max_map_lat2),
  map_lon_limits = c(min_map_lon2, max_map_lon2),
  size_lab = "Observed\nkg/ha", #2018-2020\observed catch\nper 100 hook\nequivalent
  size_aes = density#_adj
  # size_lab = "2018-2020\nobserved catch\nper 100 hook\nequivalent",
  # size_aes = catch_equiv 
) + theme(legend.box = 'horizontal')+
    guides(colour = "none") 
g
dir.create("figs", showWarnings = FALSE)
ggsave("figs/filled-keepable-yelloweye-2020-predictions-est-rock-mud-closeup.png", width = 5.5, height = 4.5, dpi = 400)
```

```{r ye-map-all, cache=TRUE, echo=F, message=F, warning=F}
p_ye <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-predictions-all-S.rds")
years <- unique(p_ye$data$year)
p_ye_d <- p_ye$data # %>% filter(depth > 10 & depth < 810) #%>%
#   filter(year %in% years) %>%
#   mutate(year = as.factor(year))
# p_ye_d$year <- droplevels(p_ye_d$year)

f <- "figs/filled-keepable-ye-predictions-est-rock-mud.png"
# if (!file.exists(f)) {
d_ye_facet <- readRDS("data-generated/yelloweye-model-data-hbll-weights.rds") %>%
  filter(latitude < 52.15507) %>% filter(year %in% years) %>% 
  mutate(
    pair_name = case_when(
        year %in% c(2007, 2008) ~ "2007-2008",
        year %in% c(2009, 2010) ~ "2009-2010",
        year %in% c(2011, 2012) ~ "2011-2012",
        year %in% c(2013, 2014) ~ "2013-2014",
        year %in% c(2015, 2016) ~ "2015-2016",
        year %in% c(2017, 2018) ~ "2017-2018",
        year %in% c(2019, 2020) ~ "2019-2020"
      ),
    density_adj = ifelse(survey == "TRAWL", density/exp(bjye[bjye$term == "as.factor(survey)TRAWL",2]), density),
    # back transform densities into catch per 100 hooks
    catch_equiv = round(density * (100 * 0.0024384 * 0.009144 * 10000) / yemeanweight), 
    max_count = round((max(catch_count, na.rm = T)/mean(hook_count, na.rm = T))*100),
    catch_equiv2 = ifelse(catch_equiv < max_count, catch_equiv, max_count)
    ) 

g <- map_predictions(
  pred_data = p_ye_d,
  obs_data = d_ye_facet,
  fill_lab = "Predicted\nkg/ha",
  pred_min = 0, #min(exp(p_ye$data$est), na.rm = T),
  pred_max = quantile(exp(p_ye$data$est), 0.995, na.rm = T),
  legend_position = "right",
  map_lat_limits = c(min_map_lat, max_map_lat),
  map_lon_limits = c(min_map_lon, max_map_lon),
  size_lab = "Observed\nkg/ha", #2018-2020\observed catch\nper 100 hook\nequivalent
  size_aes = density#_adj
  # size_lab = "Observed catch\nper 100 hook\nequivalent",
  # size_aes = catch_equiv 
) + facet_wrap(~pair_name) 
# g <- g + theme(legend.position = c(0.35, 0), legend.justification = c(0,0))
ggsave(f, width = 10, height = 8, dpi = 200)
# }
```


# Map expected catch ratios

```{r message=F}
# calculate ratio of yelloweye to halibut
p_ye <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-predictions-all-S.rds")[[1]]
p_hal <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-predictions-all-S.rds")[[1]]
pyd <- p_ye %>% rename(ye_est = est) %>% distinct()
phd <- p_hal %>%
  rename(hal_est = est) %>%
  dplyr::select(hal_est, X, Y, year)%>% distinct()

ratio_df <- left_join(pyd, phd) %>% mutate(
  halibut = exp(hal_est), 
  halibut2 = ifelse(exp(hal_est) < 0.01, 0.01, exp(hal_est)), 
  yelloweye = exp(ye_est), 
  yelloweye2 = ifelse(exp(ye_est) < 0.01, 0.01, exp(ye_est)), # make min for yelloweye of 1 per km2
  ye_per_hal = (yelloweye*100) / (halibut*100), # using halibut 2 doesn't change anything.
  hal_per_ye = (halibut*100) / (yelloweye2*100)
  )

ratio_df_2020 <- filter(ratio_df, year == 2020) 
```

## Ratio of yelloweye to halibut

2020 predictions

```{r message=F, echo=F}
g <- map_predictions(
  # obs_data = d_ye_plots,
  # size_aes = (catch_count / hook_count) * 100,
  # size_lab = "Halibut caught\nper 100 hooks in 2020",
  map_lat_limits = c(48.4, max_map_lat),
  map_lon_limits = c(min_map_lon, max_map_lon),
  pred_data = ratio_df_2020,
  pred_min = 0,
  pred_max = quantile(ratio_df_2020$ye_per_hal, 0.995),
  # pred_max = max(d_ye$catch_count, na.rm = T)/ mean(d_ye$hook_count, na.rm = T) * 100,
  fill_aes = ye_per_hal, fill_lab = "Yelloweye to Halibut\nbiomass ratio"
)
g

dir.create("figs", showWarnings = FALSE)
ggsave("figs/filled-ye-to-halibut-2020-keepable-delta.png", 
  width = 5.5, height = 4.5, dpi = 400
  # width = 6, height = 5, dpi = 200
  )
```

## Ratio of halibut to yelloweye

2020 predictions

```{r message=F, echo=F}
g <- map_predictions(
  pred_data = ratio_df_2020,
  # obs_data = filter(d_hal, year %in% c(2018, 2019,2020)),
  # size_aes = density,
  # size_lab = "Halibut caught\nper 100 hooks",
  map_lat_limits = c(48.4, max_map_lat),
  map_lon_limits = c(min_map_lon, max_map_lon),
  pred_min = 0,
  pred_max = quantile(ratio_df_2020$hal_per_ye, 0.995),
  fill_aes = hal_per_ye, 
  fill_lab = "Halibut to yelloweye\nbiomass ratio"
)
g

ggsave("figs/filled-halibut-to-ye-2020-keepable-delta.png", 
  width = 5.5, height = 4.5, dpi = 400
  # width = 6, height = 5, dpi = 200
  )
```

# Overlay hotspot shape file 

```{r message=F, echo=F}
hotspots <- sf::st_read(dsn = "shape-files/Hotspot1820_shape/HD_P18C20.shp",
    layer = "HD_P18C20", quiet = TRUE)
hotspots_proj <- sf::st_transform(hotspots, crs = 3156)
```

```{r message=F, echo=F}
g <- map_predictions(
  map_lat_limits = c(min_map_lat, max_map_lat),
  map_lon_limits = c(min_map_lon, max_map_lon),
  pred_data = ratio_df_2020,
  pred_min = 0,
  pred_max = quantile(ratio_df_2020$ye_per_hal, 0.995),
  fill_aes = ye_per_hal, fill_lab = "Yelloweye to Halibut\nbiomass ratio"
) + geom_sf(data = hotspots_proj, colour = "white", fill = NA, size = 0.50)+
    coord_sf(expand = F,
      xlim = c(convert2utm9(c(min_map_lon, max_map_lon)[1], 50.0)[1], convert2utm9(c(min_map_lon, max_map_lon)[2], 50.0)[1]),
      ylim = c(convert2utm9(-130,c(min_map_lat3 , max_map_lat)[1])[2], convert2utm9(-130, c(min_map_lat3, max_map_lat)[2])[2])
    )
g
ggsave("figs/filled-ye-to-halibut-2020-w-hotspots.png", 
  width = 5.5, height = 4.5, dpi = 400
  # width = 6, height = 5, dpi = 200
  )
```

```{r message=F, echo=F}
g <- map_predictions(
  pred_data = ratio_df_2020,
  map_lat_limits = c(min_map_lat3, max_map_lat),
  map_lon_limits = c(min_map_lon, max_map_lon),
  pred_min = 0,
  pred_max = quantile(ratio_df_2020$hal_per_ye, 0.995),
  fill_aes = hal_per_ye, 
  fill_lab = "Halibut to yelloweye\nbiomass ratio"
)+ geom_sf(data = hotspots_proj, colour = "white", fill = NA, size = 0.50)+
    coord_sf(expand = F,
      xlim = c(convert2utm9(c(min_map_lon, max_map_lon)[1], 50.0)[1], convert2utm9(c(min_map_lon, max_map_lon)[2], 50.0)[1]),
      ylim = c(convert2utm9(-130,c(min_map_lat3, max_map_lat)[1])[2], convert2utm9(-130, c(min_map_lat3, max_map_lat)[2])[2])
    )
g
ggsave("figs/filled-halibut-to-ye-2020-w-hotspots.png", 
  width = 5.5, height = 4.5, dpi = 400
  # width = 6, height = 5, dpi = 200
  )
```


```{r message=F, echo=F}
p_ye <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-predictions-all-S.rds")[[1]] %>% 
  filter(year == 2020)

g <- map_predictions(
  pred_data = p_ye,
  fill_lab = "Predicted kg/ha", 
  map_lat_limits = c(min_map_lat3, max_map_lat),
  pred_min = 0,
  pred_max = quantile(exp(p_ye$est), 0.995),
  map_lon_limits = c(min_map_lon, max_map_lon)
) + geom_sf(data = hotspots_proj, colour = "white", fill = NA, size = 0.50)+
    coord_sf(expand = F,
      xlim = c(convert2utm9(c(min_map_lon, max_map_lon)[1], 50.0)[1], convert2utm9(c(min_map_lon, max_map_lon)[2], 50.0)[1]),
      ylim = c(convert2utm9(-130,c(min_map_lat3, max_map_lat)[1])[2], convert2utm9(-130, c(min_map_lat3, max_map_lat)[2])[2])
    )
g

ggsave("figs/filled-keepable-yelloweye-est-2020-rock-mud-w-hotspots.png", 
  width = 5.5, height = 4.5, dpi = 400
  # width = 6, height = 5, dpi = 200
  )
```


# CV maps

```{r message=F, echo=F}
s_hal <- readRDS(paste0("data-generated/filled-keepable-halibut-delta-est-rock-mud-index-all-S-sim-500.rds"))
cv_hal <- s_hal[[3]]
m_hal <- s_hal[[4]]
cv_hal$cv <- apply(exp(m_hal), 1, function(x) sd(x) / mean(x))

cv_hal2020 <- cv_hal %>% 
  filter(latitude < max_map_lat) %>%
  filter(year == 2020)

g <- map_predictions(
  pred_data = cv_hal2020,
  fill_aes = cv,
  fill_lab = "CV",
  pred_min = min(cv_hal2020$cv),
  pred_max = quantile(cv_hal2020$cv, 0.995),
  map_lat_limits = c(min_map_lat3, max_map_lat),
  map_lon_limits = c(min_map_lon, max_map_lon)
)+theme(legend.spacing.y = unit(0.1, "cm"))
 g
dir.create("figs", showWarnings = FALSE)
ggsave("figs/filled-keepable-halibut-delta-2020-CV-rock-mud.png", width = 6, height = 5, dpi = 400)
```

```{r message=F, echo=F}
s_ye <- readRDS(paste0("data-generated/filled-keepable-yelloweye-est-rock-mud-index-all-S-sim-500.rds"))
cv_ye <- s_ye[[3]]
m_ye <- s_ye[[4]]
cv_ye$cv <- apply(exp(m_ye), 1, function(x)  sd(x) / mean(x))

cv_ye2020 <- cv_ye %>% 
  filter(latitude < max_map_lat) %>%
  filter(year == 2020)

g <- map_predictions(
  pred_data = cv_ye2020,
  fill_aes = cv,
  fill_lab = "CV",
  pred_min = min(cv_ye2020$cv),
  pred_max = quantile(cv_ye2020$cv, 0.995),
  map_lat_limits = c(min_map_lat3, max_map_lat),
  map_lon_limits = c(min_map_lon, max_map_lon)
)+theme(legend.spacing.y = unit(0.1, "cm"))
 g
dir.create("figs", showWarnings = FALSE)
ggsave("figs/filled-ye-2020-CV-rock-mud.png", width = 6, height = 5, dpi = 400)
```

# Other exploratory plots


### Experiment with accumulation curve
Solid lines are cumulative halibut catch potential for each addition cell fished in decreasing order of predicted halibut abundance.
Dashed lines are the cumulative yelloweye catch that might be anticipated for those same cells.

```{r message=F, echo=F, warning=F}
p_hal <- readRDS("data-generated/filled-keepable-halibut-delta-est-rock-mud-predictions-all-S.rds")
p_ye <- readRDS("data-generated/filled-keepable-yelloweye-est-rock-mud-predictions-all-S.rds")

p_hal_cda <- filter(p_hal$data, region == "CDA") 
p_hal_noncda <- filter(p_hal$data, region %in% c("non-CDA 3CD5A S", "3CD5A N")) 
p_ye_cda <- filter(p_ye$data, region == "CDA") 
p_ye_noncda <- filter(p_ye$data, region %in% c("non-CDA 3CD5A", "3CD5A N")) 

py_cda <- p_ye_cda %>% rename(ye_est = est)
py_noncda <- p_ye_noncda %>% rename(ye_est = est)

ph_cda <- p_hal_cda %>%
  rename(hal_est = est) %>%
  select(hal_est, X, Y, year)
ph_noncda <- p_hal_noncda %>%
  rename(hal_est = est) %>%
  select(hal_est, X, Y, year)

# round(density * (100 * 0.0024384 * 0.009144 * 10000) / yemeanweight)
ratio_cda <- left_join(py_cda, ph_cda) %>% mutate(
  halibut = exp(hal_est) * (100 * 0.0024384 * 0.009144 * 10000)*1.33 , # convert kg/ha to kg/100 hooks
  yelloweye = exp(ye_est) * (100 * 0.0024384 * 0.009144 * 10000), # convert kg/ha to kg/100 hooks
  ye_per_hal = yelloweye / halibut, hal_per_ye = halibut / yelloweye,
  pair_name = case_when(
        year %in% c(2007, 2008) ~ "2007-2008",
        year %in% c(2009, 2010) ~ "2009-2010",
        year %in% c(2011, 2012) ~ "2011-2012",
        year %in% c(2013, 2014) ~ "2013-2014",
        year %in% c(2015, 2016) ~ "2015-2016",
        year %in% c(2017, 2018) ~ "2017-2018",
        year %in% c(2019, 2020) ~ "2019-2020"
      )
)
ratio_noncda <- left_join(py_noncda, ph_noncda) %>% mutate(
  halibut = exp(hal_est)* (100 * 0.0024384 * 0.009144 * 10000)*1.33 , # convert kg/ha to kg/100 hooks
  yelloweye = exp(ye_est)* (100 * 0.0024384 * 0.009144 * 10000), # convert kg/ha to kg/100 hooks
  ye_per_hal = yelloweye / halibut, hal_per_ye = halibut / yelloweye,
  pair_name = case_when(
        year %in% c(2007, 2008) ~ "2007-2008",
        year %in% c(2009, 2010) ~ "2009-2010",
        year %in% c(2011, 2012) ~ "2011-2012",
        year %in% c(2013, 2014) ~ "2013-2014",
        year %in% c(2015, 2016) ~ "2015-2016",
        year %in% c(2017, 2018) ~ "2017-2018",
        year %in% c(2019, 2020) ~ "2019-2020"
      )
)

ratio_cda <- ratio_cda[order(ratio_cda$halibut, decreasing = T), ] %>% group_by(year) %>% 
  mutate(ordered = 1:n(), 
    hal_cumsum = cumsum(halibut), 
    ye_cumsum = cumsum(yelloweye),
    cumsum_ye_hal = ye_cumsum/hal_cumsum
    ) %>% ungroup()

ratio_noncda <- ratio_noncda[order(ratio_noncda$halibut, decreasing = T), ] %>% group_by(year) %>% 
  mutate(ordered = 1:n(),
    hal_cumsum = cumsum(halibut), 
    ye_cumsum = cumsum(yelloweye),
    cumsum_ye_hal = ye_cumsum/hal_cumsum
    ) %>% ungroup()


target_catch <- 1500

target_noncda <- ratio_noncda %>% filter (hal_cumsum > target_catch) %>% group_by(year) %>% mutate(cells_for_target = min(ordered), ye_total = min(ye_cumsum)) %>% select(year, cells_for_target, ye_total) %>% distinct()

target_cda <- ratio_cda %>% filter (hal_cumsum > target_catch) %>% group_by(year) %>% mutate(cells_for_target = min(ordered), ye_total = min(ye_cumsum)) %>% select(year, cells_for_target, ye_total) %>% distinct()

ggplot() +
  geom_line(data = ratio_noncda, 
    aes(x = ordered, y = hal_cumsum, lty = "dotted", colour = "darkblue"), size = 1,
    inherit.aes = FALSE) +
  geom_line(data = ratio_noncda, 
    aes(x = ordered, y = ye_cumsum, lty = "solid", colour = "darkblue"), size = 1,
    inherit.aes = FALSE) +
  geom_segment(data = target_noncda, 
    aes(x = cells_for_target, xend = cells_for_target, y = ye_total, yend= target_catch, 
      lty = "dotted", colour = "darkblue"), size = 0.5, inherit.aes = FALSE) +
  geom_hline(data = target_noncda, 
    aes(yintercept = ye_total, lty = "solid", colour = "darkblue"), size = 0.5,
    inherit.aes = FALSE) +
  
  geom_line(data = ratio_cda, 
    aes(x = ordered, y = hal_cumsum, lty = "dotted", colour = "red"), size = 1, 
    inherit.aes = FALSE) +
  geom_line(data = ratio_cda, 
    aes(x = ordered, y = ye_cumsum, lty = "solid", colour = "red"), size = 1, 
    inherit.aes = FALSE) +
  geom_segment(data = target_cda, 
    aes(x = cells_for_target, xend = cells_for_target, y = ye_total, yend= target_catch, 
      lty = "dotted", colour = "red"), size = 0.5, inherit.aes = FALSE) +
  geom_hline(data = target_cda, 
    aes(yintercept = ye_total, lty = "solid", colour = "red"), size = 0.5,
    inherit.aes = FALSE) +
  
  coord_cartesian(expand = F, xlim = c(0, 200), ylim = c(0, target_catch )) +
  scale_color_identity(name = "Area",
                          breaks = c("darkblue", "red"),
                          labels = c("5A3CD (non-CDA)", "CDA"),
                          guide = "legend") +
  scale_linetype_identity(name = "Species",
                          breaks = c("solid", "dotted"),
                          labels = c("YE","Halibut"),
                          guide = "legend") +
  facet_wrap(~year, ncol = 2)+
  ylab("Cummulative fish biomass (kg if 100 hooks set in each cell)") +
  xlab("Number of cells fished (in order of decreasing Halibut abundance)") + 
  theme(legend.position = c(0.65, 0.1))

ggsave("figs/cummulative-catch-rates-x.png", width = 7, height = 9)
```

```{r}
target_cda 
```

```{r}
target_noncda 
```

```{r}
ggplot(target_noncda,  aes(year, ye_total)) + 
  geom_line(colour = "darkblue") + 
  geom_point(aes(size = cells_for_target, colour = "darkblue")) +
  geom_line(data = target_cda,  aes(year, ye_total, colour = "red")) +
  geom_point(data = target_cda, aes(size = cells_for_target, colour = "red")) +
  scale_x_continuous(
    labels=c("2007-2008", "2009-2010", "2011-2012", "2013-2014", "2015-2016","2017-2018","2019-2020"), 
    breaks = seq(2008, 2020, 2)) + 
  scale_size_continuous("Number of\ncells fished") +
  scale_color_identity(name = "Area",
                          breaks = c("darkblue", "red"),
                          labels = c("5A3CD (non-CDA)", "CDA"),
                          guide = "legend") +
  xlab("Year") +
  ylab("Expected catch of YE") + 
  ggtitle("If 1500 kg of Halibut were targeted using 100 hooks per cell...")

ggsave("figs/expected_YE.png", width = 6.5, height = 4)
```


# Investigate weights of yelloweye caught

### Is there an overall trend in fish size through time?

```{r message=F, echo=F}
# load biological sample data
yesampledata <- readRDS("data/yelloweye-surv-samples-all.rds") %>% filter(survey_abbrev == "HBLL OUT S")

# calculate mean weights for all of HBLL S
yemeanweights <- yesampledata %>%
  filter(!is.na(weight)) %>%
  group_by(year) %>%
  summarise(
    mean_weight = mean(weight / 1000, na.rm = T),
    upr_ci = Rmisc::CI(weight / 1000, ci = 0.95)[1], lwr_ci = Rmisc::CI(weight / 1000, ci = 0.95)[3],
    upr_weight = quantile(weight / 1000, 0.975), lwr_weight = quantile(weight / 1000, 0.025),
    n = n()
  )

# plot mean weights through time for whole HBLL
ggplot(yemeanweights) + geom_path(aes(year, mean_weight)) + ylim(0, 6) +
  geom_ribbon(aes(year, mean_weight, ymax = upr_weight, ymin = lwr_weight), alpha = 0.2) +
  geom_linerange(aes(year, ymax = upr_ci, ymin = lwr_ci), size = 1) +
  scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  ylab("Individual Fish Weights (kg)") + xlab("Year") +
  ggtitle("Mean and 95th percentile range for Yelloweye Rockfish caught on HBLL S")
ggsave("figs/annual_yelloweye_weights.png", width = 4, height = 4)
```


### Does the annual distribution of fish weights differ within the CDA?

```{r message=F, echo=F, warning=F}
# get the fishing events that occurred within CDA
d_ye_sf <- st_as_sf(d_ye, coords = c("longitude", "latitude"))
st_crs(d_ye_sf) <- 4326 # set the coordinate reference system

focal_area <- sf::st_read(dsn = "shape-files/taaqwiihak_areaVer2.shp",
    layer = "taaqwiihak_areaVer2", quiet = TRUE)
focal_area2 <- sf::st_transform(focal_area, crs = 4326)
d_ye_intersected <- sf::st_intersects(d_ye_sf, focal_area2)
cda_ye_sf <- d_ye_sf[which(lengths(d_ye_intersected) > 0), ]
noncda_ye_sf <- d_ye_sf[which(lengths(d_ye_intersected) == 0), ]

cda_ye_ids <- cda_ye_sf
st_geometry(cda_ye_ids) <- NULL
cda_ye_ids <- cda_ye_ids %>%
  select(fishing_event_id, year, catch_count) %>%
  distinct() # keep catch count for comparison with sample totals

# make dataframe of just samples from the CDA and calculate tallies of events, total catch, sampled weights and total catch/events
cda_ye_samples <- inner_join(cda_ye_ids, yesampledata) %>%
  group_by(year) %>%
  mutate(cda_weights = n())
cda_ye_catch <- cda_ye_ids %>%
  group_by(year) %>%
  summarise(cda_catch = sum(catch_count))
cda_ye_sample_sum <- cda_ye_samples %>%
  select(year, cda_weights) %>%
  distinct()
cda_events <- cda_ye_ids %>%
  group_by(year) %>%
  summarise(cda_events = n())
cda_sampling <- left_join(cda_events, cda_ye_catch) %>%
  left_join(cda_ye_sample_sum) %>%
  mutate(catch_rate = round(cda_catch / cda_events, 1))

# plot CDA weights against overall distribution for HBLL S
ggplot(yesampledata) +
  geom_violin(aes(as.factor(year), weight / 1000), alpha = 0.2, scale = "count", colour = "black", fill = "grey") +
  # geom_violin(data = cda_ye_samples, aes(as.factor(year), weight/1000), alpha = 0.9, scale = "count", colour = "red", fill = "red", adjust = 1/5) +
  geom_point(data = cda_ye_samples, aes(as.factor(year), weight / 1000), alpha = 0.7, colour = "red", fill = "red") +
  geom_linerange(data = yemeanweights, aes(as.factor(year), ymax = upr_ci, ymin = lwr_ci), size = 5) +
  ylab("Individual Fish Weights (kg)") + xlab("") +
  ggtitle("Annual distributions of Yelloweye Rockfish weights (all HBLL S = black; within CDA = red)")
ggsave("figs/yelloweye_weights.png", width = 5, height = 3.5)
```


### How spatially variable are mean weigths through time for whole HBLL S?

```{r message=F, echo=F, warning=F}
# calculate the mean weights from each fishing event
yeeventweights <- yesampledata %>%
  filter(!is.na(weight)) %>%
  group_by(year, fishing_event_id) %>%
  summarise(
    mean_weight = mean(weight / 1000, na.rm = T),
    upr_ci = Rmisc::CI(weight / 1000, ci = 0.95)[1], lwr_ci = Rmisc::CI(weight / 1000, ci = 0.95)[3],
    upr_weight = quantile(weight / 1000, 0.975), lwr_weight = quantile(weight / 1000, 0.025),
    n = n()
  ) %>%
  filter(n > 10) # filter for fishing events with at least 10 fish measured

ggplot(yeeventweights) +
  geom_violin(aes(as.factor(year), mean_weight), alpha = 0.2, scale = "count", colour = "black", fill = "grey") +
  geom_linerange(data = yemeanweights, aes(as.factor(year), ymax = upr_ci, ymin = lwr_ci), size = 3) +
  ylab("Mean Weight (kg)") + xlab("") +
  ggtitle("Annual mean and variability in Yelloweye Rockfish weights", subtitle = "for events with > 10 fish sampled")
ggsave("figs/yelloweye_event_weights.png", width = 6, height = 4.5)
```


```{r message=F, echo=F, warning=F, include=F}
yeeventweights1 <- yesampledata %>%
  filter(!is.na(weight)) %>%
  group_by(year, fishing_event_id) %>%
  summarise(
    mean_weight = mean(weight / 1000, na.rm = T),
    med_weight = median(weight / 1000, na.rm = T),
    upr_ci = Rmisc::CI(weight / 1000, ci = 0.95)[1], lwr_ci = Rmisc::CI(weight / 1000, ci = 0.95)[3],
    upr_weight = quantile(weight / 1000, 0.975), lwr_weight = quantile(weight / 1000, 0.025),
    n = n()
  ) %>%
  filter(n > 1)

# ggplot(yeeventweights1) +
#   geom_col(aes(med_weight, n), size = 2, colour = "grey") +
#   # geom_linerange(data = yemeanweights, aes(as.factor(year), ymax = upr_ci, ymin = lwr_ci), size = 3) +
#   ylab("Number of fish sampled") + xlab("Median weight of fish sampled (kg)") +
#   # facet_wrap(~year) +
#   ggtitle("")

ggplot(yeeventweights1) +
  geom_col(aes(mean_weight, n), size = 2, colour = "grey") +
  scale_x_continuous(0, max(yeeventweights1$mean_weight)) +
  ylab("Number of fish sampled") + xlab("Mean weight of fish sampled (kg)") +
  ggtitle("Variability in mean fish weight between fishing events")
```
