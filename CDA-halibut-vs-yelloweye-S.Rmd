---
title: "Estimating relative catches of Pacific Halibut and Yelloweye Rockfish off west coast of Vancouver Island"
author: "Philina English"
date: "20/05/2021"
output: html_document
---

```{r message = F}
library(sf)
library(dplyr)
library(ggplot2)
library(tidyr)
# remotes::install_github("pbs-assess/sdmTMB", ref = "pc-prior") # for faster models
library(sdmTMB)
# Do we need instructions for installing other dependencies like "pbsmapping"?
# devtools::install_github("seananderson/ggsidekick")
library(ggsidekick) # for fourth_root_power_trans and theme_sleek
theme_set(ggsidekick::theme_sleek())
dir.create("data", showWarnings = FALSE)
dir.create("data-generated", showWarnings = FALSE)
dir.create("models", showWarnings = FALSE)
```

# Retrieve HBLL data (on network)

```{r eval=F}
halsetdata <- gfdata::get_survey_sets("Pacific Halibut", ssid = c(36))
saveRDS(halsetdata, "data/halibut-surv-sets.rds")
halhookdata <- gfdata::get_ll_hook_data("Pacific Halibut", ssid = c(36))
saveRDS(halhookdata, "data/halibut-hook-dat36.rds")

yesetdata <- gfdata::get_survey_sets("Yelloweye Rockfish", ssid = c(36))
saveRDS(yesetdata, "data/yelloweye-surv-sets.rds")
yehookdata <- gfdata::get_ll_hook_data("Yelloweye Rockfish", ssid = c(36))
saveRDS(yehookdata, "data/yelloweye-hook-dat36.rds")

# get detailed biological data, I have retrieved data from all surveys in case comparisons between surveys are needed later
yesampledata <- gfdata::get_survey_samples("Yelloweye Rockfish")
saveRDS(yesampledata, "data/yelloweye-surv-samples-all.rds")

blocks <- gfdata::get_survey_blocks(ssid = 36)
saveRDS(blocks, "data/survey-blocks-36.rds")

# I also copied hbll_s_grid.rda from gfplot into "data" folder
# and will need a folder called "shape-files" containing "taaqwiihak_areaVer2.shp"
# download gshhg-shp-2.3.7 from https://www.ngdc.noaa.gov/mgg/shorelines/data/gshhg/latest/ add place in data folder
```


# Prepare HBLL survey data

Load custom functions including one that takes the set data and hook data retrieve for each species and produces a dataframe for use in sdmTMB model. 

```{r echo=F}
# load misc custom functions
source("functions.R")
```

```{r message=F}
model_data_prep <- function(setdata, hookdata) {
  # add in survey blocks
  block_ids <- readRDS("data/survey-blocks-36.rds")
  d <- dplyr::left_join(setdata, block_ids)
  d$block_designation <- as.numeric(d$block_designation)

  # add variables that adjust for hook competiton (not using most of this currently)
  # this code should deal with the issue of 0 baited hooks being observed.
  adjust <- hookdata %>%
    group_by(year, fishing_event_id) %>%
    mutate(total_hooks = count_target_species + count_non_target_species +
      count_bait_only + count_empty_hooks - count_bent_broken) %>%
    mutate(count_bait_only = replace(count_bait_only, which(count_bait_only == 0), 1)) %>%
    mutate(prop_bait_hooks = count_bait_only / total_hooks) %>%
    mutate(hook_adjust_factor = -log(prop_bait_hooks) / (1 - prop_bait_hooks)) %>%
    mutate(expected_catch = round(count_target_species * hook_adjust_factor))

  # find out which events are in hook data but not set data:
  setdiff(hookdata$fishing_event_id, setdata$fishing_event_id)

  hook_adjusted_data <- left_join(setdata, adjust, by = c("fishing_event_id", "year"))

  hook <- hook_adjusted_data %>%
    select(
      survey_series_id, year, fishing_event_id, total_hooks, prop_bait_hooks,
      hook_adjust_factor, expected_catch
    )

  d <- left_join(d, hook, by = c("survey_series_id", "year", "fishing_event_id"))

  d <- d %>%
    select(
      survey_abbrev, year, longitude, latitude, fishing_event_id, catch_count, hook_count,
      grouping_code, depth_m, block_designation, hook_adjust_factor, prop_bait_hooks
    ) %>%
    mutate(lon = longitude, lat = latitude) %>%
    rename(survey = survey_abbrev, block = block_designation)

  # convert to utms for sdmTMB model
  d_utm <- convert2utm(d, coords = c("lon", "lat"))

  d_utm$depth_log <- log(d_utm$depth_m)
  d_utm$depth_centred <- d_utm$depth_log - mean(d_utm$depth_log)
  d_utm$depth_mean <- mean(d_utm$depth_log)
  d_utm$depth_sd <- sd(d_utm$depth_centred)
  d_utm$depth_scaled <- d_utm$depth_centred / sd(d_utm$depth_centred)
  d_utm$Y_cent <- d_utm$Y - mean(d_utm$Y)
  d_utm$X_cent <- d_utm$X - mean(d_utm$X)

  # add possible offsets
  d_utm$offset <- log(d_utm$hook_count)
  d_utm$area_swept <- d_utm$hook_count * 0.0024384 * 0.009144 * 1000
  d_utm$offset_area_swept <- log(d_utm$area_swept)
  d_utm$offset_area_hook <- log(d_utm$area_swept / d_utm$hook_adjust_factor)

  d_utm
}

# prep halibut
halsetdata <- readRDS("data/halibut-surv-sets.rds") %>% filter(survey_abbrev == "HBLL OUT S")
halhookdata <- readRDS("data/halibut-hook-dat36.rds")

d_hal <- model_data_prep(halsetdata, halhookdata)
saveRDS(d_hal, "data-generated/halibut-surv-36-model-data.rds")

# prep yelloweye
yesetdata <- readRDS("data/yelloweye-rockfish-surv-sets.rds") %>% filter(survey_abbrev == "HBLL OUT S")
yehookdata <- readRDS("data/yelloweye-rockfish-hook-dat36.rds")

d_ye <- model_data_prep(yesetdata, yehookdata)
saveRDS(d_ye, "data-generated/yelloweye-surv-36-model-data.rds")

# calculate mean weight for all of SYN WCVI
halsampledata <- readRDS("data/halibut-surv-samples-all.rds") %>% filter(survey_abbrev == c("SYN WCVI", "SYN QCS"))
halmeanweight <- mean(halsampledata$weight / 1000, na.rm = T)

yesampledata <- readRDS("data/yelloweye-surv-samples-all.rds") %>% filter(survey_abbrev == c("HBLL OUT S"))
yemeanweight <- mean(yesampledata$weight / 1000, na.rm = T)
yemeanweight

yesampledata <- readRDS("data/yelloweye-surv-samples-all.rds") %>% filter(survey_abbrev == c("SYN WCVI", "SYN QCS"))
yemeanweightSYN <- mean(yesampledata$weight / 1000, na.rm = T)
yemeanweightSYN
```

# Make prediction grid

```{r message=F}
# shouldn't matter which species this is based on since the offsets are currently the same for both
d_utm <- readRDS("data-generated/yelloweye-surv-36-model-data.rds")

load("data/hbll_s_grid.rda")

s_grid_utm <- convert2utm(hbll_s_grid$grid, coords = c("X", "Y"))

s_grid_utm$longitude <- hbll_s_grid$grid$X
s_grid_utm$latitude <- hbll_s_grid$grid$Y

s_grid_utm$offset_area_hook <- mean(d_utm$offset_area_hook)
s_grid_utm$offset_area_swept <- mean(d_utm$offset_area_swept)
s_grid_utm$hook_adjust_factor <- mean(d_utm$hook_adjust_factor)
s_grid_utm$hook_count <- 100 # mean(d_utm$hook_count)
s_grid_utm$offset <- log(100)

years <- sort(unique(d_utm$year))
s_grid_utm <- expand_prediction_grid(s_grid_utm, years = years) %>%
  mutate(depth_centred = log(depth) - mean(d_utm$depth_log)) %>%
  mutate(depth_scaled = depth_centred / sd(d_utm$depth_centred))
s_grid_utm <- mutate(s_grid_utm, Y_cent = Y - mean(d_utm$Y))
s_grid_utm <- mutate(s_grid_utm, X_cent = X - mean(d_utm$X))
```


Trim prediction grid to cover full outside S HBLL

```{r}
full_s_grid_utm <- s_grid_utm
full_s_grid_sf <- st_as_sf(full_s_grid_utm, coords = c("longitude", "latitude"))
st_crs(full_s_grid_sf) <- 4326 # set the coordinate reference system
full_s_grid <- sfc_as_cols(full_s_grid_sf, c("longitude", "latitude"))
st_geometry(full_s_grid) <- NULL

saveRDS(full_s_grid, file = "data-generated/full_s_grid.rds")
```

Trim prediction grid for just area 5A

```{r}
s_5A_grid_utm <- filter(s_grid_utm, latitude < 51.24999 & latitude > 50.5) # trims grid to be just area 5A
s_5A_grid_sf <- st_as_sf(s_5A_grid_utm, coords = c("longitude", "latitude"))
st_crs(s_5A_grid_sf) <- 4326 # set the coordinate reference system
s_5A_grid <- sfc_as_cols(s_5A_grid_sf, c("longitude", "latitude"))
st_geometry(s_5A_grid) <- NULL

saveRDS(s_5A_grid, file = "data-generated/s_5A_grid.rds")
```

Split area 3CD into areas inside and outside court defined area (CDA)

```{r message= F}
s_3CD_grid_utm <- filter(s_grid_utm, latitude < 50.5) # trims grid to be just area 3CD
s_3CD_grid_sf <- st_as_sf(s_3CD_grid_utm, coords = c("longitude", "latitude"))
st_crs(s_3CD_grid_sf) <- 4326 # set the coordinate reference system
# s_grid_sf

focal_area <- sf::st_read(dsn = "shape-files/taaqwiihak_areaVer2.shp", layer = "taaqwiihak_areaVer2")
focal_area <- sf::st_transform(focal_area, crs = 4326)

intersected <- sf::st_intersects(s_3CD_grid_sf, focal_area)

cda_grid_sf <- s_3CD_grid_sf[which(lengths(intersected) > 0), ]
noncda_grid_sf <- s_3CD_grid_sf[which(lengths(intersected) == 0), ]

cda_grid <- sfc_as_cols(cda_grid_sf, c("longitude", "latitude"))
noncda_grid <- sfc_as_cols(noncda_grid_sf, c("longitude", "latitude"))
st_geometry(cda_grid) <- NULL
st_geometry(noncda_grid) <- NULL
saveRDS(cda_grid, file = "data-generated/cda_grid.rds")
saveRDS(noncda_grid, file = "data-generated/noncda_grid.rds")
```

# Make relatively finescale mesh

```{r }
# again the same grid should work for both species because the sets are identical in both
mesh400kn <- make_mesh(d_utm, c("X", "Y"), n_knots = 400)
plot(mesh400kn)
```

# Pacific Halibut model 

```{r eval = TRUE}
d_hal <- readRDS("data-generated/halibut-surv-36-model-data.rds")
f <- "models/halibut-hook-count-offset-400kn-AR1.rds"
if (!file.exists(f)) {
  m_halibut <- sdmTMB(
    formula = catch_count ~ 0 + as.factor(year) +
      depth_scaled + I(depth_scaled^2) +
      offset,
    data = d_hal,
    spde = mesh400kn,
    ar1_fields = T,
    time = "year",
    silent = FALSE,
    anisotropy = TRUE,
    reml = TRUE,
    family = nbinom2(link = "log")
  )
  saveRDS(m_halibut, file = f)
}
```


```{r}
m_halibut <- readRDS(file = "models/halibut-hook-count-offset-400kn-AR1.rds")
m_halibut
# tidy(m_halibut, "ran_pars", conf.int = TRUE)
```

```{r}
get_diag(m_halibut)
```


# Yelloweye Rockfish model

```{r eval=TRUE}
d_ye <- readRDS("data-generated/yelloweye-surv-36-model-data.rds")

f <- "models/yelloweye-hook-count-offset-400kn-spatial-only-T.rds"
if (!file.exists(f)) {
  m_ye <- sdmTMB(
    formula = catch_count ~ 0 + as.factor(year) +
      depth_scaled + I(depth_scaled^2) +
      offset,
    data = d_ye,
    spde = mesh400kn,
    spatial_only = T,
    time = "year",
    silent = FALSE,
    anisotropy = TRUE,
    reml = TRUE,
    family = nbinom2(link = "log")
  )
  saveRDS(m_ye, file = f)
}
```


```{r}
m_ye <- readRDS(file = "models/yelloweye-hook-count-offset-400kn-spatial-only-T.rds")
m_ye
# tidy(m_ye, "ran_pars", conf.int = TRUE)
```

```{r}
get_diag(m_ye)
```

# Halibut catch predictions and index

For CDA only

```{r eval = TRUE}
f <- "data-generated/halibut-index-cda.rds"
if (!file.exists(f)) {
  p_hal_cda <- predict(m_halibut, newdata = cda_grid, return_tmb_object = TRUE)
  saveRDS(p_hal_cda, "data-generated/halibut-predictions-cda.rds")
  i_hal_cda <- get_index(p_hal_cda, bias_correct = T)
  saveRDS(i_hal_cda, f)
}

ss <- "data-generated/halibut-index-cda-sim-500.rds"
if (!file.exists(ss)) {
  i_hal_cda2 <- get_all_sims(m_halibut, newdata = cda_grid)
  saveRDS(i_hal_cda2, ss)
}
```

For 3CD outside CDA

```{r eval = T}
f <- "data-generated/halibut-index-3CD-outside-cda.rds"
if (!file.exists(f)) {
  p_hal_noncda <- predict(m_halibut, newdata = noncda_grid, return_tmb_object = TRUE)
  saveRDS(p_hal_noncda, "data-generated/halibut-predictions-3CD-outside-cda.rds")

  i_hal_noncda <- get_index(p_hal_noncda, bias_correct = T)
  saveRDS(i_hal_noncda, f)
}

ss <- "data-generated/halibut-index-3CD-outside-cda-sim-500.rds"
if (!file.exists(ss)) {
  i_hal_noncda2 <- get_all_sims(m_halibut, newdata = noncda_grid)
  saveRDS(i_hal_noncda2, ss)
}
```

For area 5A 

```{r eval = T}
f <- "data-generated/halibut-index-5A.rds"
if (!file.exists(f)) {
  p_hal_5A <- predict(m_halibut, newdata = s_5A_grid, return_tmb_object = TRUE)
  saveRDS(p_hal_noncda, "data-generated/halibut-predictions-5A.rds")

  i_hal_5A <- get_index(p_hal_5A, bias_correct = T)
  saveRDS(i_hal_5A, f)
}

ss <- "data-generated/halibut-index-5A-sim-500.rds"
if (!file.exists(ss)) {
  i_hal_5A2 <- get_all_sims(m_halibut, newdata = s_5A_grid)
  saveRDS(i_hal_5A2, ss)
}
```

For entire southern outside HBLL

```{r eval = T}
f <- "data-generated/halibut-index-all-S.rds"
if (!file.exists(f)) {
  p_hal_S <- predict(m_halibut, newdata = full_s_grid, return_tmb_object = TRUE)
  saveRDS(p_hal_S, "data-generated/halibut-predictions-all-S.rds")

  i_hal_S <- get_index(p_hal_S, bias_correct = T)
  saveRDS(i_hal_S, "data-generated/halibut-index-all-S.rds")
}

ss <- "data-generated/halibut-index-all-S-sim-500.rds"
if (!file.exists(ss)) {
  i_hal_S2 <- get_all_sims(m_halibut, newdata = full_s_grid)
  saveRDS(i_hal_S2, ss)
}
```


## Plot index of total halibut catch through time

Total catch index for entire court defined area is in red, remainder of southern stock area is in black.

```{r message=F, echo=F}
i_hal1 <- readRDS("data-generated/halibut-index-all-S.rds")
i_hal_cda1 <- readRDS("data-generated/halibut-index-cda.rds")
i_hal_noncda1 <- readRDS("data-generated/halibut-index-3CD-outside-cda.rds")
i_hal_5A1 <- readRDS("data-generated/halibut-index-5A.rds")

.dat1 <- bind_rows(
  mutate(i_hal1, Area = "HBLL South"),
  mutate(i_hal_5A1, Area = "5A"),
  mutate(i_hal_noncda1, Area = "non-CDA 3CD"),
  mutate(i_hal_cda1, Area = "CDA")
)

.dat1$Area <- ordered(.dat1$Area, levels = c("CDA", "non-CDA 3CD", "5A", "HBLL South"))

i_hal <- readRDS("data-generated/halibut-index-all-S-sim-500.rds")[[1]]
i_hal_cda <- readRDS("data-generated/halibut-index-cda-sim-500.rds")[[1]]
i_hal_noncda <- readRDS("data-generated/halibut-index-3CD-outside-cda-sim-500.rds")[[1]]
i_hal_5A <- readRDS("data-generated/halibut-index-5A-sim-500.rds")[[1]]

.dat <- bind_rows(
  mutate(i_hal, Area = "HBLL South"),
  mutate(i_hal_5A, Area = "5A"),
  mutate(i_hal_noncda, Area = "non-CDA 3CD"),
  mutate(i_hal_cda, Area = "CDA")
)
.dat$Area <- ordered(.dat$Area, levels = c("CDA", "non-CDA 3CD", "5A", "HBLL South"))

# 
# .dat$est_biomass <- .dat$est * halmeanweight 
# .dat$lwr_biomass <- .dat$lwr * halmeanweight 
# .dat$upr_biomass <- .dat$upr * halmeanweight 

ggplot(.dat, aes(year, est, fill = Area, colour = Area)) +
  geom_line(alpha = 0.95) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.4, colour = NA) +
  # geom_line(data = .dat1, linetype = 2) +
  xlab("Year") +
  ylab("Estimated total fish caught\nif 100 hooks set in all grid cells") +
  coord_cartesian(expand = FALSE, ylim = c(0, max(i_hal$upr) * 1.04)) +
  scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/halibut-index-by-area-sims.png", width = 7, height = 4, dpi = 400)

# ggplot(.dat, aes(year, est_biomass, fill = Area, colour = Area)) +
#   geom_line(alpha = 0.95) +
#   geom_ribbon(aes(ymin = lwr_biomass, ymax = upr_biomass), alpha = 0.4, colour = NA) +
#   # geom_line(data = .dat1, linetype = 2) +
#   xlab("Year") +
#   ylab("Estimated biomass caught\nif 100 hooks set in all grid cells") +
#   coord_cartesian(expand = FALSE, ylim = c(0, max(i_hal$upr * halmeanweight) * 1.04)) +
#   scale_x_continuous(breaks = seq(1950, 2050, 2)) +
#   theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
#   scale_fill_brewer(palette = "Set1") +
#   scale_colour_brewer(palette = "Set1")
# ggsave("figs/halibut-biomass-index-by-area-sims.png", width = 7, height = 4, dpi = 400)
```

## Plot estimated halibut catch per 100 hooks through time

Average predicted catch within the entire court defined area is in red, remainder of southern stock area is in black.

```{r message = F, echo= F}
# i_hal_cda <- readRDS("data-generated/halibut-index-cda.rds")
# i_hal_noncda <- readRDS("data-generated/halibut-index-3CD-outside-cda.rds")
i_hal_cda <- readRDS("data-generated/halibut-index-cda-sim-500.rds")[[1]]
i_hal_noncda <- readRDS("data-generated/halibut-index-3CD-outside-cda-sim-500.rds")[[1]]

.dat <- bind_rows(
  mutate(i_hal_noncda,
    Area = "non-CDA 3CD",
    est = est / nrow(noncda_grid),
    lwr = lwr / nrow(noncda_grid),
    upr = upr / nrow(noncda_grid)
  ),
  mutate(i_hal_cda,
    Area = "CDA",
    est = est / nrow(cda_grid),
    lwr = lwr / nrow(cda_grid),
    upr = upr / nrow(cda_grid)
  ),
)
ggplot(.dat, aes(year, est)) +
  geom_line(aes(colour = Area)) +
  geom_ribbon(aes(
    ymin = lwr,
    ymax = upr, fill = Area
  ), alpha = 0.4) +
  xlab("Year") +
  ylab("Average estimated catch per 100 hooks") +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/halibut-average-index-by-area-sim.png", width = 7, height = 4, dpi = 400)
```

# Yelloweye Rockfish catch predictions

For CDA only

```{r eval = TRUE}
f <- "data-generated/yelloweye-spatial-index-cda2.rds"
if (!file.exists(f)) {
  p_ye_cda <- predict(m_ye, newdata = cda_grid, return_tmb_object = TRUE)
  saveRDS(p_ye_cda, "data-generated/yelloweye-spatial-predictions-cda.rds")

  i_ye_cda <- get_index(p_ye_cda, bias_correct = T)
  saveRDS(i_ye_cda, f)
}

ss <- "data-generated/yelloweye-spatial-index-cda-sim-500.rds"
if (!file.exists(ss)) {
  i_ye_cda2 <- get_all_sims(m_ye, newdata = cda_grid)
  saveRDS(i_ye_cda2, ss)
}
```

For 3CD outside CDA

```{r eval = T}
f <- "data-generated/yelloweye-spatial-index-3CD-outside-cda2.rds"
if (!file.exists(f)) {
  p_ye_noncda <- predict(m_ye, newdata = noncda_grid, return_tmb_object = TRUE)
  saveRDS(p_ye_noncda, "data-generated/yelloweye-spatial-predictions-3CD-outside-cda.rds")

  i_ye_noncda <- get_index(p_ye_noncda, bias_correct = T)
  saveRDS(i_ye_noncda, f)
}

ss <- "data-generated/yelloweye-spatial-index-3CD-outside-cda-sim-500.rds"
if (!file.exists(ss)) {
  i_ye_noncda2 <- get_all_sims(m_ye, newdata = noncda_grid)
  saveRDS(i_ye_noncda2, ss)
}
```

For area 5A 

```{r eval = T}
f <- "data-generated/yelloweye-spatial-index-5A2.rds"
if (!file.exists(f)) {
  p_ye_5A <- predict(m_ye, newdata = s_5A_grid, return_tmb_object = TRUE)
  saveRDS(p_ye_5A, "data-generated/yelloweye-spatial-predictions-5A.rds")

  i_ye_5A <- get_index(p_ye_5A, bias_correct = T)
  saveRDS(i_ye_5A, f)
}

ss <- "data-generated/yelloweye-spatial-index-5A-sim-500.rds"
if (!file.exists(ss)) {
  i_ye_5A2 <- get_all_sims(m_ye, newdata = s_5A_grid)
  saveRDS(i_ye_5A2, ss)
}
```

For entire southern outside yelloweye stock including CDA

```{r eval = T}
f <- "data-generated/yelloweye-spatial-index-all-S2.rds"
if (!file.exists(f)) {
  p_ye_S <- predict(m_ye, newdata = full_s_grid, return_tmb_object = TRUE)
  saveRDS(p_ye_S, "data-generated/yelloweye-spatial-predictions-all-S.rds")

  i_ye_S <- get_index(p_ye_S, bias_correct = T)
  saveRDS(i_ye_S, f)
}

ss <- "data-generated/yelloweye-spatial-index-all-S-sim-500.rds"
if (!file.exists(ss)) {
  i_ye_S2 <- get_all_sims(m_ye, newdata = full_s_grid)
  saveRDS(i_ye_S2, ss)
}
```

Total catch index for entire court defined area is in red, remainder of southern stock area is in black.

```{r message=F, echo=F}
# i_ye <- readRDS("data-generated/yelloweye-spatial-index-all-S2.rds")
# i_ye_cda <- readRDS("data-generated/yelloweye-spatial-index-cda2.rds")
# i_ye_noncda <- readRDS("data-generated/yelloweye-spatial-index-3CD-outside-cda2.rds")
# i_ye_5A <- readRDS("data-generated/yelloweye-spatial-index-5A2.rds")

i_ye <- readRDS("data-generated/yelloweye-spatial-index-all-S-sim-500.rds")[[1]]
i_ye_cda <- readRDS("data-generated/yelloweye-spatial-index-cda-sim-500.rds")[[1]]
i_ye_noncda <- readRDS("data-generated/yelloweye-spatial-index-3CD-outside-cda-sim-500.rds")[[1]]
i_ye_5A <- readRDS("data-generated/yelloweye-spatial-index-5A-sim-500.rds")[[1]]

.dat <- bind_rows(
  mutate(i_ye, Area = "HBLL South"),
  mutate(i_ye_5A, Area = "5A"),
  mutate(i_ye_noncda, Area = "non-CDA 3CD"),
  mutate(i_ye_cda, Area = "CDA")
)
.dat$Area <- ordered(.dat$Area, levels = c("CDA", "non-CDA 3CD", "5A", "HBLL South"))
ggplot(.dat, aes(year, est, fill = Area, colour = Area)) +
  geom_line() +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.4, colour = NA) +
  xlab("Year") +
  ylab("Estimated total fish caught\nif 100 hooks set in all grid cells") +
  coord_cartesian(expand = FALSE, ylim = c(0, max(i_ye$upr) * 1.04)) +
  scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/yelloweye-index-by-area-sim.png", width = 7, height = 4, dpi = 400)
```

## Plot estimated halibut catch per 100 hooks through time

Average predicted catch within the entire court defined area is in red, remainder of southern stock area is in black.

```{r message = F, echo= F}
.dat <- bind_rows(
  mutate(i_ye_noncda,
    Area = "non-CDA 3CD",
    est = est / nrow(noncda_grid),
    lwr = lwr / nrow(noncda_grid),
    upr = upr / nrow(noncda_grid)
  ),
  mutate(i_ye_cda,
    Area = "CDA",
    est = est / nrow(cda_grid),
    lwr = lwr / nrow(cda_grid),
    upr = upr / nrow(cda_grid)
  ),
)
ggplot(.dat, aes(year, est)) +
  geom_line(aes(colour = Area)) +
  geom_ribbon(aes(
    ymin = lwr,
    ymax = upr, fill = Area
  ), alpha = 0.4) +
  xlab("Year") +
  ylab("Average estimated catch per 100 hooks") +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/yelloweye-average-index-by-area-sim.png", width = 7, height = 4, dpi = 400)
```


# Calculate predicted catch rates in different areas

```{r }
i_hal_cda2 <- readRDS("data-generated/halibut-index-cda-sim-500.rds")[[2]]
i_hal_noncda2 <- readRDS("data-generated/halibut-index-3CD-outside-cda-sim-500.rds")[[2]]
i_hal_5A2 <- readRDS("data-generated/halibut-index-5A-sim-500.rds")[[2]]
i_hal2 <- readRDS("data-generated/halibut-index-all-S-sim-500.rds")[[2]]

.dat2 <- bind_rows(
  mutate(i_hal2, Area = "HBLL South", num_cells = nrow(full_s_grid)),
  mutate(i_hal_5A2, Area = "5A", num_cells = nrow(s_5A_grid)),
  mutate(i_hal_noncda2, Area = "non-CDA 3CD", num_cells = nrow(noncda_grid)),
  mutate(i_hal_cda2, Area = "CDA", num_cells = nrow(cda_grid))
)
.dat2$Area <- ordered(.dat2$Area, levels = c("CDA", "non-CDA 3CD", "5A", "HBLL South"))

i_hal_2020 <- filter(.dat2, year == 2020)

catch_per_cell <- i_hal_2020 %>%
  group_by(Area) %>%
  summarise(
    catch = mean(.value / num_cells),
    catch_lwr = quantile(.value / num_cells, 0.025),
    catch_upr = quantile(.value / num_cells, 0.975)
  )
```

```{r }
i_ye_cda2 <- readRDS("data-generated/yelloweye-spatial-index-cda-sim-500.rds")[[2]]
i_ye_noncda2 <- readRDS("data-generated/yelloweye-spatial-index-3CD-outside-cda-sim-500.rds")[[2]]
i_ye_5A2 <- readRDS("data-generated/yelloweye-spatial-index-5A-sim-500.rds")[[2]]
i_ye2 <- readRDS("data-generated/yelloweye-spatial-index-all-S-sim-500.rds")[[2]]

.dat3 <- bind_rows(
  mutate(i_ye2, Area = "HBLL South", num_cells = nrow(full_s_grid)),
  mutate(i_ye_5A2, Area = "5A", num_cells = nrow(s_5A_grid)),
  mutate(i_ye_noncda2, Area = "non-CDA 3CD", num_cells = nrow(noncda_grid)),
  mutate(i_ye_cda2, Area = "CDA", num_cells = nrow(cda_grid))
)
.dat3$Area <- ordered(.dat3$Area, levels = c("CDA", "non-CDA 3CD", "5A", "HBLL South"))

i_ye_2020 <- filter(.dat3, year == 2020)

ye_catch_per_cell <- i_ye_2020 %>%
  group_by(Area) %>%
  summarise(
    catch = mean(.value / num_cells),
    catch_lwr = quantile(.value / num_cells, 0.025),
    catch_upr = quantile(.value / num_cells, 0.975)
  )
```

```{r message=F, echo=F}
ggplot(i_hal_2020) + geom_histogram(aes(.value / num_cells ), alpha = 0.75, fill = "black") +
  geom_histogram(data = i_ye_2020, aes(.value / num_cells , fill = Area), alpha = 0.75) +
  geom_vline(data = catch_per_cell, aes(xintercept = catch ), linetype = 2, alpha = 0.5, colour = "black") +
  geom_vline(data = ye_catch_per_cell, aes(xintercept = catch , colour = Area), linetype = 2) +
  facet_grid(rows = vars(Area)) + xlab("Mean catch per 100 hooks") + ylab("Number of simulations") +
  scale_fill_brewer(palette = "Set1") + scale_colour_brewer(palette = "Set1") + theme(legend.position = "none") +
  ggtitle("Estimated catch rates (mean and distribution)",
    subtitle = "Yelloweye Rockfish (coloured bars) vs. Pacific Halibut (grey bars)"
  )

ggsave("figs/all-estimated-catch-rates-sim.png", width = 5, height = 5, dpi = 400)
```
Converting to biomass separates distributions
```{r message=F, echo=F}
ggplot(i_hal_2020) + geom_histogram(aes(.value / num_cells * halmeanweight), alpha = 0.75, fill = "black") +
  geom_histogram(data = i_ye_2020, aes(.value / num_cells * yemeanweight, fill = Area), alpha = 0.75) +
  geom_vline(data = catch_per_cell, aes(xintercept = catch * halmeanweight), linetype = 2, alpha = 0.5, colour = "black") +
  geom_vline(data = ye_catch_per_cell, aes(xintercept = catch * yemeanweight, colour = Area), linetype = 2) +
  facet_grid(rows = vars(Area)) + xlab("Mean biomass per 100 hooks") + ylab("Number of simulations") +
  scale_fill_brewer(palette = "Set1") + scale_colour_brewer(palette = "Set1") + theme(legend.position = "none") +
  ggtitle("Estimated biomass catch rates (mean and distribution)",
    subtitle = "Yelloweye Rockfish (coloured bars) vs. Pacific Halibut (grey bars)"
  )

ggsave("figs/all-estimated-biomass-catch-rates-sim.png", width = 5, height = 5, dpi = 400)
```


# What proportion of estimated total catch is inside CDA in 2020?

```{r echo=F}
print("What proportion of grid is inside CDA?")
round(nrow(cda_grid) / (nrow(cda_grid) + nrow(noncda_grid)), 2)
```

```{r message=F, echo=F}
hal_ratios <- i_hal_2020 %>%
  select(-num_cells) %>%
  pivot_wider(names_from = Area, values_from = .value) %>%
  group_by(.iteration) %>%
  mutate(CDAto3CD = CDA / (CDA + `non-CDA 3CD`), CDAto3CD5A = CDA / (CDA + `non-CDA 3CD` + `5A`))

mean_hal_ratios <- hal_ratios %>%
  pivot_longer(cols = c(CDAto3CD, CDAto3CD5A), names_to = "area", values_to = "ratio") %>%
  group_by(area) %>%
  summarise(
    ratio = mean(ratio),
    ratio_lwr = quantile(ratio, 0.025),
    ratio_upr = quantile(ratio, 0.975)
  )

ggplot(hal_ratios) +
  geom_histogram(aes(CDAto3CD), fill = "red", alpha = 0.75) +
  geom_histogram(aes(CDAto3CD5A), fill = "black", alpha = 0.5) +
  geom_vline(data = mean_hal_ratios, aes(xintercept = ratio), linetype = 2) +
  xlim(0, max(hal_ratios$CDAto3CD)) +
  xlab("Proportion of total catch inside CDA") + ylab("Number of simulations") +
  ggtitle("Pacific Halibut catch for HBLL grid cells in area 3CD (red) and 3CD + 5A (grey)")
ggsave("figs/halibut-relative-catch-sim.png", width = 7, height = 3, dpi = 400)
```

```{r message=F, echo=F}
ye_ratios <- i_ye_2020 %>%
  select(-num_cells) %>%
  pivot_wider(names_from = Area, values_from = .value) %>%
  group_by(.iteration) %>%
  mutate(CDAto3CD = CDA / (CDA + `non-CDA 3CD`), CDAto3CD5A = CDA / (CDA + `non-CDA 3CD` + `5A`))

mean_ye_ratios <- ye_ratios %>%
  pivot_longer(cols = c(CDAto3CD, CDAto3CD5A), names_to = "area", values_to = "ratio") %>%
  group_by(area) %>%
  summarise(
    ratio = mean(ratio),
    ratio_lwr = quantile(ratio, 0.025),
    ratio_upr = quantile(ratio, 0.975)
  )

ggplot(ye_ratios) +
  geom_histogram(aes(CDAto3CD), fill = "red", alpha = 0.75) +
  geom_histogram(aes(CDAto3CD5A), fill = "black", alpha = 0.5) +
  geom_vline(data = mean_ye_ratios, aes(xintercept = ratio), linetype = 2) +
  xlim(0, max(hal_ratios$CDAto3CD)) +
  xlab("Proportion of total catch inside CDA") + ylab("Number of simulations") +
  ggtitle("Yelloweye Rockfish catch for HBLL grid cells in area 3CD (red) and 3CD + 5A (grey)")
ggsave("figs/yelloweye-relative-catch-sim.png", width = 7, height = 3, dpi = 400)
```


### Plot ratio of yelloweye to halibut through time

Counts
```{r message=F, echo=F}
.i_ye <- bind_rows(
  mutate(i_ye2, Area = "HBLL South", num_cells = nrow(full_s_grid)),
  mutate(i_ye_5A2, Area = "5A", num_cells = nrow(s_5A_grid)),
  mutate(i_ye_noncda2, Area = "non-CDA 3CD", num_cells = nrow(noncda_grid)),
  mutate(i_ye_cda2, Area = "CDA", num_cells = nrow(cda_grid))
) %>% rename(yelloweye = .value)
.i_ye$Area <- ordered(.i_ye$Area, levels = c("CDA", "non-CDA 3CD", "5A", "HBLL South"))

.i_hal <- bind_rows(
  mutate(i_hal2, Area = "HBLL South", num_cells = nrow(full_s_grid)),
  mutate(i_hal_5A2, Area = "5A", num_cells = nrow(s_5A_grid)),
  mutate(i_hal_noncda2, Area = "non-CDA 3CD", num_cells = nrow(noncda_grid)),
  mutate(i_hal_cda2, Area = "CDA", num_cells = nrow(cda_grid))
) %>% rename(halibut = .value)
.i_hal$Area <- ordered(.i_hal$Area, levels = c("CDA", "non-CDA 3CD", "5A", "HBLL South"))

.dat <- left_join(.i_ye, .i_hal) %>%
  group_by(Area, year) %>%
  summarise(
    ye_per_hal = mean(yelloweye / halibut ),
    lwr = quantile(yelloweye / halibut, 0.025),
    upr = quantile(yelloweye / halibut, 0.975)
  ) %>%
  filter(Area %in% c("non-CDA 3CD", "CDA"))

ggplot(.dat, aes(year, ye_per_hal, fill = Area, colour = Area)) +
  geom_line() +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.4, colour = NA) +
  xlab("Year") +
  ylab("Estimated yelloweye caught per halibut") +
  coord_cartesian(expand = FALSE, ylim = c(0, max(.dat$upr) * 1.04)) +
  scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/ye-per-hal-index-by-area.png", width = 7, height = 4, dpi = 400)
```

```{r message=F, echo=F}
.i_ye <- bind_rows(
  mutate(i_ye2, Area = "HBLL South", num_cells = nrow(full_s_grid)),
  mutate(i_ye_5A2, Area = "5A", num_cells = nrow(s_5A_grid)),
  mutate(i_ye_noncda2, Area = "non-CDA 3CD", num_cells = nrow(noncda_grid)),
  mutate(i_ye_cda2, Area = "CDA", num_cells = nrow(cda_grid))
) %>% rename(yelloweye = .value)
.i_ye$Area <- ordered(.i_ye$Area, levels = c("CDA", "non-CDA 3CD", "5A", "HBLL South"))

.i_hal <- bind_rows(
  mutate(i_hal2, Area = "HBLL South", num_cells = nrow(full_s_grid)),
  mutate(i_hal_5A2, Area = "5A", num_cells = nrow(s_5A_grid)),
  mutate(i_hal_noncda2, Area = "non-CDA 3CD", num_cells = nrow(noncda_grid)),
  mutate(i_hal_cda2, Area = "CDA", num_cells = nrow(cda_grid))
) %>% rename(halibut = .value)
.i_hal$Area <- ordered(.i_hal$Area, levels = c("CDA", "non-CDA 3CD", "5A", "HBLL South"))

.dat <- left_join(.i_ye, .i_hal) %>%
  group_by(Area, year) %>%
  summarise(
    ye_to_hal = mean((yelloweye * yemeanweight)/ (halibut * halmeanweight)),
    lwr2 = quantile((yelloweye * yemeanweight)/ (halibut * halmeanweight), 0.025),
    upr2 = quantile((yelloweye * yemeanweight)/ (halibut * halmeanweight), 0.975)
  ) %>%
  filter(Area %in% c("non-CDA 3CD", "CDA"))

ggplot(.dat, aes(year, ye_to_hal, fill = Area, colour = Area)) +
  geom_line() +
  geom_ribbon(aes(ymin = lwr2, ymax = upr2), alpha = 0.4, colour = NA) +
  xlab("Year") +
  ylab("Estimated yelloweye to halibut biomass ratio") +
  coord_cartesian(expand = FALSE, ylim = c(0, max(.dat$upr2) * 1.04)) +
  scale_x_continuous(breaks = seq(1950, 2050, 2)) +
  theme(plot.margin = margin(11 / 2, r = 11, 11 / 2, 11 / 2)) +
  scale_fill_brewer(palette = "Set1") +
  scale_colour_brewer(palette = "Set1")
ggsave("figs/ye-to-hal-biomass-index-by-area.png", width = 7, height = 4, dpi = 400)
```


# Maps

Predictions depicted for HBLL survey grid area that falls within region 3CD. "Court defined area" area is outlined in red. Only 2020 survey catch is included on first two maps, all years of halibut catch are included on the map showing number of Yelloweye Rockfish expected per halibut caught 2020. 

```{r message=F, echo=F}
p_hal <- readRDS("data-generated/halibut-predictions-all-S.rds")
g <- map_predictions(
  pred_data = filter(p_hal$data, year == 2020),
  obs_data = filter(d_hal, year == 2020),
  size_aes = (catch_count / hook_count) * 100
)
g
dir.create("figs", showWarnings = FALSE)
ggsave("figs/halibut-2020-predictions-S.png", width = 5.5, height = 6, dpi = 400)
```

```{r map-predictions-all, message=F, echo=F, cache=TRUE}
g <- map_predictions(
  pred_data = p_hal$data,
  obs_data = d_hal,
  size_aes = (catch_count / hook_count) * 100,
  legend_position = "right"
) + facet_wrap(~year)

g <- g + theme(legend.position = c(0.35, 0), legend.justification = c(0, 0))

ggsave("figs/halibut-predictions-S.png", width = 9, height = 10, dpi = 200)
```

```{r message=F, echo=F}
p_ye <- readRDS("data-generated/yelloweye-spatial-predictions-all-S.rds")

g <- map_predictions(
  pred_data = filter(p_ye$data, year == 2020),
  obs_data = filter(d_ye, year == 2020),
  size_aes = (catch_count / hook_count) * 100
)
g
dir.create("figs", showWarnings = FALSE)
ggsave("figs/yelloweye-2020-predictions-S.png", width = 5.5, height = 6, dpi = 400)
```


```{r message=F, echo=F}
# calculate ratio of yelloweye to halibut
p_ye <- readRDS("data-generated/yelloweye-spatial-predictions-all-S.rds")
p_hal <- readRDS("data-generated/halibut-predictions-all-S.rds")
pyd <- p_ye$data %>% rename(ye_est = est)
phd <- p_hal$data %>%
  rename(hal_est = est) %>%
  select(hal_est, X, Y, year)

ratio_df <- left_join(pyd, phd) %>% mutate(halibut = exp(hal_est), yelloweye = exp(ye_est), ye_per_hal = yelloweye / halibut)
ratio_2020 <- filter(ratio_df, year == 2020)

g <- map_predictions(
  pred_data = ratio_2020,
  obs_data = filter(d_hal, year == 2020),
  fill_aes = ye_per_hal,
  fill_lab = "Predicted\nYelloweye\nper Halibut",
  size_aes = (catch_count / hook_count) * 100,
  size_lab = "Halibut caught\nper 100 hooks"
)
g

dir.create("figs", showWarnings = FALSE)
ggsave("figs/ye-per-halibut-2020-w-hal-catch-S.png", width = 5.5, height = 6, dpi = 400)
```



```{r message=F, echo=F}
# calculate ratio of yelloweye to halibut
p_ye <- readRDS("data-generated/yelloweye-spatial-predictions-all-S.rds")
p_hal <- readRDS("data-generated/halibut-predictions-all-S.rds")
pyd <- p_ye$data %>% rename(ye_est = est )
phd <- p_hal$data %>%
  rename(hal_est = est ) %>%
  select(hal_est, X, Y, year)

ratio_df <- left_join(pyd, phd) %>% mutate(
  halibut = exp(hal_est) * halmeanweight, 
  yelloweye = exp(ye_est)* yemeanweight, 
  ye_to_hal = yelloweye / halibut)
ratio_2020 <- filter(ratio_df, year == 2020)

g <- map_predictions(
  pred_data = ratio_2020,
  obs_data = filter(d_hal, year == 2020),
  fill_aes = ye_to_hal,
  fill_lab = "Predicted\nYelloweye:Halibut\nbiomass ratio",
  size_aes = (catch_count / hook_count) * 100,
  size_lab = "Halibut caught\nper 100 hooks"
)
g

dir.create("figs", showWarnings = FALSE)
ggsave("figs/ye-to-halibut-2020-w-hal-catch-S.png", width = 5.5, height = 6, dpi = 400)
```

Raw data

```{r ye-map-all, cache=TRUE, echo=F, message=F}
g <- map_predictions(
  pred_data = p_ye$data,
  obs_data = d_ye,
  size_aes = (catch_count / hook_count) * 100,
  legend_position = "right"
) + facet_wrap(~year)
g <- g + theme(legend.position = c(0.35, 0), legend.justification = c(0, 0))
ggsave("figs/ye-predictions-S.png", width = 9, height = 10, dpi = 200)
```

# Other exploratory plots
```{r message=F, echo=F}
p_hal_cda <- readRDS("data-generated/halibut-predictions-cda.rds")
p_hal_noncda <- readRDS("data-generated/halibut-predictions-3CD-outside-cda.rds")
p_ye_cda <- readRDS("data-generated/yelloweye-spatial-predictions-cda.rds")
p_ye_noncda <- readRDS("data-generated/yelloweye-spatial-predictions-3CD-outside-cda.rds")
py_cda <- p_ye_cda$data %>% rename(ye_est = est)
py_noncda <- p_ye_noncda$data %>% rename(ye_est = est)
ph_cda <- p_hal_cda$data %>%
  rename(hal_est = est) %>%
  select(hal_est, X, Y, year)
ph_noncda <- p_hal_noncda$data %>%
  rename(hal_est = est) %>%
  select(hal_est, X, Y, year)


ratio_cda <- left_join(py_cda, ph_cda) %>% mutate(
  halibut = exp(hal_est), yelloweye = exp(ye_est),
  ye_per_hal = yelloweye / halibut, hal_per_ye = halibut / yelloweye
)
ratio_noncda <- left_join(py_noncda, ph_noncda) %>% mutate(
  halibut = exp(hal_est), yelloweye = exp(ye_est),
  ye_per_hal = yelloweye / halibut, hal_per_ye = halibut / yelloweye
)

ratio_cda <- ratio_cda[order(ratio_cda$halibut, decreasing = T), ] %>% mutate(ordered = row_number())
ratio_noncda <- ratio_noncda[order(ratio_noncda$halibut, decreasing = T), ] %>% mutate(ordered = row_number())

# ggplot(ratio_noncda) +
#   geom_point(aes(yelloweye, halibut), alpha = 0.5) +
#   geom_point(data = ratio_cda, aes(yelloweye, halibut),
#     inherit.aes = F, colour = "red", alpha = 0.5) +
#   coord_cartesian(expand = F) +
#   ylab("Halibut per per 100 hooks") +
#   xlab("Yelloweye per per 100 hooks")

ggplot(ratio_noncda) +
  geom_point(aes(halibut, yelloweye), alpha = 0.5) +
  geom_point(
    data = ratio_cda, aes(halibut, yelloweye),
    inherit.aes = F, colour = "red", alpha = 0.5
  ) +
  coord_cartesian(expand = F) +
  xlab("Halibut per per 100 hooks") +
  ylab("Yelloweye per per 100 hooks")

# ggplot(filter(ratio_noncda, halibut > 5)) +
#   geom_histogram(aes(ye_per_hal)) +
#   geom_histogram(data = filter(ratio_cda, halibut > 5),aes(ye_per_hal), inherit.aes = F, fill = "red") +
#   ylab("Grid cell with estimate of > 5 halibut per 100 hooks") +
#   xlab("Predicted numder of yelloweye per halibut caught")

ggplot(filter(
  ratio_noncda, halibut > 5 # & yelloweye > 0.1
)) +
  geom_histogram(aes(hal_per_ye)) +
  geom_histogram(data = filter(
    ratio_cda, halibut > 5 # & yelloweye > 0.1
  ), aes(hal_per_ye), inherit.aes = F, fill = "red") +
  ylab("Cells with > 5 halibut per 100 hooks") +
  xlab("Estimated numder of halibut per yelloweye caught")
```

### Experiment with accumulation curve
Solid lines are cumulative halibut catch potential for each addition cell fished in decreasing order of predicted halibut abundance.
Dashed lines are the cumulative yelloweye catch that might be anticipated for those same cells.
```{r message=F, echo=F}
ggplot(
  data = ratio_cda,
  aes(x = ordered)
) +
  geom_line(data = ratio_noncda, aes(x = ordered, y = cumsum((halibut))), inherit.aes = FALSE) +
  geom_line(data = ratio_cda, aes(x = ordered, y = cumsum((halibut))), colour = "red", inherit.aes = FALSE) +
  geom_line(data = ratio_noncda, aes(x = ordered, y = cumsum((yelloweye))), lty = 2, inherit.aes = FALSE) +
  geom_line(data = ratio_cda, aes(x = ordered, y = cumsum((yelloweye))), lty = 2, colour = "red", inherit.aes = FALSE) +
  coord_cartesian(expand = F, xlim = c(0, 2500), ylim = c(0, 9000)) +
  ylab("Fish caught") +
  xlab("Number of cells fished (in order of decreasing Halibut abundance)")
```


# Investigate weights of yelloweye caught

### Is there an overall trend in fish size through time?

```{r message=F, echo=F}
# load biological sample data
yesampledata <- readRDS("data/yelloweye-surv-samples-all.rds") %>% filter(survey_abbrev == "HBLL OUT S")

# calculate mean weights for all of HBLL S
yemeanweights <- yesampledata %>%
  filter(!is.na(weight)) %>%
  group_by(year) %>%
  summarise(
    mean_weight = mean(weight / 1000, na.rm = T),
    upr_ci = Rmisc::CI(weight / 1000, ci = 0.95)[1], lwr_ci = Rmisc::CI(weight / 1000, ci = 0.95)[3],
    upr_weight = quantile(weight / 1000, 0.975), lwr_weight = quantile(weight / 1000, 0.025),
    n = n()
  )

# plot mean weights through time for whole HBLL
ggplot(yemeanweights) + geom_path(aes(year, mean_weight)) + ylim(0, 6) +
  geom_ribbon(aes(year, mean_weight, ymax = upr_weight, ymin = lwr_weight), alpha = 0.2) +
  geom_linerange(aes(year, ymax = upr_ci, ymin = lwr_ci), size = 1) +
  ylab("Individual Fish Weights (kg)") + xlab("Year") +
  ggtitle("Mean and 95th percentile range for Yelloweye Rockfish caught on HBLL S")
ggsave("annual_yelloweye_weights.png", width = 4, height = 4)
```


### Does the annual distribution of fish weights differ within the CDA?

```{r message=F, echo=F}
# get the fishing events that occurred within CDA
d_ye_sf <- st_as_sf(d_ye, coords = c("longitude", "latitude"))
st_crs(d_ye_sf) <- 4326 # set the coordinate reference system
d_ye_intersected <- sf::st_intersects(d_ye_sf, focal_area)
cda_ye_sf <- d_ye_sf[which(lengths(d_ye_intersected) > 0), ]
noncda_ye_sf <- d_ye_sf[which(lengths(d_ye_intersected) == 0), ]

cda_ye_ids <- cda_ye_sf
st_geometry(cda_ye_ids) <- NULL
cda_ye_ids <- cda_ye_ids %>%
  select(fishing_event_id, year, catch_count) %>%
  distinct() # keep catch count for comparison with sample totals

# make dataframe of just samples from the CDA and calculate tallies of events, total catch, sampled weights and total catch/events
cda_ye_samples <- inner_join(cda_ye_ids, yesampledata) %>%
  group_by(year) %>%
  mutate(cda_weights = n())
cda_ye_catch <- cda_ye_ids %>%
  group_by(year) %>%
  summarise(cda_catch = sum(catch_count))
cda_ye_sample_sum <- cda_ye_samples %>%
  select(year, cda_weights) %>%
  distinct()
cda_events <- cda_ye_ids %>%
  group_by(year) %>%
  summarise(cda_events = n())
cda_sampling <- left_join(cda_events, cda_ye_catch) %>%
  left_join(cda_ye_sample_sum) %>%
  mutate(catch_rate = round(cda_catch / cda_events, 1))

# plot CDA weights against overall distribution for HBLL S
ggplot(yesampledata) +
  geom_violin(aes(as.factor(year), weight / 1000), alpha = 0.2, scale = "count", colour = "black", fill = "grey") +
  # geom_violin(data = cda_ye_samples, aes(as.factor(year), weight/1000), alpha = 0.9, scale = "count", colour = "red", fill = "red", adjust = 1/5) +
  geom_point(data = cda_ye_samples, aes(as.factor(year), weight / 1000), alpha = 0.7, colour = "red", fill = "red") +
  geom_linerange(data = yemeanweights, aes(as.factor(year), ymax = upr_ci, ymin = lwr_ci), size = 5) +
  ylab("Individual Fish Weights (kg)") + xlab("") +
  ggtitle("Annual distributions of Yelloweye Rockfish weights (all HBLL S = black; within CDA = red)")
ggsave("yelloweye_weights.png", width = 5, height = 3.5)
```



### How spatially variable are mean weigths through time for whole HBLL S?
```{r message=F, echo=F, warning=F}
# calculate the mean weights from each fishing event
yeeventweights <- yesampledata %>%
  filter(!is.na(weight)) %>%
  group_by(year, fishing_event_id) %>%
  summarise(
    mean_weight = mean(weight / 1000, na.rm = T),
    upr_ci = Rmisc::CI(weight / 1000, ci = 0.95)[1], lwr_ci = Rmisc::CI(weight / 1000, ci = 0.95)[3],
    upr_weight = quantile(weight / 1000, 0.975), lwr_weight = quantile(weight / 1000, 0.025),
    n = n()
  ) %>%
  filter(n > 10) # filter for fishing events with at least 10 fish measured

ggplot(yeeventweights) +
  geom_violin(aes(as.factor(year), mean_weight), alpha = 0.2, scale = "count", colour = "black", fill = "grey") +
  geom_linerange(data = yemeanweights, aes(as.factor(year), ymax = upr_ci, ymin = lwr_ci), size = 3) +
  ylab("Mean Weight (kg)") + xlab("") +
  ggtitle("Annual mean and variability in Yelloweye Rockfish weights", subtitle = "for events with > 10 fish sampled")
ggsave("yelloweye_event_weights.png", width = 6, height = 4.5)
```


```{r message=F, echo=F, warning=F}
yeeventweights1 <- yesampledata %>%
  filter(!is.na(weight)) %>%
  group_by(year, fishing_event_id) %>%
  summarise(
    mean_weight = mean(weight / 1000, na.rm = T),
    med_weight = median(weight / 1000, na.rm = T),
    upr_ci = Rmisc::CI(weight / 1000, ci = 0.95)[1], lwr_ci = Rmisc::CI(weight / 1000, ci = 0.95)[3],
    upr_weight = quantile(weight / 1000, 0.975), lwr_weight = quantile(weight / 1000, 0.025),
    n = n()
  ) %>%
  filter(n > 1)

ggplot(yeeventweights1) +
  geom_col(aes(med_weight, n), size = 2, colour = "grey") +
  # geom_linerange(data = yemeanweights, aes(as.factor(year), ymax = upr_ci, ymin = lwr_ci), size = 3) +
  ylab("Number of fish sampled") + xlab("Median weight of fish sampled (kg)") +
  # facet_wrap(~year) +
  ggtitle("")

ggplot(yeeventweights1) +
  geom_col(aes(mean_weight, n), size = 2, colour = "grey") +
  # geom_linerange(data = yemeanweights, aes(as.factor(year), ymax = upr_ci, ymin = lwr_ci), size = 3) +
  ylab("Number of fish sampled") + xlab("Mean weight of fish sampled (kg)") +
  # facet_wrap(~year) +
  ggtitle("")
```
